<!DOCTYPE html>
<html>
<head>
    <title class=appname>proeForth</title>
    <meta charset="utf-8" />
    <style id=styleTextareaFocus type="text/css">
            textarea:focus {
                background:#E0E0E0;
            }

            div {
                color:black;
                font-family: courier new;
                /* font-size: 40px; */
                /* padding:20px; */
                word-wrap:break-word;
                border: 0px solid white;
                background:#F0F0F0;
            }
            
    </style>
    <script type="text/javascript" src="https://ajax.microsoft.com/ajax/jQuery/jquery-1.11.2.js"></script>  
    <Script>

// 
// project-k Forth kernel 
// Use the same kernel code for all applications.
// FigTaiwan H.C. Chen hcchen5600@gmail.com
//

"uses strict";
function jeForth() {     
	var vm = this;
	vm.major_version = 3; // major version, projectk.js kernel version.
	var ip=0;
	var stack = [] ;
	var rstack = [];
	var vocs = [];
	var words = [];
	var current = "forth";
	var context = "forth";
	var order = [context];
	var wordhash = {};
	var dictionary=[]; dictionary[0]=0;
	var here=1;
	var tib="";
	var ntib=0;
	var RET=null; // The 'ret' instruction code. It marks the end of a colon word.
	var EXIT=""; // The 'exit' instruction code.
	var compiling=false;
	var stop = false; // Stop the outer loop
	var newname = ""; // new word's name
	var newxt = function(){}; // new word's function()
	var newhelp = "";
	
	// Call out vm.type()
	// Kernel has no idea of typing, it does not need to 'type'. This is for 
	// the convenience of programs in code ... end-code that always need to 
	// print something.
	function type(s) {
		// defined in project-k kernel projectk.js
		if(vm.type) vm.type(s);
	}
	
	// Reset the forth VM
	function reset(){
		// defined in project-k kernel projectk.js
		rstack = [];
		compiling=false;
		ip=0; // forth VM instruction pointer
		stop = true; 
		ntib = tib.length; // don't clear tib, a clue for debug.
		// stack = []; I guess it's a clue for debug
	}

	// panic() calls out to vm.panic()
	// The panic() function gets only message and severity level. 
	// Kernel has no idea how to handle these information so it checks if vm.panic() exists
	// and pass the {msg,serious}, or even more info, over that's all. That's why vm.panic() has to
	// receive a hash structure, because it must be.
	function panic(msg,serious) {
		// defined in project-k kernel projectk.js
		var state = {
				msg:msg, serious:serious
				// , compiling:compiling, 
				// stack:stack.slice(0), rstack:rstack.slice(0), 
				// ip:ip, tib:tib, ntib:ntib, stop:stop
			};
		if(vm.panic) vm.panic(state);
	}

	// Forth words are instances of Word() constructor.
	function Word(a) {
		this.name = a.shift();  // name and xt are mandatory
		this.xt = a.shift();
		var statement;
		while(statement=a.shift()) {  // extra arguments are statement strings
			eval(statement);
		}
	}
	Word.prototype.toString = function(){return this.name + " " + this.help}; // every word introduces itself
	
	// Support Vocabulary
	function last(){  // returns the last defined word.
		return words[current][words[current].length-1];
	}
	function current_word_list(){  // returns the word-list where new defined words are going to
		return words[current];
	}
	function context_word_list(){  // returns the word-list that is searched first.
		return words[context];
	}

	// Get string from recent ntib down to, but not including, the next delimiter.
	// Return {str:"string", flag:boolean}
	// If delimiter is not found then return the entire remaining TIB, multi-lines, through result.str。
	// result.flag indicates delimiter found or not found.
	// o  If you want to read the entire line in TIB, use nexttoken('\n|\r'). 
	//    nexttoken() skip the next character which is usually white space in Forth source code, 
	//    e.g. s", this is reasonable because it's Forth. While the leading white space(s) 
	//    will be included if useing the lower level nextstring('\\s') instead of nexttoken().
	// o  If you need to know whether the delimiter is found, use nextstring()。
	// o  result.str is "" if TIB has nothing left.
	// o  The ending delimiter is remained. 
	// o  The delimiter is a regular expression.
	function nextstring(deli){
		var result={}, index;
		index = (tib.substr(ntib)).search(deli);  // search for delimiter in tib from ntib
		if (index!=-1) {   // delimiter found
			result.str = tib.substr(ntib,index);  // found, index is the length
			result.flag = true;
			ntib += index;  // Now ntib points at the delimiter.
		} else { // delimiter not found.
			result.str = tib.substr(ntib);  // get the tib from ntib to EOL
			result.flag = false;
			ntib = tib.length; // skip to EOL
		}
		return result;
	}
	
	// Get next token which is found after the recent ntib of TIB.
	// If delimiter is RegEx white-space ('\\s') or absent then skip all leading white spaces first.
	// Usual case, skip the next character which should be a white space for Forth.
	// But if delimiter is CRLF, which is to read the entire line, for blank lines the ending CRLF won't be skipped.
	// o  Return "" if TIB has nothing left. 
	// o  Return the remaining TIB if delimiter is not found.
	// o  The ending delimiter is remained. 
	// o  The delimiter is a regular expression.
	function nexttoken(deli){
		if (arguments.length==0) deli='\\s';   // white space
		switch(deli){
			case '\\s': skipWhiteSpaces(); break; // skip all leading white spaces
			case '\\n': case '\n': if (tib[ntib]!='\n') ntib += 1; break;
			case '\\r': case '\r': if (tib[ntib]!='\r') ntib += 1; break; 
			case '\\n|\\r': case '\n|\r': case '\\r|\\n': case '\r|\n': 
				if (tib[ntib]!='\n' && tib[ntib]!='\r') ntib += 1; break; 
			default: ntib += 1; // skip next character
		}
		var token = nextstring(deli).str;
		return token; 
		function skipWhiteSpaces(){  // skip all white spaces at tib[ntib]
			var index = (tib.substr(ntib)).search('\\S'); // Skip leading whitespaces. index points to next none-whitespace.
			if (index == -1) {  // \S not found, entire line are all white spaces or totally empty
				ntib = tib.length;
			}else{
				ntib += index ; // skip leading whitespaces
			}
		}
	}
	
	// tick() is same thing as forth word '。 
	// Let words[voc][0]=0 also means tick() return 0 indicates "not found".
	// Return the word obj of the given name or 0 if the word is not found.
	// May be redefined for selftest to detect private words referenced by name. 
	// vm.tick keeps the original version.
	function tick(name) {
		// defined in project-k projectk.js 
		return wordhash[name] || 0;  // 0 means 'not found'
	}
	
	// Return a boolean.
	// Is the new word reDef depends on only the words[current] word-list, not all 
	// word-lists, nor the word-hash table. Can't use tick() because tick() searches 
	// the word-hash that includes not only the words[current] word-list.
	function isReDef(name){
		var result = false;
		var wordlist = current_word_list();
		for (var i in wordlist)
			if (wordlist[i].name == name) {
				result = true;
				break;
			}
		return result;
	}
	
	// comma(x) compiles anything into dictionary[here]. x can be number, string, 
	// function, object, array .. etc。
	// To compile a word, comma(tick('word-name'))
	function comma(x) {
		dictionary[here++] = x;
		dictionary[here] = RET;  // dummy
		// [here] will be overwritten, we do this dummy because 
		// RET is the ending mark for 'see' to know where to stop. 
	}
	
	// Discussions:

	// 'address' or 'ip' are index of dictionary[] array. dictionary[] is the memory of the
	// Forth virtual machine.
	
	// execute() executes a function, a word "name", and a word Object.  

	// inner(entry) jumps into the entry address. The TOS of return stack can be 0, in that
	// case the control will return back to JavaScript host, or the return address.

	// inner() used in outer(), and colon word's xt() while execute() is used everywhere.
	
	// We have 3 ways to call forth words from JavaScript: 1. execute('word'), 
	// 2. dictate('word word word'), and 3. inner(cfa). 

	// dictate() cycles are stand alone tasks. We can suspend an in-completed dictate() and we
	// can also run another dictate() within a dictate().

	// The ultimate inner loop is like this: while(w){ip++; w.xt(); w=dictionary[ip]}; 
	// Boolean(w) == false is the break condition. So I choose null to be the RET instruction
	// and the empty string "" to be the EXIT instruction. Choices are null, "", false, NaN, 
	// undefined, and 0. Total 6 of them. 0 has another meaning explained below.

	// To suspend the Forth virtual machine means to stop inner loop but not pop the 
	// return stack, resume is possible because return stack remained. We need an instruction 
	// to do this and it's 0. dictionary[0] and words[<vid>][0] are always 0 thus ip=w=0 
	// indicates that case. Calling inner loop from outer loop needs to push(0) first so 
	// as to balance the return stack also letting the 0 instruction to stop popping the
	// return stack because there's no more return address, it's outer interpreter remember? 
	
	// -------------------- ###### The inner loop ###### -------------------------------------

	// Translate all possible entry or input to the suitable word type.
	function phaseA (entry) { 
		var w = 0; 
		switch(typeof(entry)){
			case "string": // "string" is word name
				w = vm.tick(entry.replace(/(^( |\t)*)|(( |\t)*$)/mg,'')); // remove leading and tailing white spaces
				break;
			case "function": case "object": // object is a word
				w = entry; 
				break;
			case "number": 
				// number could be dictionary entry or 0. 
				// could be does> branch entry or popped from return stack by RET or EXIT instruction.
				ip = entry;
				w = dictionary[ip]; 
				break;
			default :
				panic("Error! execute() doesn't know how to handle this thing : "+entry+" ("+mytypeof(entry)+")\n","err");
		}
		return w;
	}

	// Execute the given w by the correct method 
	function phaseB (w) { 
		switch(typeof(w)){
			case "number":  
				// Usually a number is the entry of does>. Can't use inner() to call it 
				// The below push-jump mimics the call instruction of a CPU.
				rstack.push(ip); // Forth ip is the "next" instruction to be executed.
				ip = w; // jump , 
				break;
			case "function": 
				w();
				break;
			case "object": // Word object
				try { // take care of JavaScript errors to avoid being kicked out very easily
					w.xt(w);
				} catch(err) {
					panic('JavaScript error on word "'+w.name+'" : '+err.message+'\n',"error");
				}
				break;
			default :
				panic("Error! don't know how to execute : "+w+" ("+mytypeof(w)+")\n","error");
		}
	}

	// execute("unknown") == do nothing, this is beneficial when executing a future word
	// May be redefined for selftest to detect private words called by name.
	// vm.execute keeps the original version.
	function execute(entry) { 
		// defined in proejct-k projectk.js
		var w; 
		if (w = phaseA(entry)){
			if(typeof(w)=="number") 
				panic("Error! please use inner("+w+") instead of execute("+w+").\n","severe");
			else phaseB(w); 
		}
        return vm; // function cascading 
	}

	function inner (entry, resuming) {
		// defined in project-k kernel projectk.js
		var w = phaseA(entry);
		do{
			while(w) {
				ip++; // Forth general rule. IP points to the *next* word. 
				phaseB(w);
				w = dictionary[ip];
			}
			if(w===0) break; // w==0 is suspend, break inner loop but reserve rstack.
			else ip = rstack.pop(); // w is either ret(NULL) or exit(""), return to caller, or 0 when resuming through outer(entry)
			if(resuming) w = dictionary[ip]; // Higher level of inner()'s have been terminated by suspend, do their job.
		} while(ip && resuming); // Resuming inner loop. ip==0 means resuming has done。
	}
	// ### End of the inner loop ###

	// -------------------------- the outer loop ----------------------------------------------------
	// forth outer loop, 
	// If entry is given then resume from the entry point by executing 
	// the remaining colon thread down until ip reaches 0. That's resume.
	// Then proceed with the tib/ntib string.
	// 
	function outer(entry) {
		if (entry) inner(entry, true); // resume from the breakpoint 
		while(!stop) {
			var token=nexttoken();
			if (token==="") break;    // TIB done, loop exit.
			outerExecute(token);
		}
		// Handle one token. 
		function outerExecute(token){
			var w = vm.tick(token);   // not found is 0. w is an Word object.
			if (w) {
				if(!compiling){ // interpret state or immediate words
					if (w.compileonly) {
						panic(
							"Error! "+token+" is compile-only.\n", 
							tib.length-ntib>100 // error or warning? depends
						); 
						return;
					}
					execute(w);
				} else { // compile state
					if (w.immediate) {
						execute(w); // inner(w);
					} else {
						if (w.interpretonly) {
							panic(
								"Error! "+token+" is interpret-only.\n", 
								tib.length-ntib>100 // error or warning? depends
							);
							return;
						}
						comma(w); // compile w into dictionary. w is a Word() object
					}
				}
			} else if (isNaN(token)) {
				// parseInt('123abc') is 123, very wrong! Need to check in prior by isNaN().
				panic(
					"Error! "+token+" unknown.\n", 
					tib.length-ntib>100 // error or warning? depends
				);
				return;
			} else {
				if(token.substr(0,2).toLowerCase()=="0x") var n = parseInt(token);
				else  var n = parseFloat(token);
				push(n);
				if (compiling) execute("literal");
			}
		}
	}
	// ### End of the outer loop ###
	
	// code ( -- ) Start to compose a code word. docode() is its run-time.
	// "( ... )" and " \ ..." on first line will be brought into this.help.
	// projectk.js kernel has only two words, 'code' and 'end-code', jeforth.f
	// will be read from a file that will be a big TIB actually. So we don't 
	// need to consider about how to get user input from keyboard! Getting
	// keyboard input is difficult to me on an event-driven or a non-blocking 
	// environment like Node-webkit.
	function docode() {
	    // All future code words can see local variables in here, so don't use
		// any local variable here. They can *see* variables & functions out side 
		// this function too, that's normal.
		compiling = "code"; // it's true and a clue of compiling a code word.
		newname = nexttoken();
		if(isReDef(newname)) panic("reDef "+newname+"\n"); 	// don't use tick(newname), it's wrong.
		push(nextstring("end-code")); 
		if(tos().flag){
			// _me is the code word object itself.
			eval(
				'newxt=function(_me){ /* ' + newname + ' */\n' + 
				pop().str + '\n}' // the ending "\n}" allows // comment at the end
			);
		} else {
			panic("Error! expecting 'end-code'.\n");
			reset();
		}
	}
	
	words[current] = [
		0,  // Letting current_word_list()[0] == 0 has many advantages. When tick('name') 
			// returns a 0, current_word_list()[0] is 0 too, indicates a not-found.
		new Word([
			"code",
			docode,
			"this.vid='forth'",
			"this.wid=1",
			"this.type='code'",
			"this.help='( <name> -- ) Start composing a code word.'"
		]),
		new Word([
			"end-code",
			function(){
				if(compiling!="code"){ panic("Error! 'end-code' to a none code word.\n"); return};
				current_word_list().push(new Word([newname,newxt]));
				last().vid = current;
				last().wid = current_word_list().length-1;
				last().type = 'code';
				last().help = newhelp;
				wordhash[last().name]=last();
				compiling  = false;
			},
			"this.vid='forth'",
			"this.wid=2",
			"this.type='code'",
			"this.immediate=true",
			"this.compileonly=true",
			"this.help='( -- ) Wrap up the new code word.'"
		])
	];
	
	// Use the best of JavaScript to find a word.
	wordhash = {"code":current_word_list()[1], "end-code":current_word_list()[2]};
	
	// -------------------- main() ----------------------------------------

	// Recursively evaluate the input. The input can be multiple lines or 
	// an entire ~.f file yet it usually is the TIB.
	function dictate(input) {
		var tibwas=tib, ntibwas=ntib, ipwas=ip;
		tib = input; 
		ntib = 0;
		stop = false; // stop outer loop
		outer();
		tib = tibwas;
		ntib = ntibwas;
		ip = ipwas;
        return vm; // function cascading 
	}

	// -------------------- end of main() -----------------------------------------

	// Top of Stack access easier. ( tos(2) tos(1) tos(void|0) -- ditto )
	// tos(i,new) returns tos(i) and by the way change tos(i) to new value this is good
	// for counting up or down in a loop.
	function tos(index,value) {	
		switch (arguments.length) {
			case 0 : return stack[stack.length-1];
			case 1 : return stack[stack.length-1-index];
			default : 
				var data = stack[stack.length-1-index]
				stack[stack.length-1-index] = value; 
				return(data); 
		}
	}

	// Top of return Stack access easier. ( rtos(2) rtos(1) rtos(void|0) -- ditto )
	// rtos(i,new) returns rtos(i) and by the way change rtos(i) to new value this is good
	// for counting up or down in a loop.
	function rtos(index,value) {	
		switch (arguments.length) {
			case 0 : return rstack[rstack.length-1];
			case 1 : return rstack[rstack.length-1-index];
			default : 
				var data = rstack[rstack.length-1-index]
				rstack[rstack.length-1-index] = value; 
				return(data); 
		}
	}

	// Stack access easier. e.g. pop(1) gets tos(1) and leaves ( tos(2) tos(1) tos(void|0) -- tos(2) tos(void|0) )
	// push(formula(pop(i)),i-1) manipulate the tos(i) directly, usually when i is the index of a loop.
	function pop(index) {	
		switch (arguments.length) {
			case 0  : return stack.pop();
			default : return stack.splice(stack.length-1-index, 1)[0];
		}
	}

	// Stack access easier. e.g. push(data,1) inserts data to tos(1), ( tos2 tos1 tos -- tos2 tos1 data tos )
	// push(formula(pop(i)),i-1) manipulate the tos(i) directly, usually when i is the index of a loop.
	function push(data, index) { 
		switch (arguments.length) {
			case 0  : 	panic(" push() what?\n");
			case 1  : 	stack.push(data); 
						break;
			default : 	if (index >= stack.length) {
							stack.unshift(data);
						} else {
							stack.splice(stack.length-1-index,0,data);
						}
		}
        return vm; // function cascading 
	}

	// typeof(array) and typeof(null) are "object"! So a tweak is needed.
	function mytypeof(x){
		var ty = typeof x;
		switch (ty) {
		case 'object':
			if (!x) ty = 'null';
			if (Object.prototype.toString.apply(x) === '[object Array]') ty = "array";
		}
		return ty;
	}
	// js> mytypeof([])           \ ==> array (string)
	// js> mytypeof(1)            \ ==> number (string)
	// js> mytypeof('a')          \ ==> string (string)
	// js> mytypeof(function(){}) \ ==> function (string)
	// js> mytypeof({})           \ ==> object (string)
	// js> mytypeof(null)         \ ==> null (string)  

	vm.dictate = dictate; // This is where commands are from. A clause or more.
	vm.execute = execute; // Original version. Execute a single command.
	vm.stack = function(){return(stack)}; // debug easier. stack got manipulated often, need a fresh grab.
	vm.rstack = function(){return(rstack)}; // debug easier especially debugging TSR
	vm.words = words; // debug easier. works.forth is the root vocabulary or word-list
	vm.dictionary = dictionary; // debug easier
	vm.push = push; // interface for passing data into the VM.
	vm.pop = pop;   // interface for getting data out of the VM.
	vm.tos = tos;   // interface for getting data out of the VM.
	vm.reset = reset; // Recovery from a crash
	vm.tick = tick; // Original version. Get a word object.
}
if (typeof exports!='undefined') exports.jeForth = jeForth;	// export for node.js APP
    
    </Script>
    <script id=js>
    
    // jeforth.htm.js 
    var jeforth_project_k_virtual_machine_object = new jeForth(); // A permanent name.
    var kvm = jeforth_project_k_virtual_machine_object; // "vm" may not be so permanent.
    (function(){
        var version = 1.01;
        kvm.appname = "jeforth.3htm"; //  不要動， jeforth.3we kernel 用來分辨不同 application。
        kvm.host = window; // DOM window is the root for 3HTM. global 掛那裡的根據。
        kvm.path = ["dummy", "3ce", "doc", "f", "3htm/f", "3htm/canvas", "3htm", "demo", "playground"];
        kvm.screenbuffer = ""; // type() to screenbuffer before I/O ready; self-test needs it too.
        kvm.selftest_visible = true; // type() refers to it.
        
        // kvm.type() is the master typing or printing function.
        // The type() called in code ... end-code is defined in the kernel projectk.js.
        // We need to use type() below, and we can't see the projectk.js' type() so one 
        // is also defined here, even just for a few convenience. The two type() functions 
        // are both calling the same kvm.type().
        var type = kvm.type = function (s) { 
            try {
                var ss = s + ''; // Print-able test
            } catch(err) {
                ss = Object.prototype.toString.apply(s);
            }
            if(kvm.screenbuffer!=null) kvm.screenbuffer += ss; // 填 null 就可以關掉。
            if(kvm.selftest_visible) $('#outputbox').append(kvm.plain(ss)); 
        }
        
        // kvm.panic() is the master panic handler. The panic() function defined in 
        // project-k kernel projectk.js is the one called in code ... end-code.
        kvm.panic = function(state){ 
            type(state.msg);
            if (state.serious) debugger;
        }
        // We need the panic() function below but we can't see the one in projectk.js
        // so one is defined here for convenience.
        function panic(msg,level) {
            var state = {
                    msg:msg, level:level
                };
            if(kvm.panic) kvm.panic(state);
        }
        
        kvm.clearScreen = function () {
            kvm.screenbuffer = "";
            $('#outputbox').empty();
        }
     // kvm.greeting = function(){
     //     type("j e f o r t h . 3 h t m -- v"+version+'\n');
     //     type("source code http://github.com/hcchengithub/jeforth.3we\n");
     //     type("Program path " + window.location.toString());
     //     return(version);
     // }
        kvm.greeting = function(){
            var version = 1.01;
            type("p r o e f o r t h -- v"+ version +'\n');
            type("Forth kernel http://github.com/hcchengithub/project-k\n");
            type("Program path " + window.location.toString());
            return(version);
        }

        kvm.debug = false;
        kvm.prompt = "OK";
        kvm.bye = function(){window.close()};
        
        // System initialization
        // jQuery(document).ready(
        //     // jQuery convention, learned from W3School, make sure web page is ready.
        //     function() {
        //         $('#rev').html(version); // also .commandLine, .applicationName, ...
        //         $('#location').html(window.location.toString()); // it's built-in in DOM
        //         $('.appname').html(kvm.appname); // 一次填好所有 appname
        //         document.onkeydown = hotKeyHandler; // Must be using onkeydown so as to grab the control.
        //         var k = "f/jeforth.f";
        //         var r = "3htm/f/readtextfile.f";
        //         var q = "3htm/f/quit.f";
        //         var kk = $.get(k,'text');
        //         var rr = $.get(r,'text');
        //         var qq = $.get(q,'text');
        //         // $.get() callback only when success, so it's not suitable.
        //         // this is my workaround:
        //         (function retry(){
        //             if(kk.state()=="pending"||rr.state()=="pending"||qq.state()=="pending")
        //                 setTimeout(retry,100); 
        //             else {
        //                 if (kk.status!=200) panic("Error! Failed to read " + k + '\n');
        //                 else if (rr.status!=200) panic("Error! Failed to read " + r + '\n');
        //                 else if (qq.status!=200) panic("Error! Failed to read " + q + '\n');
        //                 else kvm.dictate(kk.responseText+rr.responseText+qq.responseText);
        //             }
        //         })();
        //     }                       
        // );                          

        jQuery(document).ready(
            function() {
                document.onkeydown = hotKeyHandler; // Must be using onkeydown so as to grab the control.
                // vm.dictate() is the Forth command interface.
                // Send a command line string, or an entire source code file into the Forth VM through
                // this interface.
                kvm.dictate(jeforth_f.value); 
                kvm.dictate(jsc_f.value); 
                kvm.dictate(quit_f.value); 
            }
        );

        // There's no main loop, event driven call back function is this.
        kvm.scroll2inputbox = function(){window.scrollTo(0,endofinputbox.offsetTop)}
        kvm.forthConsoleHandler = function(cmd) {
            var rlwas = kvm.rstack().length; // r)stack l)ength was
            type((cmd?'\n> ':"")+cmd+'\n');
            kvm.dictate(cmd);  // Pass the command line to KsanaVM
            (function retry(){
                // rstack 平衡表示這次 command line 都完成了，這才打 'OK'。
                // event handler 從 idle 上手，又回到 idle 不會讓別人看到它的 rstack。
                // 雖然未 OK, 仍然可以 key in 新的 command line 且立即執行。
                if(kvm.rstack().length!=rlwas)
                    setTimeout(retry,100); 
                else {
                    type(" " + kvm.prompt + " ");
                    if ($(inputbox).is(":focus")) kvm.scroll2inputbox();
                }
            })();
        }

        // onkeydown,onkeypress,onkeyup
        // event.shiftKey event.ctrlKey event.altKey event.metaKey
        // KeyCode test page http://www.asquare.net/javascript/tests/KeyCode.html
        function hotKeyHandler(e) {
            // document.onkeydown() initial version defined in jeforth.3thm.js
            // will be reDef by platform.f
            e = (e) ? e : event; var keyCode = (e.keyCode) ? e.keyCode : (e.which) ? e.which : false;
            switch(keyCode) {
                case 13: /* Enter */
                    var cmd = inputbox.value; // w/o the '\n' character ($10). 
                    inputbox.value = ""; // 少了這行，如果壓下 Enter 不放，就會變成重複執行。
                    kvm.forthConsoleHandler(cmd);
                    return(false); 
            }
            return (true); // pass down to following handlers 
        }
        
        // Useful common tool
        kvm.plain = function (s) {
            var ss = s + ""; // avoid numbers to fail at s.replace()
            ss = ss.replace(/&/g,'&amp;')
                   .replace(/\t/g,' &nbsp; &nbsp;')
                   .replace(/ /g,'&nbsp;')
                   .replace(/</g,'&lt;')
                   .replace(/>/g,'&gt;')
                   .replace(/\r?\n\r?/g,'<br>');
            return ss;
        }
        
        // Called from jsEvalRaw, it will handle the try{}catch{} thing. 
        kvm.writeTextFile = function(pathname,data) { // Write string to text file.
            panic("Error writing " + pathname + ", jeforth.3htm doesn't know how to wrtieTextFile yet.\n"); 
        }

        kvm.readTextFile = function(pathname){
            panic("Error reading " + pathname + ", jeforth.3htm doesn't know how to readTextFile."+
                      " Please use $.get(pathname,callback,'text') instead.\n");
        }
        
    })();

    </script>
</head>
<body>
    <div><b>p r o e F o r t h</b><hr>
    <div class=console3we><!-- 有重要用途於 plateform.f -->
    <div id="outputbox">
    <textarea hidden id="jeforth_f" cols=140 rows=10>
code //         last().help = nexttoken('\n|\r'); end-code
                // ( <comment> -- ) Give help message to the new word.
code stop       reset() end-code // ( -- ) Stop the TIB loop
code parse-help var ss = " " + pop() + " ", comment = "";
                var stackDiagram = ss.match(/^\s+(\(\s.*?\s\))\s+(.*)/); // null or [0] entire line, [1] (...), [2] the rest.
                if(stackDiagram) { 
                    comment = (" "+stackDiagram[2]+" ").match(/^\s+\\\s+(.*\S)\s+/); // null or [0] entire line, [1] comment
                    if(comment){
                        push(stackDiagram[1]+" "+comment[1]);
                        push("");
                    } else {
                        push(stackDiagram[1]);
                        push(stackDiagram[2]);
                    }
                } else {    
                    comment = ss.match(/^\s+\\\s+(.*\S)\s+/); // null or [0] entire line, [1] comment
                    if(comment){
                        push(comment[1]);
                        push("");
                    } else {
                        push("( ?? ) No help message. Use // to add one.");
                        push(ss);
                    }
                }   
                end-code        
                // ( "line" -- "helpmsg" "rests" ) Parse "( -- ) \ help foo baa" from 1st input line
                
code privacy    push(false) end-code // ( -- false ) Default is false, words are nonprivate by default.
                
code code       push(nexttoken()); // name of the word
                push(nexttoken('\n|\r')); // rest of the first line
                execute("parse-help"); // ( "name" "helpmsg" "rests" )
                tib = " " + pop() + tib.slice(ntib); // "rests" + tib(ntib)
                ntib = 0;
                newhelp = pop();
                tib = pop() + " " + tib; // "name" + tib
                execute(words.forth[1]); // execute the old version 'code'.
                end-code
                // ( <name ..code..> -- ) Start composing a code word.
                
code _init_     ( -- ) \ Initialize vm.g.members that are moved out from projectk.js which is thus kept pure.

                // To support private word, END-CODE needs one more line
                words.forth[2].xt = function(){ 
                    // was from project-k projectk.js, modified by jeforth.3we jeforth.f _init_ 
                    if(compiling!="code"){ panic("Error! 'END-CODE' to a none code word.\n"); return};
                    current_word_list().push(new Word([newname,newxt]));
                    last().vid = current;
                    last().wid = current_word_list().length-1;
                    last().type = 'code';
                    last().help = newhelp;
                    vm.execute("privacy"); // use the original execute() to avoid warning
                    last().private = Boolean(pop()); // support private word
                    wordhash[last().name]=last();
                    compiling  = false;
                }                

                // Access variables in context from js code
                vm.v = function(name){
                    // FORTH variables (value or constant) can be accessed in js code
                    // throuth vm[context].variableName or vm.forth.variableName
                    // shorter form v(variableName) 
                    // where 'v' means (V)ariable in the recent context.
                    return vm[context][name]
                }

                // Access variables in root vocabulary from js code
                vm.r = function(name){
                    // FORTH variables (value or constant) can be accessed in js code
                    // throuth vm[context].variableName or vm.forth.variableName
                    // shorter form r(variableName) 
                    // where 'r' means the (R)oot context which is the 'forth' word-list.
                    return vm.forth[name]
                }
                
                // An array's length is array.length but there's no such thing of hash.length for hash{}.
                // memberCount(object) gets the given object's member count which is also a hash table's length.
                vm.g = {}; // The global hash
                vm.g.memberCount = function (obj) {
                    var i=0;
                    for(var members in obj) i++;
                    return i;
                }

                // This is a useful common tool. Compare two arrays.
                vm.g.isSameArray = function (a,b) {
                    if (a.length != b.length) {
                        return false;
                    } else {
                        for (var i=0; i < a.length; i++){
                            var ta = typeof(a[i]);
                            var tb = typeof(b[i]);
                            if (ta == tb) {
                                if (ta == "number"){
                                    if (isNaN(a[i]) && isNaN(b[i])) continue; // because (NaN == NaN) 的結果是 false 所以要特別處理。
                                }
                                if (ta == "object") {  // 怎麼比較 obj? v2.05 之後用 memberCount()
                                    if (vm.g.memberCount(a[i]) != vm.g.memberCount(b[i])) return false;
                                } else if (a[i] != b[i]) return false;
                            } else if (a[i] != b[i]) return false;
                        }
                        return true;
                    }
                }

                // Tool, check if the item exists in the array or is it a member in the hash.
                // return {flag, key}
                vm.g.isMember = function (item, thing){
                    var result = {flag:false, key:0};
                    if (mytypeof(thing) == "array") {
                        for (var i in thing) {
                            if (item == thing[i]) {
                                result.flag = true;
                                result.key = parseInt(i); // array 被 JavaScript 當作 object 而 i 是個 string, 所以要轉換!
                                break;
                            }
                        }
                    } else { // if obj is not an array then assume it's an object
                        for (var i in thing) {
                            if (item == i) {
                                result.flag = true;
                                result.key = thing[i];
                                break;
                            }
                        }
                    }
                    return result; // {flag:boolean, value:(index of the array or value of the obj member)}
                }

                // How to clear all setInterval() and setTimeOut() without knowing their ID?
                // http://stackoverflow.com/questions/8769598/how-to-clear-all-setinterval-and-settimeout-without-knowing-their-id
                // 缺點是 vm.g.setTimeout.registered() 會大量堆積，需 delete(vm.g.setTimeout.registered()[id.toString()]) 既然還得記住
                // timeoutId 使得 vm.g.setTimeout() 的好處大打折扣。 查看： js> vm.g.setTimeout.registered() (see)
                // setInterval 比較不會大量堆積，最好還是要適時 delete。查看：js> vm.g.setInterval.registered() (see)
                vm.g.setInterval = (function(){
                    var registered={};
                    f = function(a,b){
                        var id = setInterval(a,b);
                        registered[id.toString()] = id;
                        return id;
                    };
                    f.clearAll = function(){
                        for(var r in registered){clearInterval( registered[r] )}
                        registered={};
                    };
                    f.registered = function(){return(registered)};
                    return f;    
                })();

                vm.g.setTimeout = (function(){
                    var registered={};
                    f = function(a,b){
                        var id = setTimeout(a,b);
                        registered[id.toString()] = id;
                        return id;
                    };
                    f.clearAll = function(){
                        for(var r in registered){clearTimeout( registered[r] )}
                        registered={};
                    };
                    f.registered = function(){return(registered)};
                    return f;    
                })();
                
                // jeforth inner interpreter debugger mode opposed to performance mode
                vm.g.debugInner = function (entry, resuming) {
                    var w = phaseA(entry); // 翻譯成恰當的 w.
                    do{
                        while(w) { // 這裡是 forth inner loop 決戰速度之所在，奮力衝鋒！
                            // 可用 bp=ip 設斷點, debug colon words.
                            if(vm.jsc.bp<0||vm.jsc.bp==ip){
                                if (vm.jsc.enable){ // 需要這個 flag 因為若已經進了 debugInner, 換掉 inner 也出不來。
                                    vm.jsc.prompt=" BreakPoint jsc>";
                                    eval(vm.jsc.xt);
                                }
                            };
                            ip++; // Forth 的通例，inner loop 準備 execute 這個 word 之前，IP 先指到下一個 word.
                            phaseB(w); // 針對不同種類的 w 採取正確方式執行它。
                            w = dictionary[ip];
                        }
                        if(w===0) break; else ip = rstack.pop(); // w==0 is suspend, abort inner but reserve rstack
                        if(resuming) w = dictionary[ip];
                    } while(ip && resuming); // ip==0 means resuming has done
                }
                
                
                // Scan given VID into wordhash{}
                vm.g.scan_vocabulary = function (v,isContext) { 
                    for (var i=1; i<words[v].length; i++){  // The [0] is 0, skip it.
                        // skip the last() to avoid unexpected 'reveal'.
                        if (compiling && last()==words[v][i]) continue; 
                        // skip private words unless in context
                        if (isContext || !words[v][i].private) wordhash[words[v][i].name] = words[v][i];
                    }
                }
                
                // Referenced by name warning when execute(),tick() on a private word.
                // vm.tick is the original version which is used sometimes like in 'all-pass'.
                tick = vm.g.selftest_tick = function tick(name) {
                    // selftest version defined in jeforth.f
                    var w = wordhash[name] || 0; // 0 means 'not found'
                    if (w && w.private)
                        panic("Warning! private word "+w.name+" referenced by name in tick()!\n",true); 
                    return w;
                }
                
                // Referenced by name warning when execute(),tick() on a private word.
                // vm.execute is the original version which is used sometimes like in '(create)'.
                execute = vm.g.selftest_execute = function execute(entry) { 
                    // selftest version defined in jeforth.f 
                    var w, calledByName = typeof entry == "string"; 
                    if (w = phaseA(entry)){
                        if(typeof(w)=="number") {
                            panic("Error! please use inner("+w+") instead of execute("+w+").\n","severe");
                            return;
                        }
                        if (calledByName && typeof(w)=="object" && w.private)
                            panic("Warning! private word "+w.name+" called by name in execute()!\n",true); 
                        phaseB(w); 
                    }
                }
                
                end-code _init_

code version    ( -- revision ) \ print the greeting message and return the revision code
                push(vm.greeting()) end-code

code <selftest> ( <statements> -- ) \ Collect self-test statements. interpret-only
                push(nexttoken("</selftest>"));
                end-code

code </selftest> ( "selftest" -- ) \ Save the self-test statements to <selftest>.buffer. interpret-only
                var my = tick("<selftest>");
                my.buffer = my.buffer || ""; // initialize my.buffer
                my.buffer += pop();
                end-code

                <selftest>
                    <comment>
                    程式只要稍微大一點點，就得附上一些 self-test 讓它伺機檢查自身。隨便有做，穩定性
                    就會提升一大步。 Forth 的結構全部都是 global words， 改動的時候自由無限，難以一
                    一去檢討影響到了哪些 words, 不讓它全面自動測試十分令人擔憂。與其努力抓 bug 不如
                    早點把 self-test 做進去。

                    Self-test 的執行時機是程式開始時，或開機時。沒有特定任務就做 self-test.

                    include 各個 modules 時，循序就做 self-test。藉由 forth 的 marker , (forget) 等
                    self-test 用過即丟， 只花時間，不佔空間。花平時的開發時間不要緊，有特定任務時就
                    跳過 self-test，是則完全不佔執行系統任何時間空間，只佔 source code 的篇幅。

                    我嘗試了種種的 self-test 寫法。有的很醜，混在正常程式裡面相當有礙視線；不醜的很
                    累，佔很大 source code 篇幅。

                    以下是發展到目前最好的方法，projectk.js kernel  裡只有 code end-code 兩個基本 
                    words, 剛進到 jeforth.f  只憑這兩個基本 words 就馬上要為每個 word 都做 self-test 
                    原本是很困難的。 然而，jeforth.f 是整個檔案一次讀進來成為大大的一個 TIB 的， 所
                    以其中已經含有 jeforth.f 的全部功能。如果 self-test 安排在所有的 words 都 load 
                    好以後做，資源充分就不覺有困難。好玩的是，進一步，利用〈selftest〉〈/selftest〉這
                    對「文字蒐集器」在任意處所蒐集「測試程式的本文」，最後再一次把它當成 TIB 執行。實
                    用上〈selftest〉〈/selftest〉出現在每個 word 定義處，裡頭可以放心自由地使用尚未出
                    生的「未來 words」, 對寫程式時的頭腦有很大的幫助。 
                    </comment>

                    marker ~~selftest~~ // ( -- ) marker, clean selftest garbage
                    .( *** Start self-test ) cr
                    *** Data stack should be empty
                        depth [d 0 d] 
                        [p 'code','end-code','.', '."', '.(', ':', ';', 'if', 'else', 'then', 
                        'js>', 'parse-help','cr','depth','<selftest>','</self'+'test>','word',
                        '<js>', '</'+'jsV>' p]
                    *** Rreturn stack should have less than 2 cells
                        description . 
                        js> rstack.length dup . space 2 <= [if] .( pass) cr [else] .( failed!) cr stop [then]
                        [p 'dup','<=','[if]', '[else]', '[then]' p]
                    *** // adds help to the last word
                        ' // :> help.indexOf("message")!=-1 [d true d] [p "//", ":>", "'" p]
                    *** version should return a number
                        js: vm.selftest_visible=false;vm.screenbuffer=""
                        version 
                        js: vm.selftest_visible=true
                        js> typeof(pop())=="number" ( true )
                        <js> vm.screenbuffer.indexOf('p r o e f o r t h')!=-1 </jsV> ( true )
                        [d true,true d]
                        [p 'version' p]
                </selftest>

code execute    ( Word|"name"|address -- ... ) \ Execute the given word.
                execute(pop()); end-code

                <selftest>
                    *** "drop" drops the TOS
                        321 123 s" drop" execute \ 321
                        654 456 ' drop execute \ 321 654
                        [d 321,654 d] [p 'drop', "'", "execute", '\\' p]
                </selftest>

code interpret-only  ( -- ) \ Make the last new word an interpret-only.
                last().interpretonly=true;
                end-code interpret-only

                <selftest>
                    *** interpret-only marks the last word an interpret-only word
                        ' execute :> interpretonly==true ( false ) 
                        ' interpret-only :> interpretonly==true ( true )
                        [d false,true d] [p "interpret-only" p]
                </selftest>

code immediate  ( -- ) \ Make the last new word an immediate.
                last().immediate=true
                end-code

                <selftest>
                    *** immediate marks the last word an immediate word
                        ' execute :> immediate==true ( false ) 
                        ' \ :> immediate==true ( true )
                        [d false,true d] [p "immediate" p]
                </selftest>
                
code ///        ( <comment> -- ) \ Add comment to the new word, it appears in 'see'.
                var ss = nexttoken('\n|\r');
                ss = ss.replace(/^/,"\t"); // Add leading \t to each line.
                ss = ss.replace(/\s*$/,'\n'); // trim tailing white spaces
                last().comment = typeof(last().comment) == "undefined" ? ss : last().comment + ss;
                end-code interpret-only

                <selftest>
                    *** /// adds comment to the last word
                        1234 constant x
                        /// comment-line-111
                        /// comment-line-222
                        js> last().comment.indexOf("comment-line-111")==-1
                        js> last().comment.indexOf("comment-line-222")==-1
                        x [d false,false,1234 d] [p "///","constant" p]
                        (forget)
                </selftest>
                
code private  ( -- ) \ Make the last word invisible when out of the context.
                last().private=true
                end-code
                /// The opposite is nonprivate.
                
code nonprivate  ( -- ) \ Make the last word non-private so it's globally visible.
                last().private=false
                end-code
                /// The opposite of private.
                
                <selftest>
                    \ *** private marks the last word a private word
                    \   ' execute :> immediate==true ( false ) 
                    \   ' \ :> immediate==true ( true )
                    \   [d false,true d] [p "immediate" p]
                </selftest>

code .((        ( <str> -- ) \ Print string that has ')' in it down to '))' immediately.
                type(nexttoken('\\)\\)'));ntib+=2; end-code immediate

code \          ( <comment> -- ) \ Comment down to the next '\n'.
                nexttoken('\n') end-code immediate

                <selftest>
                    *** TIB lines after \ should be ignored
                        111 \ 222
                        : dummy
                            999
                            \ 333 444 555
                        ;
                        last execute [d 111,999 d] [p '\\' p]
                        (forget)
                </selftest>

code \s         ( -- ) \ Stop outer loop which may be loading forth source files.
                stop=true; 
                ntib=tib.length; // 可能沒用，雙重保險。
                end-code

code compile-only  ( -- ) \ Make the last new word a compile-only.
                last().compileonly=true
                end-code interpret-only

                <selftest>
                    *** compile-only marks last word as a compile-only word
                        ' execute :> compileonly==true ( false ) 
                        ' if :> compileonly==true ( true )
                        [d false,true d] [p "compile-only" p]
                </selftest>

\ ------------------ Fundamental words ------------------------------------------------------
                
code (create)   ( "name" -- ) \ Create a code word that has a dummy xt, not added into wordhash{} yet
                if(!(newname=pop())) panic("(create) what?\n", tib.length-ntib>100);
                if(isReDef(newname)) type("reDef "+newname+"\n"); // 若用 tick(newname) 就錯了
                current_word_list().push(new Word([newname,function(){}]));
                last().vid = current; // vocabulary ID
                last().wid = current_word_list().length-1; // word ID
                last().type = "colon-create";
                vm.execute("privacy"); // use the original execute() to avoid warning
                last().private = Boolean(pop());
                end-code

code reveal     ( -- ) \ Add the last word into wordhash
                wordhash[last().name]=last() end-code
                \ We don't want the last word to be seen during its colon definition.
                \ So reveal is done in ';' command.

                <selftest>
                    *** (create) creates a new word
                        char ~(create)~ (create)
                        js> last().name [d "~(create)~" d] [p "(create)","char" p]
                </selftest>

code (space)    push(" ") end-code // ( -- " " ) Put a space on TOS.
code BL         push("\\s") end-code // ( -- "\s" ) RegEx white space, works with 'word' command.
code CR         push("\\n|\\r") end-code // ( -- '\n' ) RegEx new line, works with 'word' command.
                /// Also String.fromCharCode(10) in JavaScript

                <selftest>
                    *** (space) puts a 0x20 on TOS
                        (space) js> String.fromCharCode(32) =
                        [d true d] [p "(space)","=" p]
                    *** BL should return the string '\s' literally
                        BL [d "\\s" d] [p "BL" p]
                    *** CR should return the string \n|\r literally
                        CR js> "\\n|\\r" = 
                        [d true d] [p "CR","=" p]                       
                </selftest>

code jsEval     ( "js code" -- result ) \ Evaluate the given JavaScript statements, return the last statement's value.
                try {
                  push(eval(pop()));
                } catch(err) {
                  panic("JavaScript error : "+err.message+"\n", "error");
                };
                end-code private
                
                <selftest>
                    *** jsEval should eval(tos) and return the last statement's value
                        456 char pop()+1 jsEval [d 457 d] [p "jsEval" p]
                </selftest>

code jsEvalNo   ( "js code" -- ) \ Evaluate the given JavaScript statements, w/o return value.
                try {
                  eval(pop());
                } catch(err) {
                  panic("JavaScript error : "+err.message+"\n", "error");
                };
                end-code private

                <selftest>
                    *** jsEvalNo should eval(tos) but won't return any value
                        456 char 123 jsEvalNo [d 456 d] [p "jsEvalNo" p]
                </selftest>

code jsFunc     ( "js code" -- function ) \ Compile JavaScript to a function() that returns last statement
                // 切出最後一個 statement 以傳回其值比想像中困難。
                // 規定除了最後一行之外行末尾的 ; 不能省略。
                // 出現在 ['"/] 當中的 ';' 會造成分辨錯亂, 必須先換掉, 然後再換回來, 這
                // 就一大段了。即使如此 string 以及 RegEx 中又有 escape char 尚未周全！
                var ss=pop();
                ss = ss.replace(/(^( |\t)*)|(( |\t)*$)/mg,'') // remove 頭尾 whitespaces. .trim() 舊 JScript v5.6 未 support                
                       .replace(/\s*\/\/.*$/gm,'') // remove // comments
                       .replace(/(\n|\r)*/gm,'') // merge to one line
                       .replace(/\s*[/]\*(.|\r|\n)*?\*[/]\s*/gm,'') // remove /* */ comments
                       .replace(/;*\s*$/,''); // remove ending ';' from the last statement
                ss = replace_semicolon_in_quotes(ss); 
                var parsed=ss.match(/^(.*;)(.*)$/); // [entire string,fore part,last statement]|NULL
                if (parsed){
                    parsed[1] = parsed[1].replace(/__SeMiCoLoN__/g,";");
                    parsed[2] = parsed[2].replace(/__SeMiCoLoN__/g,";"); 
                    eval("push(function(){" + parsed[1] + "push(" + parsed[2] + ")})");
                }else{
                    eval("push(function(){push(" + ss + ")})");
                }
                function replace_semicolon_in_quotes(source) { 
                    // return ['"/]foo;bar['"/] ==> ['"/]foo__SeMiCoLoN__bar['"/]
                    var result = "";
                    for (;;) {
                        var aa = nextQuote(source); // ["cooked","raw"]
                        result += aa[0];
                        if (!aa[1]) return (result);
                        source = aa[1];
                    }
                    function nextQuote(source) { 
                        // return ["cooked","raw"]
                        var result="", aa=source.match(/['"/]/);
                        if (!aa) return([source,""]); // Done
                        switch(aa[0]){
                            case "'" : var re = /^(.*?)(['].*?['])(.*)$/; break;
                            case '"' : var re = /^(.*?)(["].*?["])(.*)$/; break;
                            default  : var re = /^(.*?)([/].*?[/])(.*)$/;
                        }
                        var pieces = source.match(re);
                        if(pieces) {
                            result += pieces[1];
                            result += pieces[2].replace(/;/g,"__SeMiCoLoN__");
                            return [result,pieces[3]];
                        } else 
                            return([source,""]); 
                            // 已經不平衡了,算了。因為 ['"/] 裡又可能有 escape char 目前不夠周全。
                    }
                }
                end-code private

code jsFuncNo   ( "js code" -- function ) \ Compile JavaScript to a function()
                eval("push(function(){" + pop() + "})"); 
                end-code private

code [          compiling=false end-code immediate // ( -- ) 進入直譯狀態, 輸入指令將會直接執行 *** 20111224 sam
code ]          compiling=true end-code // ( -- ) 進入編譯狀態, 輸入指令將會編碼到系統 dictionary *** 20111224 sam
code compiling  push(compiling) end-code // ( -- boolean ) Get system state
code last       push(last()) end-code // ( -- word ) Get the word that was last defined.

                <selftest>
                    *** last should return the last word
                        0 constant xxx
                        last :> name [d "xxx" d] [p "last" p]
                        (forget)
                </selftest>

code exit       ( -- ) \ Exit this colon word.
                comma(EXIT) end-code immediate compile-only

                <selftest>
                    *** exit should stop a colon word
                        : dummy 123 exit 456 ;
                        last execute [d 123 d] [p "exit" p]
                        (forget)
                </selftest>

code ret        ( -- ) \ Mark at the end of a colon word.
                comma(RET) end-code immediate compile-only

code rescan-word-hash ( -- ) \ Rescan all word-lists in the order[] to rebuild wordhash{}
                wordhash = {}; context = order[order.length-1];
                vm.g.scan_vocabulary("forth",false); // forth always available
                for (var j=0; j<order.length-1; j++) 
                    vm.g.scan_vocabulary(order[j],false); // The latter the higher priority
                vm.g.scan_vocabulary(context,true); // The context has the highest priority
                end-code

code all        ( -- ) \ Temporarily make all private words public, so "all words" shows them all.
                for (var j=0; j<order.length; j++) 
                    vm.g.scan_vocabulary(order[j],true); // The latter the higher priority
                end-code
                
code (forget)   ( -- ) \ Forget the last word
                if (last().cfa) here = last().cfa;
                words[current].pop(); // drop the last word
                execute("rescan-word-hash");
                end-code 

                <selftest>
                    *** (forget) should forget the last word
                        : remember-me ; (forget)
                        last :> name=="remember-me" [d false d] 
                        [p "(forget)","rescan-word-hash" p]
                </selftest>

code :          ( <name> -- ) \ Begin a forth colon definition.
                newname = nexttoken();
                push(nexttoken('\n|\r')); // rest of the first line
                execute("parse-help"); // ( "helpmsg" "rests" )
                tib = " " + pop() + tib.slice(ntib); ntib = 0; // "rests" + tib(ntib)
                newhelp = /* newname + " " + */ pop(); // help messages packed
                push(newname); execute("(create)"); // 故 colon definition 裡有 last or last() 可用來取得本身。
                compiling=true;
                tick(':').stackwas = stack.slice(0); // Should not be changed, ';' will check.
                last().type = "colon";
                last().cfa = here;
                last().help = newhelp;
                last().xt = colonxt = function(){
                    rstack.push(ip);
                    inner(this.cfa);
                }
                end-code

code ;          ( -- ) \ End of the colon definition.
                if (!vm.g.isSameArray(tick(':').stackwas,stack)) {
                    panic("Stack changed during colon definition, it must be a mistake!\n", "error");
                    words[current].pop();
                } else {
                    comma(RET);
                }
                compiling = false;
                execute('reveal');
                end-code immediate compile-only

code (')        ( "name" -- Word ) \ name>Word like tick but the name is from TOS.
                push(vm.tick(pop())) // use the original tick() to avoid warning
                end-code

code '          ( <name> -- Word ) \ Tick, get word name from TIB, leave the Word object on TOS.
                push(vm.tick(nexttoken())) // use the original tick() to avoid warning
                end-code


                <selftest>
                    *** ' tick and (') should return a word object
                        ' code :> name char end-code (') :> name
                        [d "code","end-code" d] [p "'","(')" p]
                </selftest>

code #tib       push(ntib) end-code // ( -- n ) Get ntib
code #tib!      ntib = pop() end-code // ( n -- ) Set ntib

\ ------------------ eforth code words ----------------------------------------------------------------------

code branch     ip=dictionary[ip] end-code compile-only // ( -- ) 將當前 ip 內數值當作 ip *** 20111224 sam

                <selftest>
                    *** branch should jump to run hello
                    marker ---
                        : sum 0 1 begin 2dup + -rot nip 1+ dup 10 > if drop exit then again ;
                        : test sum 55 = ;
                        test [d true d] [p '2dup', '-rot', 'nip', '1+', '>', '0branch' p]
                    ---
                </selftest>

code 0branch    if(pop())ip++;else ip=dictionary[ip] end-code compile-only // ( n -- ) 若 n!==0 就將當前 ip 內數值當作 ip, 否則將 ip 進位 *** 20111224 sam
code !          dictionary[pop()]=pop() end-code // ( n a -- ) 將 n 存入位址 a
code @          push(dictionary[pop()]) end-code // ( a -- n ) 從位址 a 取出 n
code >r         rstack.push(pop()) end-code  // ( n -- ) Push n into the return stack.
code r>         push(rstack.pop()) end-code  // ( -- n ) Pop the return stack
code r@         push(rtos()) end-code // ( -- r0 ) Get a copy of the TOS of return stack
code drop       pop(); end-code // ( x -- ) Remove TOS.
code dup        push(tos()) end-code // ( a -- a a ) Duplicate TOS.
code swap       push(pop(1)) end-code // ( a b -- b a ) stack operation
code over       push(tos(1)) end-code // ( a b -- a b a ) Stack operation.
code 0<         push(pop()<0) end-code // ( a -- f ) 比較 a 是否小於 0

                <selftest>
                    *** ! @ >r r> r@ drop dup swap over 0<
                    marker ---
                    variable x 123 x ! x @ 123 = \ true
                    111 dup >r r@ r> + swap 2 * = and \ true
                    333 444 drop 333 = and \ true
                    555 666 swap 555 = \ true 666 true
                    rot and swap \ true 666
                    0< not and \ true
                    -1 0< and \ true
                    false over \ true
                    [d true, false, true d] [p '!', '@', '>r', 'r>', 'r@', 'swap', 'drop',
                    'dup', 'over', '0<', '2drop','marker' p]
                    ---
                </selftest>

code here!      here=pop() end-code // ( a -- ) 設定系統 dictionary 編碼位址
code here       push(here) end-code // ( -- a ) 系統 dictionary 編碼位址 a

                <selftest>
                    *** here! here, forth dictionary pointer
                    marker ~~~
                        marker ---
                        10000 here! here ( 10000 )
                        : dummy ; ' dummy js> pop().cfa 10000 >= ( true )
                        (forget)
                        ---
                        : dummy ; ' dummy js> pop().cfa 888 < ( true )
                        [d 10000,true,true d] [p 'here', 'here!', ">=", "<" p]
                        (forget)
                    ~~~ 
                </selftest>

\ JavaScript logical operations can be confusing
\ 在處理邏輯 operator 時我決定用 JavaScript 自己的 Boolean() 來 logicalize 所有的
\ operands, 這類共有 and or not 三者。為了保留 JavaScript && || 的功能 (邏輯一旦確
\ 立隨即傳回該 operand 之值) 另外定義 && || 遵照之，結果變成很奇特的功能。Forth 傳
\ 統的 AND OR NOT XOR 是 bitwise operators, 正好用傳統的大寫給它們。

code boolean    push(Boolean(pop())) end-code // ( x -- boolean(x) ) Cast TOS to boolean.
code and        var b=pop(),a=pop();push(Boolean(a)&&Boolean(b)) end-code // ( a b == a and b ) Logical and. See also '&&' and 'AND'.
code or         var b=pop(),a=pop();push(Boolean(a)||Boolean(b)) end-code // ( a b == a or b ) Logical or. See also '||' and 'OR'.
code not        push(!Boolean(pop())) end-code // ( x == !x ) Logical not. Capital NOT is for bitwise.
code &&         push(pop(1)&&pop()) end-code // ( a b == a && b ) if a then b else swap endif
code ||         tos(1) ? pop() : pop(1) end-code // ( a b == a || b ) if a then a else b endif
code AND        push(pop() & pop()) end-code // ( a b -- a & b ) Bitwise AND. See also 'and' and '&&'.
code OR         push(pop() | pop()) end-code // ( a b -- a | b ) Bitwise OR. See also 'or' and '||'.
code NOT        push(~pop()) end-code // ( a -- ~a ) Bitwise NOT. Small 'not' is for logical.
code XOR        push(pop() ^ pop()) end-code // ( a b -- a ^ b ) Bitwise exclusive OR.
code true       push(true) end-code // ( -- true ) boolean true.
code false      push(false) end-code // ( -- false ) boolean false.
code ""         push("") end-code // ( -- "" ) empty string.
code []         push([]) end-code // ( -- [] ) empty array.
code {}         push({}) end-code // ( -- {} ) empty object.
code undefined  push(undefined) end-code // ( -- undefined ) Get an undefined value.
code null       push(null) end-code // ( -- null ) Get a null value.
                /// 'Null' can be used in functions to check whether an argument is given.

                <selftest>
                    *** boolean and or && || not AND OR NOT XOR
                    undefined not \ true
                    "" boolean \ true false
                    and \ false
                    false and \ false
                    false or \ false
                    true or \ true
                    true and \ true
                    true or \ true
                    false or \ true
                    {} [] || \ true {}
                    [] && \ true []
                    swap \ [] true
                    && \ true
                    "" && \ true ""
                    not \ false
                    1 2 AND \ true 0
                    2 OR NOT  \ true -3
                    -3 = \ true true
                    1 2 XOR \ true true 3
                    0 XOR 3 = \ true true true
                    and and \ true
                    <js> function test(x){ return x }; test() </jsV> null = \ true true
                    [d true,true d] [p 'and', 'or', 'not', '||', '&&', 'AND', 'OR', 'NOT', 'XOR',
                    'true', 'false', '""', '[]', '{}', 'undefined', 'boolean', 'null' p] 
                </selftest>

\ Not eforth code words
\ 以下照理都可以用 eforth 的基本 code words 組合而成 colon words, 我覺得 jeforth 裡適合用 code word 來定義。

code +          push(pop(1)+pop()) end-code // ( a b -- a+b) Add two numbers or concatenate two strings.
code *          push(pop()*pop()) end-code // ( a b -- a*b ) Multiplex.
code -          push(pop(1)-pop()) end-code // ( a b -- a-b ) a-b
code /          push(pop(1)/pop()) end-code // ( a b -- c ) 計算 a 與 b 兩數相除的商 c
code 1+         push(pop()+1) end-code // ( a -- a++ ) a += 1
code 2+         push(pop()+2) end-code // ( a -- a+2 )
code 1-         push(pop()-1) end-code // ( a -- a-1 ) TOS - 1
code 2-         push(pop()-2) end-code // ( a -- a-2 ) TOS - 2

                <selftest>
                    *** + * - / 1+ 2+ 1- 2-
                    1 1 + 2 * 1 - 3 / 1+ 2+ 1- 2- 1 = [d true d]
                    [p '+', '*', '-', '/', '1+', '2+', '1-', '2-' p]
                </selftest>

code mod        push(pop(1)%pop()) end-code // ( a b -- c ) 計算 a 與 b 兩數相除的餘 c
code div        push(parseInt(pop(1)/pop())) end-code // ( a b -- c ) 計算 a 與 b 兩數相除的整數商 c

                <selftest>
                    *** mod 7 mod 3 is 1
                        7 3 mod [d 1 d] [p "mod" p]
                    *** div 7 div 3 is 2
                        7 3 div [d 2 d] [p "div" p]
                </selftest>

code >>         var n=pop();push(pop()>>n) end-code // ( data n -- data>>n ) Singed right shift
code <<         var n=pop();push(pop()<<n) end-code // ( data n -- data<<n ) Singed left shift
code >>>        var n=pop();push(pop()>>>n) end-code // ( data n -- data>>>n ) Unsinged right shift. Note! There's no <<<.

                <selftest>
                    *** >> -1 signed right shift n times will be still -1
                        -1 9 >> [d -1 d] [p ">>" p]
                    *** >> -4 signed right shift becomes -2
                        -4 1 >> [d -2 d] [p ">>" p]
                    *** << -1 signed left shift 63 times become the smallest int number
                        -1 63 << 0x80000000 -1 * = [d true d] [p "<<" p]
                    *** >>> -1 >>> 1 become 7fffffff
                        -1 1 >>> 0x7fffffff = [d true d] [p ">>>" p]
                </selftest>

code 0=         push(pop()==0) end-code // ( a -- f ) 比較 a 是否等於 0
code 0>         push(pop()>0) end-code // ( a -- f ) 比較 a 是否大於 0
code 0<>        push(pop()!=0) end-code // ( a -- f ) 比較 a 是否不等於 0
code 0<=        push(pop()<=0) end-code // ( a -- f ) 比較 a 是否小於等於 0
code 0>=        push(pop()>=0) end-code // ( a -- f ) 比較 a 是否大於等於 0
code =          push(pop()==pop()) end-code // ( a b -- a=b ) 經轉換後比較 a 是否等於 b, "123" = 123.

                <selftest>
                    *** 0= 0> 0<> 0 <= 0>=
                        "" 0= \ true
                        undefined 0= \ true false
                        1 0> \ true false true
                        0 0> \ true false true false
                        XOR -rot XOR + 2 = \ true
                        0<> \ false
                        0= \ true
                        0<> \ true
                        0<= \ true
                        0>= \ true
                        99 && \ 99
                        0= \ false
                        99 || 0<> \ true
                        -1 0<= \ true true
                        1 0>= \ true true true
                        s" 123" 123 = \ \ true true true true
                        [d true,true,true,true d]
                        [p '0=', '0>', '0<>', '0<=', '0>=', '=' p]
                </selftest>

code ==         push(Boolean(pop())==Boolean(pop())) end-code // ( a b -- f ) 比較 a 與 b 的邏輯
code ===        push(pop()===pop()) end-code // ( a b -- a===b ) 比較 a 是否全等於 b
code >          var b=pop();push(pop()>b) end-code // ( a b -- f ) 比較 a 是否大於 b
code <          var b=pop(); push(pop()<b) end-code // ( a b -- f ) 比較 a 是否小於 b
code !=         push(pop()!=pop()) end-code // ( a b -- f ) 比較 a 是否不等於 b
code !==        push(pop()!==pop()) end-code // ( a b -- f ) 比較 a 是否不全等於 b
code >=         var b=pop();push(pop()>=b) end-code // ( a b -- f ) 比較 a 是否大於等於 b
code <=         var b=pop();push(pop()<=b) end-code // ( a b -- f ) 比較 a 是否小於等於 b


                <selftest>
                    *** == compares after booleanized
                        {} [] == \ true
                        "" null == \ true
                        "" undefined == \ true
                        s" 123" 123 == \ true
                        [d true,true,true,true d] [p "==",'""',"null", "undefined" p]
                    *** === compares the type also
                        "" 0 = \ true
                        "" 0 == \ true
                        "" 0 === \ false
                        s" 123" 123 = \ true
                        s" 123" 123 == \ true
                        s" 123" 123 === \ false
                        [d true,true,false,true,true,false d]
                        [p "===" p]
                    *** > < >= <= != !== <>
                        1 2 > \ false
                        1 1 > \ false
                        2 1 > \ true
                        1 2 < \ true
                        1 1 < \ false
                        2 1 < \ fasle
                        1 2 >= \ false
                        1 1 >= \ true
                        2 1 >= \ true
                        1 2 <= \ true
                        1 1 <= \ true
                        2 1 <= \ fasle
                        1 1 <> \ false
                        0 1 <> \ true
                        [d false,false,true,true,false,false,false,true,true,true,true,false,false,true d]
                        [p '<', '>=', '<=', '!=', '!==', '<>' p]
                </selftest>

code abs        push(Math.abs(pop())) end-code // ( n -- |n| ) Absolute value of n.
code max        push(Math.max(pop(),pop())) end-code // ( a b -- max(a,b) ) The maximum.
code min        push(Math.min(pop(),pop())) end-code // ( a b -- min(a,b) ) The minimum.

                <selftest>
                    *** abs makes negative positive
                        1 63 << abs [d 0x80000000 d] [p "abs" p]
                    *** max min
                        1 -2 3 max max (  3 )
                        1 -2 3 min min ( -2 )
                        [d 3,-2 d] [p "max","min" p]
                </selftest>

code doVar      push(ip); ip=rstack.pop(); end-code compile-only private
                // ( -- a ) 取隨後位址 a , runtime of created words
code doNext     var i=rstack.pop()-1;if(i>0){ip=dictionary[ip]; rstack.push(i);}else ip++ end-code 
                compile-only
                // ( -- ) next's runtime.
code ,          comma(pop()) end-code // ( n -- ) Compile TOS to dictionary.

                <selftest>
                    *** doVar doNext
                    marker ---
                        variable x
                        : tt for x @ . x @ 1+ x ! next ;
                        js: vm.selftest_visible=false;vm.screenbuffer=""
                        10 tt space \ "0123456789 "
                        x @ ( 10 )
                        js: vm.selftest_visible=true
                        <js> vm.screenbuffer.slice(-11)=="0123456789 "</jsV> ( true )
                        [d 10,true d]
                        [p 'doNext','space', ',', 'colon-word', 'create',
                        'for', 'next' p]
                    ---
                </selftest>

code depth      ( -- depth ) \ Data stack depth
                push(stack.length) end-code
code pick       ( nj ... n1 n0 j -- nj ... n1 n0 nj ) \ Get a copy of a cell in stack.
                push(tos(pop())) end-code
                /// see rot -rot roll pick
code roll       ( ... n3 n2 n1 n0 3 -- ... n2 n1 n0 n3 )
                push(pop(pop())) end-code
                /// see rot -rot roll pick

                <selftest>
                    *** pick 2 from 1 2 3 gets 1 2 3 1
                        1 2 3 0 pick 3 = depth 4 = and >r 3 drops \ true
                        1 2 3 1 pick 2 = depth 4 = and >r 3 drops \ true
                        1 2 3 2 pick 1 = depth 4 = and >r 3 drops \ true
                        r> r> r> [d true,true,true d] [p "pick",">r","r>" p]
                    *** roll 2 from 1 2 3 gets 2 3 1
                        1 2 3 0 roll 3 = depth 3 = and >r 2 drops \ true
                        1 2 3 1 roll 2 = depth 3 = and >r 2 drops \ true
                        1 2 3 2 roll 1 = depth 3 = and >r 2 drops \ true
                        r> r> r> [d true,true,true d] [p "roll" p]
                </selftest>
code .          type(pop()); end-code // ( sth -- ) Print number or string on TOS.
: space         (space) . ; // ( -- ) Print a space.
code word       ( "delimiter" -- "token" <delimiter> ) \ Get next "token" from TIB.
                push(nexttoken(pop())) end-code
                /// First character after 'word' will always be skipped first, token separator.
                /// If delimiter is RegEx '\s' then white spaces before the "token"
                /// will be removed. Otherwise, return TIB[ntib] up to but not include the delimiter.
                /// If delimiter not found then return the entire remaining TIB (can be multiple lines!).

                <selftest>
                    *** word reads "string" from TIB
                    marker ---
                    char \s word    111    222 222 === >r s" 111" === r> and \ true , whitespace 會切掉
                    char  2 word    111    222 222 === >r s"    111    " === r> and \ true , whitespace 照收
                    : </div> ;
                    char </div> word    此後到 </ div> 之
                                前都被收進，可
                                以跨行！ come-find-me-!!
                    </div> js> pop().indexOf("come-find-me-!!")!=-1 \ true
                    [d true,true,true d] [p "word" p]
                    ---
                </selftest>

: [compile]     ' , ; immediate // ( <string> -- ) Compile the next immediate word.
                /// 把下個 word 當成「非立即詞」進行正常 compile, 等於是把它變成正常 word 使用。

: compile       ( -- ) \ Compile the next word at dictionary[ip] to dictionary[here].
                r> dup @ , 1+ >r ; compile-only 

                <selftest>
                    *** [compile] compile [ ]
                    marker ---
                    : iii ; immediate
                    : jjj ;
                    : test [compile] iii compile jjj ; \ 正常執行 iii，把 jjj 放進 dictionary
                    : use [ test ] ; \ 如果 jjj 是 immediate 就可以不要 [ ... ]
                    ' use js> pop().cfa @ ' jjj = [d true d]
                    [p "[compile]",'compile', '[', ']' p]
                    ---
                </selftest>

code colon-word ( -- ) \ Decorate the last() as a colon word.
                // last().type = "colon";
                last().cfa = here;
                last().xt = colonxt;
                end-code private

: create        ( <name> -- ) \ Create a new word. The new word is a variable by default.
                BL word (create) reveal colon-word compile doVar ;

code (marker)   ( "name" -- ) \ Create marker "name". Run "name" to forget itself and all newers.
                var lengthwas = current_word_list().length; // save current word list length before create the new marker word
                execute("(create)");execute("reveal");
                last().type = "marker";
                last().herewas = here;
                last().lengthwas = lengthwas; // [x] 引進 vocabulary 之後，此 marker 在只有 forth-wordlist 時使用。有了多個 word-list 之後要改寫。
                push(nexttoken('\n|\r')); // rest of the first line
                execute("parse-help"); // ( "helpmsg" "rests" )
                tib = " " + pop() + tib.slice(ntib); ntib = 0; // "rests" + tib(ntib)
                newhelp = pop();
                var h = newhelp; // help messages packed
                if(h.indexOf("No help message")!=-1) h = "( -- ) I am a marker. I forget everything after me.";
                last().help = /* newname + " " + */ h;
                last().xt = function(){ // marker's xt restores the saved context
                    here = this.herewas;
                    order = [current = context = "forth"]; // 萬一此 marker 在引入 vocabulary 之後被 call 到。
                    for(var vid in words) if(vid != "forth") delete words[vid]; // "forth" is the only one, clean up other word-lists.
                    words[current] = current_word_list().slice(0, this.lengthwas);
                    dictionary = dictionary.slice(0,here);
                    wordhash = {};
                    for (var i=1; i<current_word_list().length; i++){  // 從舊到新，以新蓋舊,重建 wordhash{} hash table.
                        wordhash[current_word_list()[i].name] = current_word_list()[i];
                    }
                }
                end-code
: marker        ( <name> -- ) \ Create marker <name>. Run <name> to forget itself and all newers.
                BL word (marker) ;
code next       ( -- ) \ for ... next (FigTaiwan SamSuanChen)
                comma(vm.tick("doNext")); // use original tick() to avoid warning
                dictionary[here++]=pop(); 
                end-code immediate compile-only 
code cls        ( -- ) \ Clear jeforth console screen
                vm.screenbuffer = (vm.screenbuffer==null) ? null : "";
                vm.clearScreen();
                end-code
code abort      reset() end-code // ( -- ) Reset the forth system.

code literal    ( n -- ) \ Compile TOS as an anonymous constant
                var literal = pop();
                var getLiteral = eval(
                        "var f;f=function(){push(literal)/*(" 
                        + mytypeof(literal) + ")" 
                        // avoid all "*/" and longer string
                        + literal.toString().slice(0,20).replace(/\*[/]/g,"*_/") 
                        + " */}"
                    );
                comma(getLiteral);
                end-code
code alias      ( Word <alias> -- ) \ Create a new name for an existing word
                var w = pop();
                // To use the correct TIB, must use execute("word") instead of dictate("word").
                execute("BL"); execute("word"); execute("(create)");execute("reveal");
                // mergeObj(last(), w); // copy everything by value from the predecessor includes arrays and objects.
                for(var i in w) last()[i] = w[i]; // copy from predecessor but arrays and objects are by reference
                last().predecessor = last().name;
                last().name = newname;
                last().type = "alias";
                end-code

                <selftest>
                    *** alias should create a new word that acts same
                    marker ---
                        1234 constant x ' x alias y
                        y [d 1234 d] [p "alias" p] 
                    ---
                </selftest>

\ ------------------ eforth colon words ---------------------------

' != alias <>   // ( a b -- f ) 比較 a 是否不等於 b, alias of !=.
' nonprivate alias public /// alias of nonprivate

code nip        pop(1) end-code // ( a b -- b ) 
code rot        push(pop(2)) end-code // ( w1 w2 w3 -- w2 w3 w1 ) 
                /// see rot -rot roll pick
code -rot       push(pop(),1) end-code // ( w1 w2 w3 -- w3 w1 w2 ) 
                /// see rot -rot roll pick
code 2drop      stack.splice(stack.length-2,2) end-code // ( ... a b -- ... )
: 2dup          ( w1 w2 -- w1 w2 w1 w2 ) over over ;
' NOT alias invert // ( w -- ~w )
: negate        -1 * ; // ( n -- -n ) Negated TOS.
: within         ( n low high -- within? ) -rot over max -rot min = ;

                <selftest>
                    *** nip rot -rot 2drop 2dup invert negate within
                    1 2 3 4 nip \ 1 2 4
                    -rot \ 4 1 2
                    2drop \ 4
                    3 2dup \ 4 3 4 3
                    invert negate \ 4 3 4 4
                    = rot rot \ true 4 3
                    5 within \ true true
                    1 2 3 within \ true true false
                    4 2 3 within \ true true false false
                    -2 -4 -1 within \ true true false false true
                    0 -4 -1 within \ true true false false true false
                    -5 -4 -1 within \ true true false false true false false
                    [d true,true,false,false,true,false,false d]
                    [p 'rot', '-rot', '2drop', '2dup', 'negate', 'invert', 'within' p]
                </selftest>

: [']           ( <name> -- Word ) \ In colon definitions, compile next word object as a literal.
                ' literal ; immediate compile-only

                <selftest>
                    *** ['] tick next word immediately
                    marker ---
                    : x ;
                    : test ['] x ;
                    test ' x = [d true d] [p "[']" p]
                    ---
                </selftest>

: allot         here + here! ; // ( n -- ) 增加 n cells 擴充 memory 區塊

                <selftest>
                    *** allot should consume some dictionary cells
                    marker ---
                    : a ; : b ; ' b :> cfa ' a :> cfa - \ normal distance
                    : aa ;
                    10 allot
                    : bb ; ' bb :> cfa ' aa :> cfa - \ 10 more expected
                    - abs [d 10 d] [p "allot" p]
                    ---
                </selftest>

: for           ( count -- ) \ for..next loop.
                compile >r here ; immediate compile-only
                /// for ... next (count ... 2,1) but when count <= 0 still do once!!
                /// for aft ... then next (count-1 ... 2,1) but do nothing if count <= 1.
                /// Pattern : The normalized for-loop pattern. 0 based.
                ///   : test ?dup if dup for dup r@ - ( COUNT i ) . space ( COUNT ) next drop then ; 
                ///   5 test ==> 0 1 2 3 4 
                /// Pattern : The normalized for-loop pattern. Count down
                ///   : test ?dup if for r@ . space next then ;
                ///   5 test ==> 5 4 3 2 1
                /// Pattern : Normalized for-loop pattern but n based.
                ///   : test js: push(tos()+3,0) for dup r@ - ( count+n i ) . space next drop ; 
                ///   5 test ==> 3 4 5 6 7 ; 1 test ==> 1 ; 0 test ==> nothing
                /// Pattern : Simplest, fixed times.
                ///   : test 5 for r@ . space next ; 
                ///   test ==> 5 4 3 2 1
                /// Pattern : fixed times and 0 based index
                ///   : test 5 for 5 r@ - . space next ; 
                ///   test ==> 0 1 2 3 4 
                /// Pattern of break : "r> drop 0 >r" or "js: rstack[rstack.length-1]=0"
                ///   : test 10 for 10 r@ - dup . space 5 >= if r> drop 0 >r then next ; 
                ///   test ==> 0 1 2 3 4 5 
                
: begin         ( -- a ) \ begin..again, begin..until, begin..while..until..then, begin..while..repeat
                here ; immediate compile-only
: until         ( a -- ) \ begin..until, begin..while..until..then,
                compile 0branch , ; immediate compile-only
: again         ( a -- ) \ begin..again,
                compile  branch , ; immediate compile-only

                <selftest>
                    *** begin again , begin until
                    marker ---
                    : tt
                        1 0 \ index sum
                        begin \ index sum
                            over \ index sum index
                            + \ index sum'
                            swap 1+ \ sum' index'
                            dup 10 > if \ sum' index'
                                drop
                                exit
                            then  \ sum' index'
                            swap  \ index' sum'
                        again
                    ; last execute 55 = \ true
                    : ttt
                        1 0 \ index sum
                        begin \ index sum
                            over \ index sum index
                            + \ index sum'
                            swap 1+ \ sum' index'
                            swap \ index' sum'
                        over 10 > until \ index' sum'
                        nip
                    ; last execute 55 = \ true
                    [d true,true d] [p 'again', 'until', 'over', 'swap', 'dup', 'exit', 'nip' p]
                    ---
                </selftest>

: if            ( -- a ) \ if..else..then, if..then
                compile 0branch here 0 , ; immediate compile-only
: ahead         ( -- a ) \ aft internal use
                compile branch here 0 , ; immediate compile-only
' ahead alias never immediate compile-only // ( -- a ) never ... then for call-back entry inner(word.cfa+n) 
: repeat        ( a a -- ) \ begin..while..repeat
                [compile] again here swap ! ; immediate compile-only
: then          ( a -- ) \ if....else..then, for aft...then next, begin..while..until..then
                here swap ! ; immediate compile-only
: aft           ( a -- a a ) \ for aft ... then next
                drop [compile] ahead [compile] begin swap ; immediate compile-only
: else          ( a -- a ) \ if..else..then
                [compile] ahead swap [compile] then ; immediate compile-only
: while         ( a -- a a ) \ begin..while..repeat, begin..while..until..then
                [compile] if swap ; immediate compile-only

                <selftest>
                    *** aft for then next ahead begin while repeat
                    marker ---
                    : tt 5 for r@ next ; last execute + + + + 15 = \ true
                    : ttt 5 for aft r@ then next ; last execute + + + 10 = \ true true
                    depth 2 = \ T T T
                    : tttt
                        0 0 \ index sum
                        begin \ idx sum
                            over 10 <=
                        while \ idx sum
                            over +
                            swap 1+ swap
                        repeat \ idx sum
                        nip
                    ; last execute 55 = \ T T T T
                    [d true,true,true,true d]
                    [p 'for', 'then', 'next', 'ahead', 'begin', 'while', 'repeat' p]
                    ---
                </selftest>

: char          ( <str> -- str ) \ Get character(s).
                BL word compiling if literal then ; immediate
                /// "char abc" gets "abc", Note! ANS forth "char abc" gets only 'a'.
: ?stop         if stop then ; // ( flag -- ) Stop TIB task if flag is true.
: ?dup          dup if dup then ; // ( w -- w w | 0 ) Dup TOS if it is not 0|""|false.

                <selftest>
                    *** ?dup dup only when it's true
                    1 0 ?dup \ 1 0
                    2 ?dup \ 1 0 2 2 
                    [d 1,0,2,2 d] [p "?dup" p]
                </selftest>

    \ case ... endcase definition is copied from 
    \ https://github.com/phf/forth/blob/master/x86/jonesforth.f
    \ Also thanks to FigTaiwan 吳政昌(亞斯) for the hints.

: case          ( -- 0 ) \ ( key ) case <case1> of <do case1> endof <do default> endcase 
                0 ; immediate compile-only
                /// Usage:
                /// ( key ) case 
                ///     char a of char AAAA endof
                ///     char b of char BBBB endof
                ///     char c of char CCCC endof
                ///     \ In default case, the key must be at TOS for being eaten by endcase 
                ///     char ???? swap 
                /// endcase

: of            ( -- ) \ ( key ) case <case1> of <do case1> endof <do default> endcase 
                ['] over , ['] = , [compile] if ['] drop , ; immediate compile-only
                /// see help case

: endof         ( -- ) \ ( key ) case <case1> of <do case1> endof <do default> endcase 
                [compile] else ; immediate compile-only
                /// see help case

: endcase       ( -- ) \ ( key ) case <case1> of <do case1> endof <do default> endcase 
                ['] drop , begin ?dup while [compile] then repeat ; immediate compile-only
                /// see help case

                <selftest>
                    *** case ... endcase 
                    marker ---
                    : test
                        case 
                            char a of char AAAA endof
                            char b of char BBBB endof
                            char c of char CCCC endof
                            \ In default case, the key must be at TOS for being eaten by endcase 
                            char ???? swap 
                        endcase ;
                    char a test \ ==> AAAA (string)
                    char b test \ ==> BBBB (string)
                    char c test \ ==> CCCC (string)
                    char d test \ ==> ???? (string)

                    [d 'AAAA','BBBB','CCCC','????' d]
                    [p 'case', 'of', 'endof', 'endcase' p]
                    ---
                </selftest>

: variable      ( <string> -- ) \ Create a variable.
                create 0 , [ char push(function(){last().type='colon-variable'}) jsEvalNo , ] ;
                
: +!            ( n addr -- ) \ Add n into addr, addr is a variable.
                swap over @ swap + swap ! ;
: ?             @ . ; // ( a -- ) print value of the variable.

                <selftest>
                    *** +! variable
                    marker ---
                    variable x 10 x !
                    5 x +! x @ ( 15 )
                    [d 15 d] [p 'variable', 'marker', '+!', '@', '!', '(' p]
                    ---
                </selftest>

: chars         ( n str -- ) \ Print str n times.
                swap 0 max dup 0= if exit then for dup . next drop ;

: spaces        ( n -- ) \ print n spaces.
                (space) chars ;

                <selftest>
                    *** spaces chars
                    marker ---
                    : test 3 spaces ;
                    js: vm.selftest_visible=false;vm.screenbuffer=""
                    test
                    js: vm.selftest_visible=true
                    <js> vm.screenbuffer.slice(-3)=='   '</jsV>
                    [d true d] [p 'chars',"spaces","(space)" p]
                    ---
                </selftest>

: .(            char \) word . BL word drop ; immediate // ( <str> -- ) Print following string down to ')' immediately.
: ."            ( <str> -- ) \ Print following string down to '"'.
                char " word compiling if literal compile .
                else . then BL word drop ; immediate
                \ 本來是 compile-only, 改成都可以。 hcchen5600 2014/07/17 16:40:04
: .'            ( <str> -- ) \ Print following string down to "'".
                char ' word compiling if literal compile .
                else . then BL word drop ; immediate
                \ 本來是 compile-only, 改成都可以。 hcchen5600 2014/07/17 16:40:04
: s"            ( <str> -- str ) \ Get string down to the next delimiter.
                char " word compiling if literal then BL word drop ; immediate
: s'            ( <str> -- str ) \ Get string down to the next delimiter.
                char ' word compiling if literal then BL word drop ; immediate
: s`            ( <str> -- str ) \ Get string down to the next delimiter.
                char ` word compiling if literal then BL word drop ; immediate
: does>         ( -- ) \ redirect the last new colon word.xt to after does>
                [compile] ret \ dummy 'ret' mark for 'see' to know where is the end of a creat-does word
                r> [ s" push(function(){push(last().cfa)})" jsEvalNo , ] ! ; 

                <selftest>
                    *** .( ( ." .' s" s' s`
                    marker ---
                    js: vm.selftest_visible=false;vm.screenbuffer=""
                    .( ff) ( now vm.screenbuffer should be 'ff' )
                    js> vm.screenbuffer.slice(-2)=="ff" \ true
                    : test ." aa" .' bb' s' cc' . s` dd` . s" ee" . ;
                    test js> vm.screenbuffer.slice(-10)=="aabbccddee" \ true
                    js: vm.selftest_visible=true
                    [d true,true d] [p '(', '."', ".'", "s'", "s`", 's"' p]
                    ---
                </selftest>

: count         ( string -- string length ) \ Get length of the given string
                [ s" push(function(){push(tos().length)})" jsEvalNo , ] ;

                <selftest>
                    *** count
                        s" abc" count depth
                        [d "abc",3,2 d] [p "count" p]
                </selftest>

code accept     push(false) end-code // ( -- str T|F ) Read a line from terminal. A fake before I/O ready.
: refill        ( -- flag ) \ Reload TIB from stdin. return 0 means no input or EOF
                accept if [ s" push(function(){tib=pop();ntib=0})" jsEvalNo , ] 1 else 0 then ;

: [else] ( -- ) \ 丟掉以下 TIB 到 "[else]" or "[then]" 為止，考慮了中間的 nested 結構。
                1 \ ( [if] structure nested level )
                begin \ level
                    begin \ ( level )
                        BL word count \ (level $word len ) 取出 [if] 之後 word 下一個 
                    while \ (level $word) 查看這個每個要丟掉的 word 做 nested 處裡。
                        dup s" [if]" = if \ ( level $word )
                            drop 1+ \ ( level' ) 如果這個 word 是 [if] 就把它丟掉，再進一層
                        else \ ( level $word ) 不是 [if] 那麼是否 [else]
                            dup s" [else]" = if \ (level $word)
                                drop \ ( level ) 丟掉 "[else]"
                                1- dup if 1+ then \ (level') level==1 時把它變成 0 準備走出 [if] 結構，
                                \ 其他 level 值則不變，繼續處理剩下的 [if] 結構。
                            else \ level $word, 不是 [else] 那麼是否 [then]
                                s" [then]" = if \ (level)
                                    1- \ level' \ (level') 如果這個 word 是 [then] 就剝掉一層
                                then \ (level')
                            then \ level'
                        then \ level'
                        \ 整個結構的正常出口在這裡
                        ?dup if else exit then 
                        \ 已經到最外層就離手走出 [if] 結構，否則繼續看下一個 word.
                    repeat \ (level) 回頭重來,看 TIB 裡下一個 word。
                    drop   \ (level) TIB 空了，把 null string 丟掉，留下 level。
                refill not until \ reload TIB 然後繼續
                \ level, TIB 斷尾了，可能是 ^z ^d 之類，做不下去了。
                drop \ 把 TIB 斷尾中止後剩下的 level 丟掉。
                ; immediate
                
: [if]          ( flag -- ) \ Conditional compilation [if] [else] [then]
                if else [compile] [else] then \ skip everything down to [else] or [then] when flag is not true.
                ; immediate
                /// [if] 用來把 iTIB 視條件跳到這個 [if] 之後或 [else] 之後。

: [then]        ( -- ) \ Conditional compilation [if] [else] [then]
                ; immediate
                
: js>           ( <expression> -- value ) \ Evaluate JavaScript <expression> which has no white space within.
                BL word compiling if jsFunc , else jsEval then  ; immediate
                /// Same thing as "s' blablabla' jsEval" but simpler. Return the last statement's value.
: js:           ( <expression> -- ) \ Evaluate JavaScript <expression> which has no white space within
                BL word compiling if jsFuncNo , else jsEvalNo then  ; immediate
                /// Same thing as "s' blablabla' jsEvalNo" but simpler. No return value.
: ::            ( obj <foo.bar> ) \ Simplified form of "obj js: pop().foo.bar" w/o return value
                BL word js> tos().charAt(0)=='['||tos().charAt(0)=='(' if char pop() else  char pop(). then 
                swap + compiling if jsFuncNo , else jsEvalNo then ; immediate
: :>            ( obj <foo.bar> ) \ Simplified form of "obj js> pop().foo.bar" w/return value
                BL word js> tos().charAt(0)=='['||tos().charAt(0)=='(' if char pop() else  char pop(). then 
                swap + compiling if jsFunc , else jsEval then ; immediate
: (             ( <str> -- ) \ Ignore the comment down to ')', can be nested but must be balanced
                js> nextstring(/\(|\)/).str \ word 固定會吃掉第一個 character 故不適用。
                drop js> tib[ntib++] \ 撞到停下來的字母非 '(' 即 ')' 要不就是行尾，都可以 skip 過去
                char ( = if \ 剛才那個字母是啥？
                    [ last literal ] dup \ 取得本身
                    execute \ recurse nested level
                    execute \ recurse 剩下來的部分
                then ; immediate 

                <selftest>
                    *** value and to work together
                    marker -%-%-%-%-%-
                    112233 value x x 112233 = \ true
                    445566 to x x 445566 = \ true
                    : test 778899 to x ; test x 778899 = \ true
                    -%-%-%-%-%-
                    [d true,true,true d] [p 'value','to' p]
                </selftest>
                
\ This word works fine. But doing this for letting doNext be a private is carried way too far.
\ : next        ( -- ) \ for ... next (FigTaiwan SamSuanChen)
\               ['] doNext , js: dictionary[here++]=pop() ; immediate compile-only
\               \ Redefine after js: and ['] to allow doNext be private

: "msg"abort    ( "errormsg" -- ) \ Panic with error message and abort the forth VM
                js: panic(pop()+'\n') abort ; nonprivate
                \ needed to compose variables into the errormsg

: abort"        ( <msg> -- ) \ Through an error message and abort the forth VM
                char " word literal BL word drop compile "msg"abort ;
                immediate compile-only

: "msg"?abort   ( "errormsg" flag -- ) \ Conditional panic with error message and abort the forth VM
                if "msg"abort else drop then ; nonprivate
                \ needed to compose variables into the errormsg

: ?abort"       ( f <errormsg> -- ) \ Conditional abort with an error message.
                char " word literal BL word drop
                compile swap compile "msg"?abort ;
                immediate compile-only

\ 其實所有用 word 取 TIB input string 的 words， 用 file 或 clipboard 輸入時， 都是可
\ 以跨行的！只差用 keyboard 輸入時受限於 console input 一般都是以「行」為單位的，造成
\ TIB 只能到行尾為止後面沒了，所以才會跨不了行。將來要讓 keyboard 輸入也能跨行時，就
\ 用 text。

\ 費了一番功夫寫就能 nested 的 <text> 及 <comment> , 開發心得在 Ynote 上
\ search "jeforth.3we design a nesting supported〈text〉also〈comment〉"

variable '<text> private
                // ( -- <text> ) Variable reference to the <text> Word object, for indirect call.
                    
: (<text>)      ( <text> -- "text"+"</text>" ) \ Auxiliary <text>, handles nested portion
                '<text> @ execute ( string ) \ 此時 TIB 非 </text> 即行尾
                BL word char </text> = ( string is</text>? )
                if \ 剛才撞上了 </text> ( string )
                    s" </text> " + ( string1' )
                then ; private
                /// (<text>) is almost same as <text> but it consumes the 
                /// next </text> in TIB and returns <text> + "</text>"

: <text>        ( <text> -- "text" ) \ Get multiple-line string, can be nested.
                char </text>|<text> word ( string1 )
                \ 撞到 delimiter 停下來非 <text> 即 </text> 要不就是行尾
                BL word dup char <text> = ( string1 deli is<text>? )
                if \ 剛才撞上了 <text> ( string1 deli )
                    drop s" <text> " + ( string1' )
                    (<text>) ( string1' string2 ) + 
                    [ last literal ] execute ( string1'' string3 ) + ( string )
                else \ 剛才撞上了 </text> 或行尾  ( string1 deli )
                    char </text> swap over = ( string1 "</text>" is</text>? ) 
                    if js: ntib-=pop().length ( string1 )
                    else drop then  ( string1 )
                then ; immediate last '<text> !
                /// If <text> hits <text> in TIB then it returns 
                /// string1 +  "<text>" + (<text>) + <text> 
                /// leaves the next </text> in TIB
                /// Colon definition 中萬一前後不 ballance 會造成 colon definition
                /// 不如預期結束而停留在 compiling state 裡等 closing </text> 的現象。
                
: </text>       ( "text" -- ... ) \ Delimiter of <text>
                compiling if literal then ; immediate
                /// Usage: <text> word of multiple lines </text>

\ Ready to add comment to 'privacy' 
<text> 
 Example 'privacy' definition for a vocabulary. Assume current == context.
 false constant privacy private // ( -- true ) All words in this module are public
 true  constant privacy private // ( -- true ) All words in this module are private
</text> ' privacy :: comment=pop()
                
\ If <comment> hits <comment> in TIB then it drops string1 
\ and does <comment> and does again <comment>

: <comment>     ( <comemnt> -- ) \ Can be nested
                char <comment>|</comment> word drop ( empty )
                BL word char <comment> = ( is<comment>? )
                if \ 剛才撞上了 <comment> ( empty )
                    [ last literal ] dup execute execute
                then ; immediate
                
: </comment>    ; // ( -- ) \ Delimiter of <comment>

                <selftest>
                    *** <comment>...</comment> can be nested now
                    <comment> 
                        aaaa <comment> bbbbbb </comment> cccccc 
                    </comment> 
                    111 222 <comment> 333 </comment> 444
                    [d 111,222,444 d] [p '<comment>', '</comment>', '::' p]
                </selftest>
                
: <js>          ( <js statements> -- "statements" ) \ Evaluate JavaScript statements
                char </js>|</jsV>|</jsN>|</jsRaw> word ; immediate

: </jsN>        ( "statements" -- ) \ No return value
                compiling if jsFuncNo , else jsEvalNo then ; immediate
                /// 可以用來組合 JavaScript function
                last alias </js>  immediate

: </jsV>        ( "statements" -- ) \ Retrun the value of last statement
                compiling if jsFunc , else jsEval then ; immediate
                /// 可以用來組合 JavaScript function

: trim          ( string -- string' ) \ Remove leading&ending white spaces of the multiple line string.
                \ remove 頭尾 whitespaces. 但 .trim() 舊 JScript v5.6 未 support
                dup if <js> pop().toString().replace(/(^\s*)/,'').replace(/(\s*$)/,'') </jsV>
                then ;
                /// If TOS is not a string then do nothing.
                /// NOT every line of a multiple line string, only the begin/end of it.
                /// Work with </o> </h> </e> 前置 white spaces 會變成 [object Text] 必須消除。

\ 2016/12/21 Now constant & value support private and direct-access through vm[vid].name 
: constant      ( n <name> -- ) \ Create a 'constnat'
                BL word (create) <js> 
                    last().type = "constant";
                    var s = '(function(){push(vm["_vid_"]["_name_"])})';
                    var vid = current.replace(/"/g,"\\\"");
                    var name = last().name.replace(/"/g,"\\\"");
                    s = s.replace(/_vid_/,vid).replace(/_name_/,name);
                    last().xt = eval(s);
                    if(vm[current]==undefined) vm[current]={};
                    vm[current][last().name] = pop();
                </js> reveal ; 
                
: value         ( n <name> -- ) \ Create a 'value' variable.
                constant last :: type='value' ; 
                
: to            ( n <value> -- ) \ Assign n to <value>.
                ' ( n word ) 
                <js> if (tos().type!="value") panic("Error! Assigning to a none-value.\n",'error') </js>
                compiling if ( n word ) 
                    <text>
                        (function(){/* to */ vm["_vid_"]["_name_"]=pop()})
                    </text> trim ( n word s ) 
                    <js> 
                        var s = pop(); // ( n word )
                        var vid = tos().vid.replace(/"/g,"\\\"");
                        var name = pop().name.replace(/"/g,"\\\"");
                        s = s.replace(/_vid_/,vid).replace(/_name_/,name);
                        push(eval(s));
                    </js> ( n xt ) , 
                else ( n word )
                    js: vm[tos().vid][pop().name]=pop()
                then ; immediate
                
                <selftest>
                    *** constant value and to
                    marker ---
                    112233 constant x
                    x value y
                    x y = \ true
                    332211 to y x y = \ false
                    ' x :> type=="constant" \ true
                    ' y :> type=="value" \ true
                    [d true,false,true,true d] [p "constant","value","to" p]
                    ---
                </selftest>

\ 目前 Base 切換只影響 .r .0r 的輸出結果。
\ JavaScript 輸入用外顯的 0xFFFF 形式，用不著 hex decimal 切換。
10 value base // ( -- base ) decimal base is 10, hex base is 16, can be any number.
code hex        vm.forth.base=16 end-code // ( -- ) 設定數值以十六進制印出 *** 20111224 sam
code decimal    vm.forth.base=10 end-code // ( -- ) 設定數值以十進制印出 *** 20111224 sam
code base@      push(vm.forth.base) end-code // ( -- n ) 取得 base 值 n *** 20111224 sam
code base!      vm.forth.base=pop() end-code // ( n -- ) 設定 n 為 base 值 *** 20111224 sam

                <selftest>
                    *** hex decimal base@ base!
                        decimal base@ 0x0A = \ true
                        10 0x10 = \ false
                        hex base@ 0x10 = \ true
                        10 0x10 = \ false !!!! JavaScript 輸入用外顯的表達 10 就是十不會變，這好！
                        0x0A base!
                        base@ 10 = \ true
                        [d true,false,true,false,true d]
                        [p 'decimal','base@', 'base!', 'base' p]
                </selftest>

: sleep         ( mS -- ) \ Suspend to idle, resume after mS. Can be 'stopSleeping'.
                [ last literal ] ( mS me )
                <js>
                    function resume() { 
                        if (!me.timeoutId) return; // 萬一想提前結束時其實已經 timeout 過了則不做事。
                        delete(vm.g.setTimeout.registered()[me.timeoutId.toString()]);
                        tib = tibwas; ntib = ntibwas; me.timeoutId = null;
                        outer(ipwas); // resume to the below ending 'ret' and then go through the TIB.
                    }
                    var tibwas=tib, ntibwas=ntib, ipwas=ip, me=pop(), delay=pop();
                    me.resume = resume; // So resume can be triggered from outside
                    if (me.timeoutId) {
                        panic("Error! double 'sleep' not allowed, use 'nap' instead.\n",true)
                    } else {
                        tib = ""; ntib = ip = 0; // ip = 0 reserve rstack, suspend the forth VM 
                        me.timeoutId = vm.g.setTimeout(resume,delay);
                    }
                </js> ;
                /// 為了要能 stopSleeping 引入了 sleep.timeoutId 致使多重 sleeping 必須禁止。
                /// 另設有不可中止的 nap 命令可以多重 nap.

code stopSleeping ( -- ) \ Resume forth VM sleeping state, opposite of the sleep command.
                clearTimeout(tick('sleep').timeoutId);
                tick('sleep').resume();
                end-code

: nap           ( mS -- ) \ Suspend to idle, resume after mS. Multiple nap is allowed.
                <js>
                    var tibwas=tib, ntibwas=ntib, ipwas=ip, delay=pop();
                    tib = ""; ntib = ip = 0; // ip = 0 reserve rstack, suspend the forth VM 
                    setTimeout(resume,delay);
                    function resume() { 
                        if(typeof(tib)!="undefined") {
                            tib = tibwas; ntib = ntibwas;
                        } else debugger;
                        outer(ipwas); // resume to the below ending 'ret' and then go through the TIB.
                    }
                </js> ;
                /// nap 沒有保留外顯的 timeoutId 故不能中止，但也不會堆積在 vm.g.setTimeout.registered() 裡。

: cr            js: type("\n") ; // ( -- ) 到下一列繼續輸出 *** 20111224 sam
                \ 個別 quit.f 裡重定義成 : cr js: type("\n") 1 nap js: window.scrollTo(0,endofinputbox.offsetTop) ;

code cut        ( -- ) \ Cut off used TIB.
                tib=tib.slice(ntib);ntib=0 end-code
                /// "cut ~ 10 nap rewind" repeat running the TIB.
                /// See also <task>

: -word         ( -- array[] ) \ Get TIB used tokens.
                <js> var a=('h '+tib.substr(0,ntib)+' t').split(/\s+/); // 加上 dummy 頭尾再 split 以統一所有狀況。
                a.pop(); a.shift(); /* 丟掉 dummy 頭尾巴 */ a</jsV> ;
                /// 跟 word 有點相反的味道，故以 -word 為名。

: rewind        ( -- ) \ Rewind TIB so as to repeat it. 'stop' to terminate.
                -word <js> var a=pop(),flag=false; for(var i in a) flag = flag || a[i]=='nap'; flag </jsV>
                not ?abort" Warning! no 'nap' in command line, suspicious of infinite loop." js: ntib=0 ;
                /// "cut ~ 10 nap rewind" repeat running the TIB.
                /// See also <task>
                
: ?rewind       ( boolean -- ) \ Conditional rewind TIB so as to repeat it. 'stop' to terminate.
                if rewind then ;

\ To TIB command line TSRs, the tib/ntib is their only private storage. So save-restore and
\ loop back information must be using the tib. That's why we have >t t@ and t> 

code >t         ( int -- ) \ Push the integer to end of TIB as a comment
                tib += "\n\\ " + String.fromCharCode(pop());
                end-code

code t@         ( -- int ) \ Get integer from end of the TIB 
                var value = tib.charCodeAt(tib.length-1);
                push(value); 
                end-code

: t>            ( -- int ) \ Pop integer from end of the TIB 
                t@ ( int ) js: tib=tib.slice(0,-4) ;
                \ the -4 is \n \ space and the int, total 4.

: [begin]       ( -- ) \ [begin]..[again], [begin].. flag [until]
                js> ntib >t ; interpret-only
                /// Don't forget some nap.
                /// 'stop' command or {Ctrl-Break} hotkey to abort.
                /// ex. [begin] .s js> rstack . cr 1000 nap [again]
                
: [again]       ( -- ) \ [begin]..[again]
                t@ js: ntib=pop() ; interpret-only
                /// Don't forget some nap.
                /// 'stop' command or {Ctrl-Break} hotkey to abort.


: [until]       ( flag -- ) \ [begin].. flag [until]
                if  t> drop else [compile] [again] then ; interpret-only
                /// Don't forget some nap.
                /// 'stop' command or {Ctrl-Break} hotkey to abort.
                /// ex. [begin] now t.second dup . space 5 mod not 100 nap [until]

: [for]         ( count -- ) \ (T -- ntib count ) [for]..[next] 
                [compile] [begin] >t ; interpret-only
                /// Instead of using rstack, [for] loop uses tib tail to save-restore 
                /// the loop back address and the count. Thus >t t> and t@ replace
                /// >r r> and r@ respectively.
                /// Pattern : The normalized for-loop pattern. 0 based.
                ///   5 ?dup [if] dup [for] dup t@ - ( COUNT i ) . space ( COUNT ) [next] drop [then]
                ///   ==> 0 1 2 3 4
                /// Pattern : Normalized for-loop pattern but n(66) based.
                ///   5 js: push(tos()+66,0) [for] dup t@ - ( count+n i ) . space [next] drop
                ///   ==> 66 67 68 69 70  OK        
                /// Pattern : Simplest, fixed times.
                ///   5 [for] t@ . space [next]
                ///   ==> 5 4 3 2 1
                /// Pattern : fixed times and 0 based index
                ///   5 [for] 5 t@ - . space [next]
                ///   ==> 0 1 2 3 4
                /// Pattern of break : "t> drop 0 >t" or "js: rstack[rstack.length-1]=0"
                ///   10 [for] 10 t@ - dup . space 5 >= [if] t> drop 0 >t [then] [next]
                ///   ==> 0 1 2 3 4 5
                /// Don't forget some nap.
                /// 'stop' command or {Ctrl-Break} hotkey to abort.

: [next]        ( -- ) \ (T ntib count -- ntib count-1 | empty ) [for]..[next]
                t> 1- dup >t js> pop()>0 ( count>0 ) if 
                    \ rewind
                    t> t> js: ntib=tos() >t >t 
                else
                    \ exit the for loop
                    t> t> 2drop \ drop the count and loop back ntib address
                then ; interpret-only
                /// Don't forget some nap.
                /// 'stop' command or {Ctrl-Break} hotkey to abort.

code (run:)     ( "..if.." -- "..[if].." ) \ Run string with "if","begin","for" in interpret mode
                var ss = pop();
                var result = ss
                    .replace(/(^|\s)(if|else|then|begin|again|until|for|next)(\s|$)/mg,"$1[$2]$3")
                    .replace(/(^|\s)(if|else|then|begin|again|until|for|next)(\s|$)/mg,"$1[$2]$3");
                    // 連做兩次解決 if else then 翻成 [if] else [then] 的現象。 
                push(result);execute("tib.insert"); // 不能用 dictate(), 多重 suspend 時，會有怪現象。
                end-code
                /// Replace "if", "for", "begin", .. etc to "[if]", "[for]", "[beign]" .. etc
                /// I like to use "if" in interpret mode directly instead of "[if]" and
                /// to merge them is difficult to me so far. So I defined this word.
: run:          ( <string> -- ... ) \ Run one-liner with "if","begin","for", in interpret mode
                CR word (run:) ; interpret-only
                /// To run multiple lines use <text>...</text> (run:) or "run>" instead of "run:".
                /// run: is oneliner. I think run: may be used in ~.f files while run> certainly can't.
: run>          ( <string> -- ... ) \ Run multiple lines with "if","begin","for", in interpret mode
                js> push(ntib);ntib=tib.length;tib.slice(pop()) (run:) ; interpret-only
                /// run> go through all the rest of the inputbox; 
                /// run: is oneliner. I think run: may be used in ~.f files while run> certainly can't.

\ ------------------ Tools  ----------------------------------------------------------------------
                
code int        push(parseInt(pop())) end-code   // ( float|string -- integer|NaN )
code float      push(parseFloat(pop())) end-code // ( string -- float|NaN ) 

                <selftest>
                    *** int 3.14 is 3, 12.34AB is 12
                    3.14 int char 12.34AB int
                    [d 3,12 d] [p "int" p]
                </selftest>

: random        ( -- 0~1 )
                js> Math.random() ;

                <selftest>
                    *** random is (0...1)
                    random 0 > random 1 < and
                    random 0 > random 1 < and
                    random 0 > random 1 < and
                    random 0 > random 1 < and
                    [d true,true,true,true d] [p "random" p]
                </selftest>

: nop           ; // ( -- ) No operation.
: drops         ( ... n -- ... ) \ Drop n cells from data stack.
                1+ js> stack.splice(stack.length-tos(),pop()) drop ;
                /// We need 'drops' <js> sections in a colon definition are easily to have
                /// many input arguments that need to be dropped.

                <selftest>
                    *** drops n data stack cells ...
                        1 2 3 4 5 2 drops [d 1,2,3 d] [p "drops" p]
                </selftest>

\ JavaScript's hex is a little strange.
\ Example 1: -2 >> 1 is -1 correct, -2 >> 31 is also -1 correct, but -2 >> 32 become -2 !!
\ Example 2: -1 & 0x7fffffff is 0x7fffffff, but -1 & 0xffffffff will be -1 !!
\ That means hex is 32 bits and bit 31 is the sign bit. But not exactly, because 0xfff...(over 32 bits)
\ are still valid numbers. However, my job is just to print hex correctly by using .r and
\ .0r. So I simply use a workaround that prints higher 16 bits and then lower 16 bits respectively.
\ So JavaScript's opinion about hex won't bother me anymore.

code (.r)       ( num|str n -- "  num|str" ) \ Right adjusted num|str in n characters (FigTaiwan SamSuanChen)
                var n=pop(); var i=pop();
                if(typeof i == 'number') {
                    if(vm.forth.base == 10){
                        i=i.toString(vm.forth.base);
                    }else{
                        i = (i >> 16 & 0xffff || "").toString(vm.forth.base) + (i & 0xffff).toString(vm.forth.base);
                    }
                }
                n=n-i.length;
                if(n>0) do {
                    i=" "+i;
                    n--;
                } while(n>0);
                push(i);
                end-code
                
: .r            ( num|str n -- ) \ Print right adjusted num|str in n characters (FigTaiwan SamSuanChen)
                (.r) . ;
                
code (.0r)      ( num|str n -- "0000num|str" ) \ Right adjusted print num|str in n characters (FigTaiwan SamSuanChen)
                var n=pop(); var i=pop();
                var minus = "";
                if(typeof i == 'number') {
                    if(vm.forth.base == 10){
                        if (i<0) minus = '-';
                        i=Math.abs(i).toString(vm.forth.base);
                    }else{
                        i = (i >> 16 & 0xffff || "").toString(vm.forth.base) + (i & 0xffff).toString(vm.forth.base);
                    }
                }
                n=n-i.length - (minus?1:0);
                if(n>0) do {
                    i="0"+i;
                    n--;
                } while (n>0);
                // type(minus+i);
                push(minus+i);
                end-code
                
: .0r           ( num|str n -- ) \ Right adjusted print num|str in n characters (FigTaiwan SamSuanChen)
                (.0r) . ;
                /// Negative numbers are printed in a strange way. e.g. "0000-123".

                <selftest>
                    <comment> .r 是 FigTaiwan 爽哥那兒抄來的。 JavaScript 本身就有 
                    number.toString(base) 可以任何 base 印出數值。base@ base! hex 
                    decimal 等只對 .r .0r 有用。輸入時照 JavaScript 的慣例，數字就
                    是十進位，0x1234 是十六進位，已經足夠。 .r .0r 很有用, .s 的定
                    義就是靠他們。
                    </comment>
                    *** .r .0r can print hex-decimal
                    marker ---
                    js: vm.selftest_visible=false;vm.screenbuffer=""
                    decimal  -1 10  .r <js> vm.screenbuffer.slice(-10)=='        -1'</jsV> \ true
                    hex      -1 10  .r <js> vm.screenbuffer.slice(-10)=='  ffffffff'</jsV> \ true
                    decimal  56 10 .0r <js> vm.screenbuffer.slice(-10)=='0000000056'</jsV> \ true
                    hex      56 10 .0r <js> vm.screenbuffer.slice(-10)=='0000000038'</jsV> \ true
                    decimal -78 10 .0r <js> vm.screenbuffer.slice(-10)=='-000000078'</jsV> \ true
                    hex     -78 10 .0r <js> vm.screenbuffer.slice(-10)=='00ffffffb2'</jsV> \ true
                    js: vm.selftest_visible=true
                    [d true,true,true,true,true,true d] 
                    [p 'decimal', 'hex', '.0r', '.r' p]
                    ---
                </selftest>

code dropall    stack=[] end-code // ( ... -- ) Clear the data stack.

                <selftest>
                    *** dropall clean the data stack
                    1 2 3 4 5 dropall depth 0= [d true d] [p "dropall","0=" p]
                </selftest>

code (ASCII)    push(pop().charCodeAt(0)) end-code // ( str -- ASCII ) Get str[0]'s ASCII code.
code ASCII>char ( ASCII -- 'c' ) \ ASCII code number to character
                push(String.fromCharCode(pop())) end-code
                /// 65 ASCII>char tib. \ ==> A (string)
: ASCII         ( <str> -- ASCII ) \ Get <str>[0]'s ASCII code.
                BL word (ASCII) compiling if literal then
                ; immediate

                <selftest>
                    *** ASCII (ASCII) ASCII>char
                    marker ---
                    char abc (ASCII) ( 97 )
                    98 ASCII>char ( b )
                    : test ASCII c ; test ( 99 )
                    [d 97,'b',99 d] [p '(ASCII)', 'ASCII>char', "ASCII" p]
                    ---
                </selftest>

code .s         ( ... -- ... ) \ Dump the data stack.
                var count=stack.length, basewas=vm.forth.base;
                if(count>0) for(var i=0;i<count;i++){
                    if (typeof(stack[i])=="number") {
                        push(stack[i]); push(i); dictate("decimal 7 .r char : . space dup decimal 11 .r space hex 11 .r char h .");
                    } else {
                        push(stack[i]); push(i); dictate("decimal 7 .r char : . space .");
                    }
                    type(" ("+mytypeof(stack[i])+")\n");
                } else type("empty\n");
                vm.forth.base = basewas;
                end-code

                <selftest>
                    *** .s is probably the most used word
                    marker ---
                    js: vm.selftest_visible=false;vm.screenbuffer=""
                    32424 -24324 .s
                    js: vm.selftest_visible=true
                    <js> vm.screenbuffer.indexOf('32424')    !=-1 </jsV> \ true
                    <js> vm.screenbuffer.indexOf('7ea8h')    !=-1 </jsV> \ true
                    <js> vm.screenbuffer.indexOf('-24324')   !=-1 </jsV> \ true
                    <js> vm.screenbuffer.indexOf('ffffa0fch')!=-1 </jsV> \ true
                    <js> vm.screenbuffer.indexOf('2:')       ==-1 </jsV> \ true
                    [d 32424,-24324,true,true,true,true,true d] [p ".s" p]
                    ---
                </selftest>

code wordhash>array ( "vid" -- array ) \ Retrive a VID list from the recent active words hash
                var vid=pop(), aa = [], bb = [], j=1; // vid[0] always 0, start from 1.
                // get the raw list
                for (var i in wordhash) 
                    if (wordhash[i].vid==vid) aa.push(wordhash[i]);
                // sort aa by wid to be bb
                while (aa.length) { 
                    for (i=0; i<aa.length; i++) {
                        if (aa[i].wid<=j) {
                            bb.push(aa.splice(i,1)[0]);
                            break;
                        }
                    }
                    if (vm.debug && i>=aa.length) 
                        // warning, rare case like ' code.wid is 7 because reDef'ed
                        debugger; 
                    j += 1;
                }
                push(bb);
                end-code
                
: word_select   ( "vid" "pattern" "option" -- word[] ) \ Get an array of words, name/help/comments screened by pattern.
                rot dup wordhash>array ( "pattern" "option" "vid" array )
                <js> 
                var word_list = pop();
                var vid = pop();
                var option = pop();
                var pattern = pop();
                var result = [];
                var isContext = order[order.length-1] == vid;
                // Remove private words unless in context
                // for (var i=0; i<words[vid].length; i++) {
                //     if (isContext || !words[vid][i].private) 
                //         word_list.push(words[vid][i]);
                // }
                for(var i=0; i<word_list.length; i++) {
                    if (!pattern) { 
                        // no pattern is all public
                        result.push(word_list[i]); 
                        continue; 
                    } 
                    switch(option){ 
                        // 這樣寫表示這些 option 都是唯一的。
                        case "-t": // -t for matching type pattern, case insensitive.
                            if (word_list[i].type.toLowerCase().indexOf(pattern.toLowerCase()) != -1 ) {
                                result.push(word_list[i]);
                            }
                            break;
                        case "-T": // -T for matching type pattern exactly.
                            if (word_list[i].type==pattern) {
                                result.push(word_list[i]);
                            }
                            break;
                        case "-n": // -n for matching only name pattern, case insensitive.
                            if (word_list[i].name.toLowerCase().indexOf(pattern.toLowerCase()) != -1 ) {
                                result.push(word_list[i]);
                            }
                            break;
                        case "-f": // -f for fuzzy search in name, help, and comment.
                            var flag =  (word_list[i].name.toLowerCase().indexOf(pattern.toLowerCase()) != -1 ) ||
                                        ((word_list[i].help||"").toLowerCase().indexOf(pattern.toLowerCase()) != -1 ) ||
                                        ((word_list[i].comment||"").toLowerCase().indexOf(pattern.toLowerCase()) != -1);
                            if (flag) {
                                result.push(word_list[i]);
                            }
                            break;
                        default: // any other option, includes -N, for exactly name only, case sensitive.
                            if (word_list[i].name==pattern) {
                                result = [word_list[i]];
                            }
                    }
                }
                push(result); </js> ;
                /// Options: 
                /// -f pattern matches all names, helps and comments. Case insensitive.
                /// -n pattern in name. Case insensitive.
                /// -t pattern in type. Case insensitive. 
                /// -T pattern is exact type.
                /// "" pattern is exact name. 


: words         ( <["pattern" [-t|-T|-n|-f]]> -- ) \ List all words or words screened by spec.
                js> context CR word ( forth line )
                <js> pop().replace(/\s+/g," ").split(" ")</jsV> ( forth [pattern,option,rests] )
                js> tos()[0] swap js> tos()[1] nip word_select <js>
                    var word_list = pop();
                    var w = "";
                    for (var i=0; i<word_list.length; i++) w += word_list[i].name + " ";
                    type(w);
                </js> ;
                /// Original version in jeforth.f
                last :: comment+=tick("word_select").comment
                /// An empty pattern matches all words.

: (help)        ( "word-list" "[pattern [-t|-T|-n|-f]]" -- "msg" ) \ Get help message of screened words
                <js> pop().replace(/\s+/g," ").split(" ")</jsV> ( voc [pattern,option,rests] )
                js> tos()[0] swap js> tos()[1] nip ( forth pattern option ) word_select ( [words...] )
                <js>
                    var word_list = pop();
                    for (var ss="",i=0; i<word_list.length; i++) {
                        ss += word_list[i]+"\n"; // help of the word
                        if (typeof(word_list[i].comment) != "undefined") ss += word_list[i].comment;
                    };ss
                </jsV> ;
                /// Original version in jeforth.f
                last :: comment+=tick("word_select").comment

: help          ( <["pattern" [-t|-T|-n|-f]]> -- ) \ Print the help of screened words
                js> context CR word ( voc pattern )
                js> tos().length if 
                    dup char * = if drop "" then (help) .
                else
                    2drop version drop
                    [ \ 先存起來,供往後新版引用.
                        <text>
                        
                            Basic commands that bring you the whole jeforth world.
                            
                            -- words --
                            Try 'words' command to view all words. It has following options:
                            > words [<pattern> [-n|-N|-t|-T]] 
                            that prints not all but matched words. Try,
                            > help words
                            to view more help of 'words' command. 
                            
                            -- help --
                            You are viewing 'help' now. Yet it has more options, try
                            > help  [<pattern> [-n|-N|-t|-T]]
                            that prints the help of matched words.
                            > help *
                            that prints all words' help.
                            
                            -- see --
                            Use 'see' command to view the definition of a word.
                            > see <word> 
                        </text> <js> pop().replace(/^[ \t]*/gm,'')</jsV> 
                        last :: general_help=pop()
                        last literal
                    ] :> general_help . cr
                then ;
                /// Original version in jeforth.f
                last :: comment+=tick("word_select").comment
                /// A pattern of star '*' matches all words.
                /// Example: 
                ///   help * <-- show help of all words
                ///   help * -N <-- show help of '*' command
                \ 2016/2/2 改成以原來 -N 為默認 option. -N 未定義屬 default 結果還是原來 -N 的效果。
                
                <selftest>
                    <text>
                    本來 words help 都接受 RegEx 的，可是不好用。現已改回普通 non RegEx pattern. 只動
                    word_select 就可以來回修改成 RegEx/non-RegEx.
                    </text> drop

                    *** help words word_select
                    marker ---
                    : test ; // testing help words and word_select 32974974
                    /// 9247329474 comment
                    js: vm.selftest_visible=false;vm.screenbuffer=""
                    \ help test -N
                    help test
                    <js> vm.screenbuffer.indexOf('32974974') !=-1 </jsV> \ true
                    <js> vm.screenbuffer.indexOf('9247329474') !=-1 </jsV> \ true
                    words 9247329474 -f
                    <js> vm.screenbuffer.indexOf('test') !=-1 </jsV> \ true
                    words test -f
                    <js> vm.screenbuffer.indexOf('<selftest>') !=-1 </jsV> \ true
                    <js> vm.screenbuffer.indexOf('***') !=-1 </jsV> \ true
                    js: vm.selftest_visible=true;
                    [d true,true,true,true,true d] [p 'word_select', 'words' p]
                    ---
                </selftest>

code bye        ( ERRORLEVEL -- ) \ Exit to shell with TOS as the ERRORLEVEL.
                // 這些都無效，最後靠 WMI 達成傳回 errorlevel // var errorlevel = pop(); window.errorlevel = typeof(errorlevel)=='number' ? errorlevel : 0; 
                vm.bye();
                end-code

code readTextFile ( "pathname" -- string ) \ Return a string, "" if failed
                try {
                    var data = vm.readTextFile(pop()); 
                } catch (err) {
                    data = "";
                }
                push(data);
                end-code

: readTextFileAuto ( "pathname" -- string ) \ Search and read, panic if failed.
                js> vm.path.slice(0) \ this is the way javascript copy array by value
                over char readTextFile execute ( call by name for 3ce's reDef'ed readTextFile )
                js> tos()!="" if nip nip exit then drop
                js> tos().length for aft ( -- fname [path] )
                    js> tos().pop()+'/'+tos(1) 
                    char readTextFile execute 
                    js> tos()!=""
                    if ( -- fname [path] file )
                        nip nip r> drop exit \ for..next loop 裡面不能光 exit !!!
                    then drop ( -- fname [path] )
                then next ( -- fname [path] )
                drop "" swap <js> panic("Error! File " + pop() + " not found!\n",true) </js> ;

code writeTextFile ( string "pathname" -- ) \ Write string to file. Panic if failed.
                vm.writeTextFile(pop(),pop())
                end-code

\ code tib.append   ( "string" -- ) \ Append the "string" to TIB
\               tib += " " + (pop()||""); end-code
\               /// VM suspend-resume doesn't allow multiple levels of dictate() so
\               /// we need tib.append or tib.insert.

code tib.append ( "string" -- ) \ Append the "string" to TIB
                tib = tib.slice(ntib); ntib = 0;
                tib += " " + (pop()||""); end-code
                /// VM suspend-resume doesn't allow multiple levels of dictate() so
                /// we need tib.append or tib.insert.

                <comment>
                    靠！ tib.append 沒辦法測呀！到了 terminal prompt 手動這樣測，
                    OK 111 s" 12345" tib.append 222
                    OK .s
                        0:         111          6fh (number)
                        1:         222          deh (number)
                        2:       12345        3039h (number) <=== appended to the ending
                </comment>

\ code tib.insert   ( "string" -- ) \ Insert the "string" into TIB
\               var before = tib.slice(0,ntib), after = tib.slice(ntib);
\               tib = before + " " + (pop()||"") + " " + after; end-code
\               /// VM suspend-resume doesn't allow multiple levels of dictate() so
\               /// we need tib.append or tib.insert.

code tib.insert ( "string" -- ) \ Insert the "string" into TIB
                tib = tib.slice(ntib); ntib = 0;
                tib = (pop()||"") + " " + tib; end-code
                /// VM suspend-resume doesn't allow multiple levels of dictate() so
                /// we need tib.append or tib.insert.

\ 沒有 readTextFile 但可以改用 <scr ipt></scr ipt>
\ : sinclude.js   ( "pathname" -- ) \ Include JavaScript source file
\                 readTextFileAuto js: eval(pop()) ;
\ : include.js    ( <pathname> -- ) \ Include JavaScript source file
\                 BL word sinclude.js ;

                char -=EOF=- ( eof ) <js> (new RegExp(tos()))</jsV> ( eof /eof/ )
                js> ({regex:pop(),pattern:pop()}) constant EOF // ( -- {regex,pattern} ) End of file pattern and RegExp
                
\ : sinclude     ( "pathname" -- ... ) \ Lodad the given forth source file.
\                 readTextFileAuto ( file )
\                 <js> 
\                     var s = pop();
\                     var ss = (s+'x').slice(0,s.search(vm.forth.EOF.regex))
\                              + '\n\\ '
\                              + vm.forth.EOF.pattern
\                              + '\n';
\                     // The +'x' is a perfect trick, will be cut both EOF mark exists or not. 
\                     // The last \n 避免最後是 \ comment 時吃到後面來
\                     if (s) push(ss); else push(""); // skip if file not found
\                 </js> 
\                 tib.insert ;
\                 /// Cut after EOF and append EOF back to guarantee an EOF exists
\                 /// So, if a ~.f file is copy-paste to jeforth.3we input box, 
\                 /// instead of through sinclude, then EOF not found will be a problem 
\                 /// when it is expected in, i.e. source-code-header. Add EOF manually
\                 /// is the solution.

: sinclude      ( "textareaID" -- ... ) \ Lodad the given forth source textarea (proeforth).
                <js> 
                    s = document.getElementById(pop()).value; // get the given textarea
                    var ss = (s+'x').slice(0,s.search(vm.forth.EOF.regex))
                             + '\n\\ '
                             + vm.forth.EOF.pattern
                             + '\n';
                    // The +'x' is a perfect trick, will be cut both EOF mark exists or not. 
                    // The last \n 避免最後是 \ comment 時吃到後面來
                    if (s) push(ss); else push(""); // skip if file not found
                </js> 
                tib.insert ;
                /// Cut after EOF and append EOF back to guarantee an EOF exists
                /// So, if a ~.f file is copy-paste to jeforth.3we input box, 
                /// instead of through sinclude, then EOF not found will be a problem 
                /// when it is expected in, i.e. source-code-header. Add EOF manually
                /// is the solution.


: include       ( <filename> -- ... ) \ Load the source file
                BL word sinclude ; interpret-only
                
code obj>keys   ( obj -- keys[] ) \ Get all keys of an object.
                var obj=pop();
                var array = [];
                for(var i in obj) array.push(i);
                push(array);
                end-code

code memberCount ( obj -- count ) \ Get hash table's length or an object's member count.
                push(vm.g.memberCount(pop()));
                end-code

code isSameArray ( a1 a2 -- T|F ) \ Compare two arrays.
                push(vm.g.isSameArray(pop(), pop()));
                end-code

code (?)        ( a -- ) \ print value of the variable consider ret and exit
                var x = dictionary[pop()];
                switch(x){
                    case null: type('RET');break;
                    case "": type('EXIT');break;
                    default: type(x);
                }; end-code private

: (dump)        ( addr -- ) \ dump one cell of dictionary
                decimal dup 5 .0r s" : " . dup (?) s"  (" . js> mytypeof(dictionary[pop()]) . s" )" . cr ;
: dump          ( addr length -- addr' ) \ dump dictionary
                for ( addr ) dup (dump) 1+ next ;
: d             ( <addr> -- ) \ dump dictionary
                [ last literal ]
                BL word                     \ (me str)
                count 0=                    \ (me str undef?) No start address?
                if                          \ (me str)
                    drop                    \ drop the undefined  (me)
                    js> tos().lastaddress   \ (me addr)
                else                        \ (me str)
                    js> parseInt(pop())     \ (me addr)
                then ( me addr )
                20 dump                         \ (me addr')
                js: pop(1).lastaddress=pop()
                ;
                
                <selftest>
                    *** d dump
                    js: vm.selftest_visible=false;vm.screenbuffer=""
                    d 0
                    js: vm.selftest_visible=true
                    <js> vm.screenbuffer.indexOf('00000: 0 (number)') !=-1 </jsV> \ true
                    [d true d] [p 'dump', 'd' p]
                </selftest>
code (see)      ( thing -- ) \ See into the given word, object, array, ... anything.
                var w=pop();
                var basewas = vm.forth.base; vm.forth.base = 10;
                if (!(w instanceof Word)) {
                    type(JSON.stringify(w,"\n","\t"));  // none forth word objects. 意外的好處是不必有 "unkown word" 這種無聊的錯誤訊息。
                }else{
                    for(var i in w){
                        if (typeof(w[i])=="function") continue;
                        if (i=="comment") continue;
                        push(i); dictate("16 .r s'  : ' .");
                        type(w[i]+" ("+mytypeof(w[i])+")\n");
                    }
                    if (w.type.indexOf("colon")!=-1){
                        if(w.cfa) { // 產生一個 colon word 方法很多，不一定已經有 cfa。
                            var i = w.cfa;
                            type("\n-------- Definition in dictionary --------\n");
                            do {
                                push(i); execute(_me["(dump)"]);
                            } while (dictionary[i++] != RET);
                            type("---------- End of the definition -----------\n");
                        }
                    } else {
                        if (typeof w.xt == "function") {
                            push("xt"); dictate("16 .r s'  :\n' .");
                            type(w.xt+"\n");
                        }
                    }
                    if (w.comment != undefined) type("\ncomment:\n"+w.comment+"\n");
                }
                type("\n"); vm.forth.base = basewas; 
                end-code
                last :: ["(dump)"]=tick("(dump)")

: see           ' (see) ; // ( <name> -- ) See definition of the word

                <selftest>
                    *** see (see)
                    marker ---
                    : test ; // test.test.test
                    js: vm.selftest_visible=false;vm.screenbuffer=""
                    see test
                    js: vm.selftest_visible=true
                    <js> vm.screenbuffer.indexOf('test.test.test') !=-1 </jsV> \ true
                    <js> vm.screenbuffer.indexOf('cfa') !=-1 </jsV> \ true
                    <js> vm.screenbuffer.indexOf('colon') !=-1 </jsV> \ true
                    [d true,true,true d] [p 'see','(see)','(?)' p]
                    ---
                </selftest>

code notpass    ( -- ) \ List words their sleftest flag are not 'pass'.
                for (var j in words) { // all word-lists
                    for (var i in words[j]) {  // all words in a word-list
                        if(i!=0 && words[j][i].selftest != 'pass') type(words[j][i].name+" ");
                    }
                }
                end-code
code passed     ( -- ) \ List words their sleftest flag are 'pass'.
                for (var j in words) { // all word-lists
                    for (var i in words[j]) {  // all words in a word-list
                        if(i!=0 && words[j][i].selftest == 'pass') type(words[j][i].name+" ");
                    }
                }
                end-code

\ -------------- Debugger : set breakpoint to a colon word -------------------------

js> inner constant fastInner // ( -- inner ) Original inner() without breakpoint support

code be         ( -- ) \ Enable the breakPoint. See also 'bp','bd'.
                inner = vm.g.debugInner; 
                vm.jsc.enable = true;
                execute(_me["bp"]); // call by reference safer than call by name
                end-code interpret-only
                /// work with 'jsc' debug console, jsc is application dependent.
code bd         ( -- ) \ Disable breakpoint, See also 'bp','be'.
                inner = vm.forth.fastInner;
                vm.jsc.enable = false; // 需要這個 flag 因為若已經進了 debugInner, 換掉 inner 也出不來。
                end-code interpret-only
                /// work with 'jsc' debug console, jsc is application dependent.
code bp         ( <address> -- ) \ Set breakpoint in a colon word. See also 'bd','be'.
                var bp = nexttoken();
                vm.jsc.enable = true;
                if (bp) {
                    vm.jsc.bp = parseInt(bp);
                    execute(_me["be"])  // call by reference safer than call by name
                } else {
                    type("Breakpoint : " + vm.jsc.bp);
                    if (inner == vm.g.debugInner) type(", activated\n");
                    else  type(", inactive\n");
                }
                end-code interpret-only
                \ bp be look easily conflictedly reused in the future
                \ call by reference safer than call by name
                ' be :: ["bp"]=last() 
                last :: ["be"]=tick("be")
                /// If no address is given then show the recent breakPoint and 
                /// its status.
                /// work with 'jsc' debug console, jsc is application dependent.

: (*debug*)     ( msg -- ) \ Suspend to command prompt, 'q' to quit debugging.
                cr ." ---- Entering *debug* ----" cr
                [ last literal ] ( _me )
                <js>
                    var _me = pop();
                    if (_me.resume) {
                        panic("Error, already in *debug*, 'q' to resume.\n");
                    } else {
                        var tibwas=tib, ntibwas=ntib, ipwas=ip, promptwas=vm.prompt;
                        vm.prompt = pop().toString();
                        // The clue to resume from debugging
                        _me.resume = function(){
                            tib=tibwas; 
                            ntib=ntibwas; 
                            vm.prompt=promptwas;
                            outer(ipwas);
                        }
                        // ip = 0 reserve rstack, suspend the forth VM 
                        // (*debug*) must be a colon word so as to use this trick.
                        tib = ""; ntib = ip = 0; 
                    }
                </js> ;
                /// 'q' command to quit debugging
code q          ( -- ) \ Quit *debug*
                type("\n ---- Leaving *debug* ----\n");
                var q = tick("(*debug*)").resume; 
                tick("(*debug*)").resume=null; 
                q(); 
                end-code interpret-only
                
: *debug*       ( <prompt> -- resume ) \ Forth debug console. Execute the resume() to quit debugging.
                BL word compiling if literal compile (*debug*) 
                else (*debug*) then ; immediate
                /// 'q' command to quit debugging
                /// *debug* 可以用在 immediate word 裡面, 當 break 到時可能在 
                /// colon definition 的半途，此時 q 要下成 [ q ] , .s 要下成 
                /// [ .s ] ... etc

\ ----------------- Self Test -------------------------------------
: warning-on    ( -- ) \ Turn on run-time warnings 
                js: tick=vm.g.selftest_tick;execute=vm.g.selftest_execute ;
: warning-off   ( -- ) \ Turn off run-time warnings
                js: tick=vm.tick;execute=vm.execute ;
                
"" value description     ( private ) // ( -- "text" ) description of a selftest section
[] value expected_rstack ( private ) // ( -- [..] ) an array to compare rstack in selftest
[] value expected_stack  ( private ) // ( -- [..] ) an array to compare data stack in selftest
0  value test-result     ( private ) // ( -- boolean ) selftest result from [d .. d] 
[] value [all-pass]      ( private ) // ( -- ["words"] ) array of words for all-pass in selftest
: ***           ( <description> -- ) \ Start a selftest section
                CR word trim
                <js> "*** " + pop() + " ... " </jsV> to description
                depth if 
                    description . ." aborted" cr 
                    ." *** Warning, Data stack is not empty." cr
                    stop
                then ;
code all-pass   ( ["name",...] -- ) \ Pass-mark all these word's selftest flag
                var a=pop();
                for (var i in a) {
                    var w = vm.tick(a[i]); // use the original tick()
                    if(!w) panic("Error! " + a[i] + "?\n");
                    else w.selftest='pass';
                }
                end-code private
                
: [r            ( <"text"> -- ) \ Prepare an array of data to compare with rstack in selftest.
                char r] word js> eval("["+pop()+"]") to expected_rstack ;
: r]            ( -- boolean ) \ compare rstack and expected_rstack in selftest
                js> vm.g.isSameArray(rstack,vm.forth.expected_rstack) ;
: [d            ( <"text"> -- ) \ Prepare an array to compare with data stack. End of a selftest section.
                char d] word js> eval("["+pop()+"]") to expected_stack ;
                /// Data stack will be clean after check
: d]            ( -- boolean ) \ compare data stack and expected_stack in selftest
                js> vm.g.isSameArray(stack,vm.forth.expected_stack) to test-result 
                description . test-result if ." pass" cr dropall
                else ." fail" cr stop then ;
                /// Data stack will be clean after check
: [p            ( <"text"> -- ) \ Prepare an array ([all-pass]) of words for all-pass if test-result.
                char p] word js> eval("["+pop()+"]") to [all-pass] ; /// In selftest
: p]            ( -- boolean ) \ all-pass if test-result
                test-result if [all-pass] all-pass then ; /// In selftest
                
                \ Make these words private. Do it this way instead of at their definitions 
                \ to void selftest_tick() warnings
                ' description     :: private=true
                ' expected_rstack :: private=true
                ' expected_stack  :: private=true
                ' test-result     :: private=true
                ' [all-pass]      :: private=true

<selftest>
    *** End of kernel self-test
    [d d] [p 'accept', 'refill', '***' p]
    ~~selftest~~
</selftest>

\ jeforth.f kernel code is now common for different application. I/O may not ready enough to read 
\ selftest.f at this moment, so the below code has been moved to quit.f of each applications.
    \ Do the jeforth.f self-test only when there's no command line
    \   js> vm.argv.length 1 > \ Do we have jobs from command line?
    \   [if] \ We have jobs from command line to do. Disable self-test.
    \       js: tick('<selftest>').enabled=false
    \   [else] \ We don't have jobs from command line to do. So we do the self-test.
    \       js> tick('<selftest>').enabled=true;tick('<selftest>').buffer tib.insert
    \   [then] js: tick('<selftest>').buffer="" \ recycle the memory

    </textarea><!-- jeforth_f box --> 

    <textarea hidden id="quit_f" cols=140 rows=10>

\ quit.f for jeforth.3htm
\
\ QUIT is the traditional forth system's CLI loop. jeforth.f kernel is common for all
\ applications. quit.f is the good place to define propritary features of each application.
\  

: cr            ( -- ) \ 到下一列繼續輸出 *** 20111224 sam
                js: type("\n") 1 nap js: vm.scroll2inputbox();inputbox.focus() ;
                /// redefined in quit.f, 1 nap 使輸出流暢。
                /// Focus the display around the inputbox.
                \ 早一點 redefine 以便流暢 include 諸 ~.f 時的 selftest messages.

\ ------------------ Get args from URL -------------------------------------------------------
    js> location.href constant url // ( -- 'url' ) jeforth.3htm url entire command line 
    url :> split("?")[1] trim value args // ( -- 'args' ) jeforth.3htm command line args
    args [if] char %20 args + :> split('%') <js>
        for (var ss="",i=1; i<tos().length; i++){
            // %20 is space and also many others need to be translated 
            ss += String.fromCharCode("0x"+tos()[i].slice(0,2)) + tos()[i].slice(2);
        };ss
    </jsV> nip to args [then]
    // Facebook always turn space to + that we need to support _ as space. 
    args ?dup [if] 
        <js> pop().replace(/_/g," ") </jsV>  ( args )
        "" || ( 消除 undefined 留下 args or null string ) to args 
    [then]

\ ------------------ Self-test of the jeforth.f kernel --------------------------------------
    \ Do the jeforth.f self-test only when there's no command line. How to see command line is
    \ application dependent. 
    \

    args [if] \ jobs to do, disable self-test.
        warning-off
        js: tick('<selftest>').enabled=false
    [else] \ no job, do the self-test.
        warning-on
        js> tick('<selftest>').enabled=true;tick('<selftest>').buffer tib.insert
    [then] 
    js: tick('<selftest>').buffer="" \ recycle the memory
    
    \ 發現透過 rawgit.com 可以直接執行發佈在 GitHub 上的 jeforth.3htm
    \ 為了加快速度,以下都用絕對位址。避免讓 readTextFileAuto 順著 path
    \ 慢慢嘗試錯誤。
    
    include voc_f           \ voc.f is basic of forth language
    include html5_f         \ html5.f is basic of jeforth.3htm
    include element_f       \ HTML element manipulation
    include platform_f      
    include misc_f      
    include weblink_f
  \ js: weblink_f.value=SourceCode.weblink_f include weblink_f
  \ include hte_f
  \ include ls_f

    \ 清理回收 memory 
    \ js> voc_f       removeElement   這些都不用做，只要有 cls 就都清掉了，做了反而可能因已經 cls 而出錯
    \ js> html5_f     removeElement   
    \ js> element_f   removeElement   
    \ js> platform_f  removeElement   
    \ js> misc_f      removeElement   
    \ js> weblink_f   removeElement   
    js: SourceCode=null
    
\ ------------ End of jeforth.f -------------------
    js: kvm.screenbuffer=null \ turn off the logging
    .(  OK ) \ The first prompt after system start up.
    js: vm.scroll2inputbox();inputbox.focus()

\ ----------------- run the command line -------------------------------------
    args tib.insert

\ The End 
    </textarea><!-- quit_f box --> 

    <textarea hidden id="jsc_f" cols=140 rows=10>

\ ------------------ jsc JavaScript console debugger  --------------------------------------------
\
\ jeforth.f is common for all applications. jsc is application dependent.
\ jeforth.f words bp, be, bd and vm.g.debugInner() refer to jsc before its birth.
\ That's ok because they are all break-point things that are interpret-only meaning
\ they are either never used in free run mode or only used after the system is ready.

\
\ Usage:
\   Put this line,
\     if(vm.debug){vm.jsc.prompt="msg";eval(vm.jsc.xt)}
\   among JavaScript code as a break point. The "msg" shows you which break point is triggered.
\
\   Example:
\   In below example, jsc can access variables aa, bb, and input.
\
\   <js>
\       function test (input) {
\           var aa = 11;
\           var bb = 22;
\           if(1){vm.jsc.prompt="bp1>>>";eval(vm.jsc.xt)}
\       }
\       test(33);
\   </js>
\

.( Including jsc.f ) cr

<text>
    J a v a S c r i p t   c o n s o l e
      for jeforth.[3nw|3htm|3hta]

    g : Go on, Continue running.
    t : Toggle displaying the status.
    s : Single step. (bp=-1)
    p : Run until next IP. (bp=ip+1)
    r : Free run until ret. (bp=rtos)
    rr: Free run until ret. (bp=next rtos)
    erase : Erase debug message at bottom.
    bye : Terminate the program.
    help : you are reading me.
    g, q, exit, quit : Disable bp, Continue.
    reset, <Esc> : Disable bp, Reset, and Continue.

    Put this line,
    > if(vm.debug){vm.jsc.prompt="msg";eval(vm.jsc.xt)}
    into anywhere among JavaScript source code to drop a breakpoint. "msg" indicates which breakpoint it is.

</text> <js> vm.jsc={}; vm.jsc.help=pop().replace(/^[\t ]*/gm,""); </js> \ remove leading Tab's and spaces
<text>

    // Variable        Description
    // -------------   ---------------------------------------------------------
    // vm.jsc.help    
    // vm.jsc.xt       jsc source code called by eval(vm.jsc.xt)
    // vm.jsc.enable   Enable the break-point caught by inner()
    // vm.jsc.prompt
    // vm.jsc.cmd      static jsc command line for repeating the same command
    // -------------   ---------------------------------------------------------
    
    (function(){
        var eraseCount=4;
        inputbox.value = ""; // for erase command
        vm.jsc.enable = false; // 避免 jsc 自己用的 colon word 也 hit 到 break-point。
        for(;;) {
            if (vm.jsc.statusToggle) {
                vm.jsc.cmd = ""; // don't want to repeat this command
                type(
                    "\n -------- Following Instructions --------\n" +
                    " " + (ip  ) + " : " + ((dictionary[(ip  )]==null) ? "RET" : ((dictionary[(ip  )]=="") ? "EXIT" : dictionary[(ip  )])) + "\n" +
                    " " + (ip+1) + " : " + ((dictionary[(ip+1)]==null) ? "RET" : ((dictionary[(ip+1)]=="") ? "EXIT" : dictionary[(ip+1)])) + "\n" +
                    " " + (ip+2) + " : " + ((dictionary[(ip+2)]==null) ? "RET" : ((dictionary[(ip+2)]=="") ? "EXIT" : dictionary[(ip+2)])) + "\n" +
                    " " + (ip+3) + " : " + ((dictionary[(ip+3)]==null) ? "RET" : ((dictionary[(ip+3)]=="") ? "EXIT" : dictionary[(ip+3)])) + "\n" +
                    " -------------- Forth Stacks ------------\n" +
                    ' rstack['+rstack+']:' + rstack.length + '  stack['+stack+']:' + stack.length + '\n'
                    );
            }
            type(vm.jsc.prompt ); 
            window.scrollTo(0,endofinputbox.offsetTop);
            vm.jsc.cmd = // static variable so as to reuse last command
                prompt("JavaScript console", vm.jsc.cmd||""); // Press Enter repeat last command
            vm.jsc.cmd = vm.jsc.cmd==null ? 'reset' : vm.jsc.cmd; // Press Esc equals to 'reset' ['quit']
            vm.type("\n > " + vm.jsc.cmd + "\n");
            switch(vm.jsc.cmd){
                case "reset" : reset();
                case "exit" : case "q" : case "quit": 
                    execute("bd"); 
                case "g" : return;
                case "t" : 
                    vm.jsc.statusToggle=Boolean(vm.jsc.statusToggle^true); 
                    break;
                case "s"  : 
                    vm.jsc.bp=-1; 
                    vm.jsc.enable = true; 
                    return;
                case "p"  : 
                    vm.jsc.bp=(isNaN(dictionary[ip+1]))?ip+1:dictionary[ip+1]; 
                    vm.jsc.enable = true; 
                    return;
                case "r"  : 
                    vm.jsc.bp=rstack[rstack.length-1]; 
                    vm.jsc.enable = true;
                    return;
                case "rr" : 
                    vm.jsc.bp=rstack[rstack.length-2]; 
                    vm.jsc.enable = true;
                    return;
                case "bye"  : execute("bye"); break;
                case "help" : 
                    alert(vm.jsc.help); 
                    break;
                case "erase" : 
                    for(var _i_=0; _i_<eraseCount; _i_++){
                        execute('{backSpace}'); pop();
                    } 
                    break;
                default : try { // 自己處理 JScript errors 以免動不動就被甩出去
                    var _result_ = eval(vm.jsc.cmd);
                    vm.type(_result_);
                    vm.type(" (" + mytypeof(_result_) + ")\n");
                } catch(err) {
                    vm.type("Oooops! " + err.message + "\n")
                }
            }
        }
    })()
</text> constant jsc.xt.hta private // ( -- source code ) jsc.xt for HTA
<text>
    (function(){
        inputbox.value = ""; // for erase command
        vm.jsc.t = function() { vm.jsc.statusToggle=Boolean(vm.jsc.statusToggle^true) }
        vm.jsc.q = function() { execute("bd") }
        vm.jsc.s = function() { vm.jsc.bp=-1;vm.jsc.enable = true; }
        vm.jsc.p = function() {
            vm.jsc.bp=(isNaN(dictionary[ip+1]))?ip+1:dictionary[ip+1]; 
            vm.jsc.enable = true;
        }
        vm.jsc.r = function() {
            vm.jsc.bp=rstack[rstack.length-1]; 
            vm.jsc.enable = true;
        }
        vm.jsc.rr = function() {
            vm.jsc.bp=rstack[rstack.length-2]; 
            vm.jsc.enable = true;
        }
        vm.jsc.bye = function() { execute("bye") }
        vm.jsc.erase = function(count) {
            count = count||1;
            for(var _i_=0; _i_<count; _i_++){
                execute('{backSpace}'); pop();
            } 
        }
        vm.jsc.bottom = function() { window.scrollTo(0,endofinputbox.offsetTop) }
        vm.jsc.status = function() { 
            type(
                " -------- See IP --------\n" +
                " " + (ip  ) + " : " + ((dictionary[(ip  )]==null) ? "RET" : ((dictionary[(ip  )]=="") ? "EXIT" : dictionary[(ip  )])) + "\n" +
                " " + (ip+1) + " : " + ((dictionary[(ip+1)]==null) ? "RET" : ((dictionary[(ip+1)]=="") ? "EXIT" : dictionary[(ip+1)])) + "\n" +
                " " + (ip+2) + " : " + ((dictionary[(ip+2)]==null) ? "RET" : ((dictionary[(ip+2)]=="") ? "EXIT" : dictionary[(ip+2)])) + "\n" +
                " " + (ip+3) + " : " + ((dictionary[(ip+3)]==null) ? "RET" : ((dictionary[(ip+3)]=="") ? "EXIT" : dictionary[(ip+3)])) + "\n" +
                " -------------- See Stacks ------------\n" +
                ' rstack['+rstack+']:' + rstack.length + '  stack['+stack+']:' + stack.length + '\n' +
                " --------------------------------------\n"
            );
        }
        if (!vm.jsc.statusToggle) { vm.jsc.status() }
        vm.jsc.bottom();
        debugger;
    })()
</text> constant jsc.xt.F12 private // ( -- source code ) jsc.xt for F12 debugger

js> vm.appname char jeforth.3hta = [if]
    \ 3hta
    jsc.xt.hta js: vm.jsc.xt=pop()
[else] 
    \ 3htm, 3nw, 3ce 
    jsc.xt.F12 js: vm.jsc.xt=pop()
[then]
    
: jsc           ( -- ) \ JavaScript console usage: js: vm.jsc.prompt="111>>>";eval(vm.jsc.xt)
                cr ." J a v a S c r i p t   C o n s o l e" cr
                ." Usage: js: if(vm.debug){vm.jsc.prompt='msg';eval(vm.jsc.xt)}" cr
                ."        Open F12 debugger if possible." cr
                <js> vm.jsc.prompt=" jsc>"; eval(vm.jsc.xt); </js> ;

<js>
    // vm.panic() is the master panic handler. The panic() function defined in 
    // project-k kernel projectk.js is the one called in code ... end-code. That 
    // panic() is actually calling vm.panic(). We redefine vm.panic() because jsc 
    // is ready now while F12 debugger can be called from jsc still.

    vm.panic = function(state){ 
        vm.type(state.msg);
        if (state.serious) {
            vm.jsc.prompt="Panic jsc>";
            eval(vm.jsc.xt); // was debugger;
        }
    }
</js>
    </textarea><!-- jsc_f box --> 
    
    <textarea hidden id="voc_f" cols=140 rows=10>

.( Including voc.f ) cr

marker --voc.f-- 

char forth constant forth-wordlist // ( -- "forth" ) The vid of forth-wordlist.

                <selftest>
                    marker --voc.f-self-test--
                </selftest>

code isMember   ( value group -- key|index T|F ) \ Return key or index if value exists.
                var group = pop();
                var result = vm.g.isMember(pop(), group);
                if (result.flag) {push(result.key); push(true)}
                else push(false);
                end-code
                /// 'item' can be number, string, or object, anything that can be compared by the == operator.
                /// 'group' is either array or object.

                <selftest>
                    *** isMember checks array or object
                    char name     ' code isMember [if] char code = [then] \ true
                    char selftest ' code isMember [if] char pass = [then] \ true true
                    ' help js> words.forth isMember [if] js> words.forth[pop()].name=='help' [then] \ true true true
                    [d true,true,true d] [p "isMember" p]
                </selftest>

code get-context ( -- "vid" ) \ Get the word list that is searched first. 
                push(context=order[Math.max(0,order.length-1)]) end-code
                /// context is order[last]

: set-context    ( "vid" -- ) \ Replace the word-list which is searched first.
                 js: order.pop();order.push(tos());vm.g.scan_vocabulary(context=pop(),true) ;
                 /// context and order[last] are samething. 
                 /// No error-proof, because it is only used in vocabulary words.

                <selftest>
                    *** set-context get-context manipulate the word-list of first priority
                    also forth vocabulary vvv char vvv set-context
                    get-context char vvv = \ true
                    [d true d] [p 'get-context' p]
                </selftest>

code get-current ( -- "vid" ) \ Return vid, new word's destination word list name.
                push(current) end-code

code set-current ( "vid" -- ) \ Set the new word's destination word list name.
                current = pop() end-code
                 /// No error-proof, because it is only used in vocabulary words.

                <selftest>
                    *** set-current get-current word-list new words are going to
                    also vocabulary vvv000 vvv000 definitions
                    also char vvv set-current
                    get-current char vvv = \ true
                    forth definitions \ change current to forth
                    get-current char forth = \ true true
                    vvv definitions \ change current to vvv
                    get-current char vvv = \ true true true
                    : ttt ; js> words.vvv[words.vvv.length-1].name=='ttt' \ true true true true 
                    previous \ use the previous word-list as the context
                    get-context char vvv000 = \ true true true true true
                    [d true,true, true, true, true d] 
                    [p 'get-current','forth','(vocabulary)','vocabulary',
                       'definitions','previous','forth-wordlist' p]
                </selftest>

: (vocabulary)  ( "name" -- ) \ create a new word list.
                >r <js> var name=rtos(),flag=false; for(var vid in words) if(vid==name) {flag=true;break};flag </jsV> 
                if s" Error! redefine vocabulary '" r@ + s" ' is not allowed." + "msg"abort then
                r> (create) reveal colon-word js> last().name dup 
                0 , \ dummy cfa, we need to do this because "(create)" doesn't drop the doVar like "create" does.
                , \ pfa is the "name"
                dup js: words[pop()]=[];words[pop()].push(0) ( empty ) \ words[][0] = 0 是源自 jeforth.WSH 的設計。
                <js> 
                    last().type='colon-vocabulary';
                    last().help = "( -- ) I am a vocabulary. I switch word-list.";
                </js>
                immediate \ 要在 colon definition 裡切換 word-list 所以是 immediate。 
                does> r> @ set-context ;
                
: vocabulary    ( <name> -- ) \ create a new word list.
                BL word (vocabulary) ;
                
: only          ( -- ) \ Leaving forth the only vocabulary in order[]
                js: order=["forth"] rescan-word-hash ; immediate

                <selftest>
                    \ search: forth,vvv,vvv000
                    \ define: vvv
                    *** only leaves empty order list ... 
                    get-context char forth = \ false
                    only forth
                    get-context char forth = \ true
                    js> order.length==1 \ true
                    [d false,true,true d] [p "only" p]
                </selftest>

code also       order.push(order[order.length-1]) end-code immediate 
                // ( -- ) dup vocabulary order[] array

                \ The rescan after 'also' is a nullity because both are context and thus
                \ private words are all still going into the wordhash.
                \ : also ( -- ) \ Dup the top of vocabulary order[]
                \ js: order.push(order[order.length-1]) rescan-word-hash ; immediate 

code previous   if(order.length>1){order.pop();dictate("rescan-word-hash")} end-code immediate
                // ( -- ) Drop vocabulary order[] array's TOS

: forth         ( -- ) \ Make forth-wordlist be searched first, which is to set context="forth".
                forth-wordlist set-context ; immediate
                
' get-current alias current // ( -- "vid" ) current is alias of get-current, get the compilation word list's vid name.

\ 如果照 ANS 標準，get-order 應該如下定義。但是 jeforth 有 JavaScript 當靠山，TOS 可以直接操作 array，實在無需如此委屈。
\ code get-order  ( -- vidn ... vid1 n ) \ Get the order[] list with order.length at TOS
\               for(var i=0; i<order.length; i++) push(order[i]);
\               push(order.length);
\               end-code
\ : order       ( -- ) \ list vocabulary array search order.
\               get-order ( -- vidn ... vid1 n ) ." search: " for r@ 1- roll . space next cr
\               get-current ( -- vid ) ." define: " . cr ;

code get-order  ( -- order-array ) \ Get the vocabulary order array
                push(order);
                end-code

: order         ( -- ) \ list vocabulary array search order.
                ." search: " get-order . cr
                ." define: " get-current ( -- vid ) . cr ;
                
: definitions   get-context set-current ; 
                // ( -- ) make current equals to context. current = order[order.length-1].

: get-vocs      js> words obj>keys ; // ( -- vocs[] ) Get all vocabulary names.

: not-only      ( -- ) \ Bring back all vocabulary 
                [compile] only get-vocs <js> pop().join(" also ")</jsV> tib.insert ; interpret-only
                /// Does not change the current.

: vocs          ." vocs: " get-vocs . cr ; // ( -- ) List all vocabulary names.

                <selftest>
                    \ search: forth
                    \ define: vvv
                    *** also current order vocs
                    js: vm.selftest_visible=false
                    also vvv
                    js: vm.screenbuffer=vm.screenbuffer?vm.screenbuffer:""; \ enable vm.screenbuffer, it stops working if is null.
                    js> vm.screenbuffer.length constant start-here // ( -- n ) 
                    cr only forth also vvv also vvv000 definitions current char vvv000 = \ true
                    order 
                    start-here <js> vm.screenbuffer.slice(pop()).indexOf("search: forth,vvv,vvv000")!=-1 </jsV> \ true true
                    start-here <js> vm.screenbuffer.slice(pop()).indexOf("define: vvv000")!=-1 </jsV> \ true true true
                    vocs
                    js: vm.selftest_visible=true
                    start-here <js> vm.screenbuffer.slice(pop()).indexOf("vocs: forth,vvv,vvv000")!=-1 </jsV> \ true true true true
                    [d true,true,true,true d] [p 'current','definitions','order','vocs',
                    'get-current','get-order','get-vocs','forth' p]
                </selftest>

: find-vocs     ( "vid" -- index T|F ) \ Is the given "vid" in the vocs?
                get-vocs isMember ;
                /// this is an example of how to access vocs list.

                <selftest>
                    *** find-vocs is a demo of accessing vocs list
                    char vvv find-vocs swap 1 = and \ true 
                    char vvv000 find-vocs swap 2 = and \ true true
                    [d true,true d] [p "find-vocs" p]
                </selftest>
                
code search-wordlist ( "name" "vid" -- wordObject|F ) \ A.16.6.1.2192 Linear search from the given word-list.
                var vid = pop();
                var name = pop();
                for (var i=words[vid].length-1; i>0; i--) if(words[vid][i].name == name) break;
                push(i?words[vid][i]:false);
                end-code
                /// jeforth.3nw has wordhash which is much more powerful. 
                /// So we don't use search-wordlist at all. 

                <selftest>
                    *** search-wordlist linear search a word-list
                    char code char forth search-wordlist js> pop().name=='code' \ true
                    [d true d] [p "search-wordlist" p]
                </selftest>

: prioritize    ( "vid" -- ) \ Make the vocabulary first priority
                get-vocs :> indexOf(tos()) ( vid i1 ) 
                js> tos()==-1 ?abort" Error! unknown vocabulary." ( vid i1 )
                js> order.indexOf(tos(1)) ( vid i1 i2 )
                js> tos()==-1 if ( vid i1 i2 ) \ existing but not in order[]
                    js: order.push(pop(2)) drop drop 
                else ( vid i1 i2 ) \ already in order[]
                    nip ( vid i2 ) js: order.splice(pop(),1);order.push(pop()) 
                then rescan-word-hash ;
                /// Refer to "set-context" command which is cruder.

: forget        ( <name> -- ) \ Forget the current vocabulary from <name>
                BL word dup (') js> tos().vid js> current = if ( -- name Word )
                    js> words[current].length-pop().wid for (forget) next
                else
                    drop ." Oooops! '" . ." ' not found in the current vocabulary, "
                    current . char . . cr
                then ;

\ marker 十分複雜。
\ 引進 vocabulary 之後，marker 要改寫。請想想: 'here' 只有一個，當 here 退回到某處，在此之後的所有 words 都要丟
\ 掉，不管它屬哪個 word list. 執行一個 vocabulary words 切入之前就存在的 marker 會怎樣？會把 forth-wordlist 倒
\ 回去、here 也倒回去，恢復 current = context = "forth"; 這是原始 marker 要補做的動作。 

code (marker)   ( "name" -- ) \ Create a word named <name>. Run <name> to forget itself and all newers.
                // -------------------- the saving part 1/2 ----------------------------------
                // we need to do this before creating the marker new word
                var lengthwas = {}; // each word-list's length was
                for (var vid in words) lengthwas[vid] = words[vid].length; // go through all word lists to save their length
                // ---------------- Create the marker new word --------------------------
                execute("(create)");execute("reveal");
                // -------------------- the saving part 2/2 ----------------------------------
                var orderwas = []; // FigTaiwan 爽哥提醒
                for(var i=0; i<order.length; i++) orderwas[i] = order[i]; // FigTaiwan 爽哥提醒. Marker 也得 restore order[] 跟 vocs[].
                last().type='marker'
                last().herewas = here;
                last().lengthwas = lengthwas; // dynamic variable array 的 reference 給了別人之後就不會蒸發掉了。
                
                push(nexttoken('\n|\r')); // rest of the first line
                execute("parse-help"); // ( "helpmsg" "rests" )
                tib = pop() + " " + tib.slice(ntib); ntib = 0; // "rests" + tib(ntib)
                var h = pop(); // help messages packed
                if(h.indexOf("No help message")!=-1) h = "( -- ) I am a marker.";
                last().help = h;
                dictate("get-vocs"); last().vocswas = pop(); 
                last().orderwas = orderwas;  // FigTaiwan 爽哥提醒 // dynamic variable array 的 reference 給了別人之後就不會蒸發掉了。
                // --------------------- the restore phase ----------------------------------
                // xt's job is to restore the saved context  
                last().xt = function(){ 
                    here = this.herewas;
                    order.splice(0,order.length); 
                    for(var i=0; i<this.orderwas.length; i++) order[i] = this.orderwas[i]; // FigTaiwan 爽哥提醒; order[order.length-1] 就是 context 不必再 save-restore.
                    for(var vid in words) {
                        if(!vm.g.isMember(vid, this.vocswas).flag) {
                            delete words[vid]; // if the word-list was not exist then delete it.
                        }
                    }
                    current = this.vid; // FigTaiwan 爽哥提醒。 我不管 current vocabulary 還在不在，一律 restore 到原來的.
                    dictionary = dictionary.slice(0,here);
                    for(var vid in words) { // go through all word lists to restore their length
                        words[vid] = words[vid].slice(0, this.lengthwas[vid]); 
                    }
                    dictate("rescan-word-hash");
                }
                end-code
                /// voc.f reDef'ed 進一步解決 vocs 的 save-restore. 

: marker        ( <name> -- ) \ Create marker <name>. Run <name> to forget itself and all newers.
                BL word (marker) ;

                <selftest>
                    *** marker (marker) are very complicated
                    marker ---%%%--- 
                    : marker-test-dummy ;
                    ' marker-test-dummy boolean \ true
                    ---%%%--- 
                    ' marker-test-dummy boolean \ false
                    [d true,false d] [p '(marker)','marker' p]
                </selftest>

code words      ( <["pattern" [-t|-T|-n|-f]]> -- ) \ List all words or words screened by spec.
                var spec = nexttoken("\r|\n").replace(/\s+/g," ").split(" "); // [pattern,option,rests]
                for (var j=0; j<order.length; j++) { // 越後面的 priority 越新
                    push(order[j]); // vocabulary
                    push(spec[0]||""); // pattern
                    push(spec[1]||""); // option
                    execute("word_select"); // [words...]
                    if (tos().length) { 
                        type("\n-------- " + order[j] +" ("+ tos().length + " words) --------\n"); 
                        for(var i=0; i<tos().length; i++) type(tos()[i].name+" ");
                    }
                    pop();
                }
                execute("cr");
                end-code interpret-only
                /// Modified by voc.f to support vocabulary.
                last :: comment+=tick("word_select").comment
                /// Example: words ! -n

                <selftest>
                    marker ---
                    *** words modified for volcabulary
                    js> vm.screenbuffer.length constant start-here // ( -- n ) 
                    js: vm.selftest_visible=false
                    words \ 
                    js: vm.selftest_visible=true
                    start-here <js> vm.screenbuffer.slice(pop()).indexOf("-------- forth (")!=-1 </jsV> \ true
                    start-here <js> vm.screenbuffer.slice(pop()).indexOf("words) --------")!=-1 </jsV> \ true true
                    [d true,true d] [p "words" p]
                    ---
                </selftest>

: help          ( <["pattern" [-t|-T|-n|-f]]> -- )  \ Print help message of screened words
                CR word ( spec )
                js> tos().length if 
                    <js>
                    var spec = pop();
                    for (var j=0; j<order.length; j++) { // 越後面的 priority 越新
                        push(order[j]); // vocabulary
                        push(spec=='*'?"":spec); // "[pattern [-t|-T|-n|-f]]]" or "" if spec is '*'
                        execute("(help)");
                        if (tos()){
                            type("\n-------- " + order[j] + " --------\n"); 
                            execute('.');
                        } else pop();
                    }
                    </js>
                    cr
                else
                    drop cr version drop
                    \ general-help message 引用原來的.
                    ['] help :> general_help . cr
                then ; 
                /// Modified by voc.f to support vocabulary.
                last :: comment+=tick("word_select").comment
                /// A pattern of star '*' matches all words.
                /// Example: 
                ///   help * <-- show help of all words
                ///   help * -N <-- show help of '*' command

                <selftest>
                    marker ---
                    *** help modified for volcabulary ... 
                    js: vm.selftest_visible=false;vm.screenbuffer=""
                    help \
                    js: vm.selftest_visible=true
                    <js> vm.screenbuffer.indexOf("-- forth --")!=-1 </jsV> \ true
                    <js> vm.screenbuffer.indexOf("Comment down to the next")!=-1 </jsV> \ true
                    [d true,true d] [p "help" p]
                    ---
                </selftest>

: ?skip2        ( "name.f" <EOF> -- "name.f" |empty ) \ skip to <EOF> to avoid double including
                dup (')             ( name.f exist? )
                BL word swap        ( name.f eof exist? )
                if                  ( name.f eof )
                    word drop       ( name.f ) \ drop everything before eof
                    BL word         ( name.f eof ) \ remove eof from tib
                    drop            ( name.f ) \ drop eof
                else                ( name.f eof )
                then    ( name.f | name.f eof )
                drop \ when the .f module has been totally skipped the stack is empty as well for there's nothing to do in that case
                ; 
                /// Conditional skip TIB down to the next EOF mark.
                /// The EOF mark is supposed to be at the end of a \ comment at end of the .f file.
                /// In None-blocking settings, to support suspend-resume of the forth VM, dictate()
                /// can not call itself recursively so as to avoid from confusing the suspend-level.
                /// While 'include' used to utilize dictate() that is now replaced by "tib.insert".
                /// Use ?skip2 at the beginning of a .f file if you don't want it to be double included.

: header        ( -- 'head' ) \ ~.f common header
                EOF :> pattern <text>
                    \ ~.f common header
                    ?skip2 _eof_ \ skip it if already included
                    dup .( Including ) . cr char -- over over + +
                    js: tick('<selftest>').masterMarker=tos()+"selftest--";
                    also forth definitions (marker) (vocabulary)
                    last execute definitions
                    <selftest>
                        js> tick('<selftest>').masterMarker (marker)
                    </selftest>
                </text> :> replace("_eof_",pop()) ; private
    
: tailer        ( -- 'tailer' ) \ ~.f common tailer
                <text> 
                    \ ~.f common tailer
                    <selftest>
                    js> tick('<selftest>').masterMarker tib.insert
                    </selftest>
                    js> tick('<selftest>').enabled [if] js> tick('<selftest>').buffer tib.insert [then]
                    js: tick('<selftest>').buffer="" \ recycle the memory
                </text> ; private
                
: source-code-header ( "vocabulary-name" -- ) \ source code header
                \ make it the context if the module is existing
                    dup (') ( mname w ) if dup prioritize then \ ?skip2 will skip to EOF ( mname )
                \ not included yet ( mname ) split tib into [used][ntib~EOF][after EOF]
                \ slice ntib~EOF 
                    js> tib.slice(ntib).indexOf(vm.forth.EOF.pattern) ( mname ieof )
                    dup -1 = ?abort" Error! EOF mark not found. It is usually added by sinclude." ( mname ieof )
                    js> ntib + ( ..ieof ) js> tib.slice(ntib,tos()) ( mname ieof tib[ntib~EOF] ) 
                \ append the tailer
                    tailer + ( mname ieof tib[ntib~before EOF]+tailer ) 
                \ reform the EOF
                    s" \ " + ( mname ieof tib[ntib~beforeEof+tailer+\] )
                \ wrap up the tib
                    swap js> tib.slice(pop()) ( mname tib[ntib~before EOF]+tailer afterEOF ) 
                    + js: tib=pop();ntib=0 ( mname )
                    header tib.insert 
                ; interpret-only
                /// The given name becomes the vocabulary name. If the vocabulary is 
                /// existing then make it the context but skip the including. The command
                /// is time consuming therefore is not suitable for ~.f modules that require
                /// performance.

<selftest> --voc.f-self-test-- </selftest>
js> tick('<selftest>').enabled [if] js> tick('<selftest>').buffer tib.insert [then] 
js: tick('<selftest>').buffer="" \ recycle the memory

\ --EOF--

    </textarea><!-- voc_f box --> 
    <textarea hidden id="html5_f" cols=140 rows=10>

s" html5.f"     source-code-header

: stringify     js> JSON.stringify(pop()) ; // ( obj -- "json" ) Convert the object to JSON string
                /// Example:
                /// activeSheet char a char b init-hash ( Get key-value hash table from Excel )
                /// stringify char pathname.json writeTextFile ( Convert to JSON save to file )
: parse         js> JSON.parse(pop()) ; // ( "json" -- obj ) Convert the "json" string to an object.
                /// Example:
                /// char pathname.json readTextFile ( Read JSON text )
                /// parse value MyHashTable ( convert JSON text to hash table object )

: createElement ( <tagName> -- element ) \ Create an HTML element w/o instance yet
                js> document.createElement(pop()) ; 
                /// tagName can be 'div','script' or anything you like.
                
: setAttribute  ( oElement "attr" "value" -- ) \ Set an attribute to an element
                js: pop(2).setAttribute(pop(1),pop()) ;

: appendChild   ( parent element -- ) \ Append a child element to the parent element
                js: pop(1).appendChild(pop()) ;
                /// element.parentElement gets parent so we can *move* 

                <selftest>
                    marker --- 
                    null value aa // ( -- element )
                    null value bb // ( -- element )
                    *** createElement creates an HTML element, you name whatever tagName you like!
                        char AAA createElement to aa aa :> tagName ( AAA )
                        [d "AAA" d] [p "createElement" p]
                    *** setAttribute can be any name:value pair
                        aa char bbb char ccc setAttribute 
                        aa char bbb getAttribute
                        [d 'ccc' d] [p "setAttribute","getAttribute" p]
                    js> document.getElementsByClassName [if] \ skip old IE/HTA
                        *** appendChild appends child element to parent element
                            char BBB createElement to bb bb :> tagName ( BBB )
                            aa :> childElementCount \ 0 
                            aa bb appendChild 
                            aa :> childElementCount \ 1
                            [d "BBB",0,1 d] [p "appendChild" p]
                    [then]
                    ---
                </selftest>
    
: getElementById ( "id" -- element ) \ Get element object by ID
                js> document.getElementById(pop()) ;
                
: getAttribute  ( oElement "attr" -- ) \ Get an attribute value of an element
                js> pop(1).getAttribute(pop()) ;

: replaceNode  ( newNode targetNode -- ) \ Replace a HTML node or element
                js: $(pop()).replaceWith(pop()) ;
                /// jQuery replaceWith() http://api.jquery.com/replaceWith/

: insertBefore  ( target ref -- ) \ *Move* the target element to before the reference element
                js: tos().parentElement.insertBefore(pop(1),pop()) ;
                /// insertBefore() method see https://www.evernote.com/shard/s22/nl/2472143/9d97ceec-8374-4ac8-baab-f3f599ecfba4

: insertAfter   ( target ref -- ) \ *Move* the target element to after the reference element
                js> tos().nextElementSibling if 
                    js> pop().nextElementSibling
                    js: tos().parentElement.insertBefore(pop(1),pop()) 
                else
                    js: pop().parentElement.appendChild(pop())
                then
                ;
                /// insertBefore() method see https://www.evernote.com/shard/s22/nl/2472143/9d97ceec-8374-4ac8-baab-f3f599ecfba4

: lastChild     ( parent -- element ) \ Get the last child of the given element.
                js> pop().lastChild ;

: lastElementChild      
                ( parent -- element ) \ Get the last element child of the given element.
                js> pop().lastElementChild ;
                
: removeElement ( element -- ) \ Remove an element
                js: tos().parentNode.removeChild(pop()) ;

: eleHead       ( -- element ) \ Get <head> element
                js> document.getElementsByTagName('head')[0] ;
                /// js> document.getElementsByTagName('head')[0]==$('head')[0] ==> true
                /// js> $('head')[0]==document.head ==> true
                
: eleBody       ( -- element ) \ Get <body> element
                js> document.getElementsByTagName('body')[0] ;
                /// js> document.getElementsByTagName('body')[0]==$('body')[0] ==> true
                /// js> $('body')[0]==document.body ==> true

: eleDisplay    ( -- element ) \ Get console output screen element
                js> document.getElementById('outputbox') ;
                /// js> document.getElementById('outputbox')==$('#outputbox')[0] ==> true
                /// js> $('#outputbox')[0]==outputbox ==> true

: doElement     ( "html" "jqSelector" -- element ) \ Run time of <e>,<h> or the likes.
                js> $(pop()).append(pop())[0] lastChild ;
                /// Example: char #outputbox char <h1>Hello</h1> doElement
                \ Must use jQuery append(), because HTMLelement.appendChild(node) is not suitable
                
: <e>           ( "jQuery selector" <html> -- "html" ) \ HTML section header. Get HTML tags.
                char (</e>|</o>|</h>|</text>) word
                compiling if literal then ; immediate
                /// Section ending can be </e> </o> or </h> for general element, outputbox, and 
                /// header respectively, so far. Also </text> for debug.
                last dup alias <o> immediate // ( <html> -- "html" ) Starting a HTML section append to output box.
                alias <h> immediate // ( <html> -- "html" ) Starting a HTML section append to <HEAD>. 
                
: /*remove*/    ( "raw" -- "cooked" ) \ remove /* comments in multiple lines */ 
                :> replace(/[/]\*(.|\r|\n)*?\*[/]/mg,"") ; \ HTA 不能用 \/ 必須用 [/]
                /// 使 /* ... */ 可以用在 HTML 裡面。
                /// Support multiple comment lines in one pare of /* .. */
                /// Not support nested.

: </o>          ( "html" -- element ) \ Delimiter of <o>, (O)utputbox.
                compiling if compile /*remove*/ compile trim else /*remove*/ trim then
                char #outputbox compiling 
                if literal compile doElement 
                else doElement then ; immediate
                
code <o>escape  ( "HTML lines" -- "cooked" ) \ Convert <o> </o> to &lt;o&gt;brabrabra
                var ss = pop()||"";
                var result = ss
                    .replace(/<o>/mg,"&lt;o&gt;")
                    .replace(/<[/]o>/mg,"&lt;/o&gt;")
                    ||"";
                push(result);
                end-code
                /// Support multiple lines
                /// Usage: "string" </o> when "string" contains <o></o>.

: </h>          ( "html" -- element ) \ Delimiter of <h>, (H)ead section.
                compiling if compile /*remove*/ compile trim else /*remove*/ trim then
                char head compiling 
                if literal compile doElement 
                else doElement then ; immediate

: </e>          ( "jQuery selector" "html" -- element ) \ Delimiter of <e>, general purpose.
                compiling if compile /*remove*/ compile trim else /*remove*/ trim then
                compiling if compile swap compile doElement 
                else swap doElement then ; immediate
                /// Example: char #outputbox <e> <h1>hi</h1></e>

: open          ( "http://url" "name" -- win ) \ Open the URL return the window element named 'name' for <a> and <form>.
                js> window.open(pop(1),pop()) ;
                /// window.open() method http://www.w3schools.com/jsref/met_win_open.asp
                /// Try "win :: focus()" to switch to the browser window/tab any time.
                /// Try "win :> document.body.innerHTML ." to see HTML body
                /// Try "win :: close()" to close the window
                
                <comment>
                s" http://www.taobao.com/about/copyright.php" s" taobaoCopyright" open \ This page responses fast
                1000 sleep
                js> (tos().document.body.innerHTML).indexOf('浙江淘?网?有限公司') . \ should not be -1
                js: pop().close()
                \ http://www.taobao.com/about/copyright.php
                \ 浙江淘?网?有限公司
                </comment>

: pickFile      ( -- "pathname" ) \ Pick a file through web browser's GUI
                char input createElement ( element )
                dup char type  char file      setAttribute ( element )
                dup char class char pick_file setAttribute ( element ) \ for debug, clue of the element
                \ For none 3hta only, setup the event handler
                js> vm.appname!="jeforth.3hta" if
                    js: tos().onchange=function(){execute('stopSleeping')} ( element ) 
                    js: tos().oncancel=function(){execute('stopSleeping')} ( element ) 
                then
                js> body over appendChild \ 要 append 才有作用。 ( element )
                js: tos().click() ( element ) \ @ HTA 回來就表示 user 已經完成操作, @ NW.js 則馬上回來。
                \ For none 3hta only, wait for the onchange event
                js> vm.appname!="jeforth.3hta" if
                    ( minutes*60*1000 ) js> 5*60*1000 sleep ( element ) then
                js> tos().value \ 即使 timeout 也不管了 ( element path )  
                swap removeElement ; ( path )  
                /// Works fine on 3hta and 3nw. The dialog works but returns Null string on 3htm 
                /// or C:\fakepath\__865.jpg on 3ce. See Ynote : "jeforth.3we fix pickFile 
                /// problem on 3nw. Get full path of local file." for my developing log.
                /// Through excel app's GetOpenFilename method can do the same thing:
                ///     excel.app js> pop().GETopenFILENAME <== with or w/o () both fine
                /// Excel's GetSaveAsFilename method too.

: input.file    ( -- element ) \ Place a file input HTMLelement
                <o> <input type=file></o> ;
                \ This word is for demo. Use <e> or <o> directly is preferred. Usage: pop().value

: input.radio   ( value name -- element ) \ Place a HTML radio button [object HTMLInputElement]
                <o> <input type=radio></o> dup >r ( v n e )
                swap over ( v e n e ) char name ( v e n e 'name' ) rot ( v e e 'name' n ) setAttribute ( v e )
                swap ( e v ) char value ( e v 'value' ) swap ( e 'value' v ) setAttribute r> ;
                /// We need this command for programmatic-dynamical cases.
                /// Properties are tos().value, tos().checked, tos().name 
                /// All radio buttons of the same 'name' attribute are grouped together as a [object HTMLCollection]
                /// document.body.children.hta.children.outputbox.children.<name> is the [object HTMLCollection]
                /// document.getElementsByName("<name>").item(0).checked=true Set default at a item
                /// Best use jQuery js> $('input[name=<name>]:checked').val() Note! undefined if nothing selected. 
                /// See http://stackoverflow.com/questions/596351/how-can-i-get-which-radio-is-selected-via-jquery

                <comment>
                  char value1 char rrr input.radio drop <o> <div> 1111111</div></o> drop
                  char value2 char rrr input.radio drop <o> <div> 2222222</div></o> drop
                  char value3 char rrr input.radio drop <o> <div> 3333333</div></o> drop
                  char value4 char rrr input.radio drop <o> <div> 4444444</div></o> drop
                  js> $('input[name=rrr]:checked').val() . cr \ ==> undefined until one of them is checked.
                  \ The value would thus be one of value1,value2..valuen
                </comment>
                
: ^node         ( ele -- ele ) \ Get previous sibling node
                js> pop().previousSibling ;
                /// see also element.previousElementSibling
: node^         ( ele -- ele ) \ Get next sibling node
                js> pop().nextSibling ;
                /// see also element.nextElementSibling

: children      ( ele -- array ) \ All children of the element
                js> typeof(tos())!='object' if . ."  is not a HTML-Element!" cr [] exit then
                js> pop().firstChild ( first )
                ?dup if ( first ) else ( empty ) [] exit then ( first ) 
                [] swap ( [] 1st ) begin ( [] ele )
                    js> tos(1).push(tos());pop().nextSibling ( [] ele' )
                dup not until
                drop ;
                /// Leaves an empty array if the input is not an object.
                /// But the input element can have no child.

: []children    ( ele n -- array ) \ Beginning n child nodes of the element
                swap js> pop().firstChild ( n first )
                ?dup if ( n first ) else ( n ) drop [] exit then ( n first ) 
                [] -rot ( [] n 1st ) swap for ( [] ele )
                    js> tos(1).push(tos());pop().nextSibling ( [] ele' )
                    dup if else r> drop 0 >r then
                next
                drop ;
                /// Example: dropall js> outputbox 10 []children <== get an array 
                ///          of leading 10 child nodes to TOS.

: children[]    ( ele n -- array ) \ Ending n child nodes of the element
                swap js> pop().lastChild ( n ele )
                ?dup if ( n ele ) else ( n ) drop [] exit then ( n ele ) 
                [] -rot ( [] n ele ) swap for ( [] ele )
                    js> tos(1).unshift(tos());pop().previousSibling ( [] ele' )
                    dup if else r> drop 0 >r then
                next
                drop ;
                /// Example: dropall js> outputbox 10 children[] <== get an array 
                ///          of ending 10 child nodes to TOS.

: remove-script-from-HTML ( "HTML" -- "HTML'" ) \ Remove script tags
                :> replace(/\r\n/mg,"{_cr_}")   \ for Windows
                :> replace(/\n/mg,"{_cr_}") \ replace cr with _cr_ makes below operations easier
                :> replace(/<script.*?script>/g,"")     \ remove all <script> tags
                :> replace(/{_cr_}/g,"\n") ;
                /// See also remove-script-from-element in ie.f.
                /// Use RexEx word processing method.
                
: remove-style-from-HTML ( "HTML" -- "HTML'" ) \ Remove CSS style tags
                :> replace(/\r\n/mg,"{_cr_}")   \ for Windows
                :> replace(/\n/mg,"{_cr_}") \ replace cr with _cr_ makes below operations easier
                :> replace(/<style.*?style>/g,"")       \ remove all <style> tags
                :> replace(/{_cr_}/g,"\n") ;
                /// See also remove-script-from-element in ie.f.
                /// Use RexEx word processing method.
                
: remove-select-from-HTML ( "HTML" -- "HTML'" ) \ Remove scripts and other things
                :> replace(/\r\n/mg,"{_cr_}")   \ for Windows
                :> replace(/\n/mg,"{_cr_}") \ replace cr with _cr_ makes below operations easier
                :> replace(/<select.*?select>/g,"")     \ remove all <select>
                :> replace(/{_cr_}/g,"\n") ;
                /// Use RexEx word processing method.
                
: remove-onmouse-from-HTML ( "HTML" -- "HTML'" ) \ Remove onmouseXX="dothis"  onmouseXX=dothat onmouseXX='dowhat' listenings.
                :> replace(/\r\n/mg,"{_cr_}")   \ for Windows
                :> replace(/\n/mg,"{_cr_}") \ replace cr with _cr_ makes below operations easier
                <js> pop().replace(/\s+onmouse.+?=\s?\S+/g,"")</jsV> 
                :> replace(/{_cr_}/g,"\n") ;
                /// Use RexEx word processing method.

    
    </textarea><!-- html5_f box --> 
    <textarea hidden id="element_f" cols=140 rows=10>

    s" element.f" source-code-header

    <comment>

            ☆☆☆ 類似 DOS cd + dir 的 ce 命令組，用來探索 HTML 結構 ☆☆☆

    這組命令方便咱對網頁內容的探索。類似 CP/M, MS-DOS 對 directory 的探索用 cd 命令，咱
    對 HTML 網頁樹狀結構的探索則用 ce 命令。同一個命令有兩個意思： change element 用來移
    動目光焦點； 而 current element 則列出目光焦點上的 element ── 取決於隨後的 argument。
    
    element 是帶有 children 的 node -- node 比較廣泛，但因我們通常對 HTML element
    比較感興趣，故 ce 命令引 element 為名，其實探索 HTML tree 時遇到 none element 的
    node 也是照樣使用。
    
    Pointing to the 目光焦點所在的 current element 是個 stack 結構，而非單一 variable. 原因
    是調皮的 HTML 探索者可以把 current-element 殺掉（html5.f 有 removeElement 命令），此後 
    current-element 就斷鏈了， current-element 是個 stack ( ce-history ) 結構，前一任
    的 current-element 就可以 pop 回來頂替。為避免出錯，我選擇從 ce@ 讀取 current-element
    命令時下手。
    
    如何得知 ce-history.tos 是個 dead element? ==> parentNode == null 
    注意 window 沒有 parentNode 屬性， window.document 的 parentNode 是 null。要特別處理。 
    
    </comment>
    

    [] constant ce-history // ( -- array ) Visited current-element history

    : ce! ce-history js: pop().push(pop()) ; // ( element -- ) Set current-element
        /// 非 element 的雜物可以放進去,但 ce@ 有防呆會把它丟掉。
    
    \ Default current-element points to outputbox if existing.
    js> document.getElementById("outputbox") ?dup [if] [else] js> document [then] ce! 
    
    : ce@ ( -- element ) \ Get current-element
        ce-history :> length if else js> window.document ce! then \ guarantee history is not empty
        ce-history js> tos()[pop().length-1] ( history.tos )
        js> mytypeof(tos())=='object'&&tos().parentNode  ( history.tos flag ) if else \ element may be destroyed 
            js> tos()==window.document if else 
                cr ." Warning! Abnormal current-element." cr
                \ drop ce-history js> tos().pop();tos()[pop().length-1] 
            then
        then ;
        /// Error proof, return previous history ce, or window.document if history is empty.
        /// ce@ :> childNodes[i] to access child nodes.

    code <>escape ( "lines" -- "cooked" ) \ '<' '>' to "&lt;" "&gt;"
        var result = pop().replace(/</mg,"&lt;").replace(/>/mg,"&gt;");
        push(result);
        end-code
        /// Support multiple lines

    :  jump-to-ce@  ( -- ) \ Jump to the target position
        ce@ :> nodeName=="#text" if
            \ 以下步驟把 #text 改裝成暫時的 <span>
            s" <span id=tempSpan>" 
            ce@ :> nodeValue <>escape + 
            char </span> + </o>
            dup  ( tempElement tempElement )
            ce@ replaceNode \ 替換原來的 #text
            ce! \ ce 改成替換過的
        then \ 以上很成功，把原 #text 改裝成 <span> 這樣才 scrollTo() 得過去
        ce@ js: window.scrollTo(0,pop().offsetTop) \ jump to ce@'s position
        ce@ :> id=="tempSpan" if
            \ 以下步驟剝除暫時的 <span>
            ce@ :> innerHTML <>escape \ #text 交給 </o> 要避免 <東西> 被翻譯
            </o> ( original#text ) 
            ce@ insertAfter \ 原 #text 接在 ce@ 後面
            ce@ :> nextSibling \ 取得原 #text 
            ce@ ( 暫時的 <span> ) removeElement 
            ce! \ 以接在後面的原 #text 取代 ce 
        then \ 一番迂迴轉進以上成功了
        ;  
        /// 沒有 jump-to-node 因為過程中原 #text node 會發生變
        /// 化，所也要靠 ce 來保持聯繫。

    : se ( element -- ) \ See the element
        dup children ( -- element array ) <js> 
            var i=0, a=pop(), element=pop(); if (typeof(element)=='object') {
                type(node(element)+'\n');
                for(; i<a.length; i++){
                    push(i);dictate('5 .r');
                    type(" : " + node(a[i]) + '\n');
                }
            }
            function attr(ele,att) {
                var v = "";
                if (ele.getAttribute && ele.getAttribute(att)) {
                    v = att + "='" + ele.getAttribute(att) + "'; ";
                }
                return v;
            }
            function text(len, s) {
                return (s.replace(/\s+/gm,' ').slice(0,100-len) + '...');
            }
            function node(ele){
                var s = ele.toString() + ' ';
                s += attr(ele,'id') + attr(ele,'class') + attr(ele,'name');
                if (ele.innerHTML) s += 'innerHTML=' + text(s.length+10,ele.innerHTML);
                else if (ele.textContent) s += text(s.length,ele.textContent);
                return s;
            }
        </js> ;
        /// Error-proof, do nothing if given element illegal.

    code (ce) ( destination -- ce@ ) \ Change element like cd does. Destination:(index,"..",'<','>','pop')
        var index=pop(); execute("ce@");/*ce@ 有防呆*/ var ce=pop();
        switch( index ){
            case "..": ce = ce.parentNode; break; // can be null
            case "<" : ce = ce.previousSibling; break; // can be null
            case ">" : ce = ce.nextSibling; break; // can be null
            case "pop" : dictate("ce-history :: pop() ce@");ce=pop(); break; // can be null
            default  : 
                if(isNaN(index)) ce=null;
                else ce = ce.childNodes[parseInt(index)]; // can be undefined
        }
        if (!ce) panic("Error! illegal destination: " + index + ". Stay recent ce.\n");
        else { push(ce); execute("ce!"); }
        execute("ce@");
        end-code
        /// Stay recent ce if destination 
        
    : ce ( [<'index'>] -- ) \ change element to ce@ :> childNode[index] or '..', '<', '>', 'pop'
        BL word ( -- 'index' ) ?dup if (ce) else ce@ then se ; interpret-only
        /// if nothing given then see current element
        /// Use 'se' in compiling mode if that's what you want to do.
        /// '..' change element to parent of ce@
        /// '<' and '>' change element to sibling of ce@
        /// 'pop' change element to previous ce.
    

    : ce< ( -- ) \ Change element to the previous current-element
        ce-history :: pop() ce@ se ;
    
    : (er) ( element -- ) \ Erase children of [object Text]
        children ( -- array ) <js> 
            for(var a=pop(),i=a.length-1; i>=0; i--) {
                // if (a[i].toString()=='[object Text]'||a[i].toString()=='[object HTMLBRElement]') {
                if (a[i].nodeName=='#text'||a[i].nodeName=='BR') {
                    push(a[i]);
                    execute('removeElement');
                }
            }
        </js> ;

    : er ce@ (er) ; // ( -- ) Erase current element text node and br

    : list-links ( element -- ) \ List HTML links under the element
        :> links ?dup if dup :> length ?dup if ( links length ) 
        dup for dup r@ - ( links length i ) 
        dup . space js> tos(2)[pop()].innerHTML </o> drop cr
        next drop then then ;
    \ 這裡面的 on???="..." 這些 attributes 都要先刪掉。如何取得?
        
<comment>
    page js> tos()[tos().length-1].toString() .s
    
    0 value body.children // ( -- array ) the window.body children array
    : test
    eleBody js> vm.appname char jeforth.3hta == if :> firstChild then ( -- body or HTA )
    100 []children to body.children
    body.children dup :> length ( -- array len )
    <js> for(var i=0,l=pop(),a=pop(); i<l; i++) {
        type(i+":"+a[i].toString()+'\n')
    } </js>
    ;
    
    it works fine on jeforth.3htm
        0:[object Text]
        1:[object HTMLDivElement]
        2:[object Text]
        3:[object HTMLDivElement]
        4:[object HTMLParagraphElement]
        5:[object HTMLDivElement]
        6:[object Text]
        7:[object HTMLDivElement]
        8:[object HTMLDivElement]
        9:[object HTMLDivElement]
        10:[object HTMLDivElement]  
        
    but not so good on jeforth.3hta
        OK test
        0:[object HTMLUnknownElement]
        OK  
    because HTA has a layer between eleBody and the real thing. Let's see
    
    this is 3HTA
    OK eleBody :> firstChild .
    [object HTMLUnknownElement] OK  <===== 應該就是 HTA
    eleBody :> firstChild.parentElement .
    [object HTMLBodyElement] OK  <============================== 往上沒問題 HTA 同 HTM    
    eleBody :> firstChild.parentElement.parentElement .
    [object HTMLHtmlElement] OK  <============================== 往上沒問題 HTA 同 HTM 
    
    eleBody :> firstChild.firstChild . <===== <body> 以下的第一個 child 應該是 HTA 
    [object Text] OK                          在往下才是一般的 elements
    
    eleBody :> firstChild obj>keys . <==== 看看這一層神祕的 element 有啥東西。。。
    windowState,borderStyle,version,maximizeButton,minimizeButton,selection,border,
    innerBorder,commandLine,scroll,caption,applicationName,scrollFlat,showInTaskBar,
    singleInstance,contextMenu,sysMenu,icon,recordset,namedRecordset,currentStyle,
    runtimeStyle,accessKey,className,contentEditable,dir,disabled,id,innerHTML,
    isContentEditable,lang,offsetHeight,offsetLeft,offsetParent,offsetTop,offsetWidth   
    其中有 commandLine 印出來看，證實這個直屬於 <body> 的 element 正是 HTA. 所以
    eleBody :> firstChild.commandLine .  ==> "C:\Users\8304018.WKSCN\Dropbox\learnings\github\jeforth.3we\jeforth.hta" cls include alarm.f OK 
    OK eleBody :> firstChild.scopeName . ==> HTA 證實是他沒錯。
    eleBody :> firstChild.commandLine . <=== 也可以。 不懂為何放在 <body> 之下？因為每個 <body> 可以有
    自己的 HTA 嗎？ 有可能，因此乾脆全部都放在 <body> 下面，贊成！
    
    this is 3htm
    OK eleBody :> firstChild .
    [object Text] OK 
    OK eleBody :> firstChild.parentElement .
    [object HTMLBodyElement] OK  <============================== 往上沒問題 HTA 同 HTM 
    eleBody :> firstChild.parentElement.parentElement .
    [object HTMLHtmlElement] OK  <============================== 往上沒問題 HTA 同 HTM
    OK eleBody :> firstChild  .   <===== <body> 以下的第一個 child 是正常的 elements
    [object Text] OK 
    eleBody :> firstChild.firstChild . ==> null 
    
    查所有已知的 element 看有何共同特性，查 dead element 的 parentNode (不一定有 parentElement)
    [object Window] top,window,location,external,chrome,document,$,jQuery,kvm,script1423203618871,speechSynthesis,webkitStorageInfo,indexedDB,webkitIndexedDB,crypto,localStorage,sessionStorage,applicationCache,CSS,performance,console,devicePixelRatio,styleMedia,parent,opener,frames,self,defaultstatus,defaultStatus,status,name,length,closed,pageYOffset,pageXOffset,scrollY,scrollX,screenTop,screenLeft,screenY,screenX,innerWidth,innerHeight,outerWidth,outerHeight,offscreenBuffering,frameElement,clientInformation,navigator,toolbar,statusbar,scrollbars,personalbar,menubar,locationbar,history,screen,ondeviceorientation,ondevicemotion,postMessage,close,blur,focus,onautocompleteerror,onautocomplete,ontouchstart,ontouchmove,ontouchend,ontouchcancel,onunload,onstorage,onpopstate,onpageshow,onpagehide,ononline,onoffline,onmessage,onlanguagechange,onhashchange,onbeforeunload,onwaiting,onvolumechange,ontoggle,ontimeupdate,onsuspend,onsubmit,onstalled,onshow,onselect,onseeking,onseeked,onscroll,onresize,onreset,onratechange,onprogress,onplaying,onplay,onpause,onmousewheel,onmouseup,onmouseover,onmouseout,onmousemove,onmouseleave,onmouseenter,onmousedown,onloadstart,onloadedmetadata,onloadeddata,onload,onkeyup,onkeypress,onkeydown,oninvalid,oninput,onfocus,onerror,onended,onemptied,ondurationchange,ondrop,ondragstart,ondragover,ondragleave,ondragenter,ondragend,ondrag,ondblclick,oncuechange,oncontextmenu,onclose,onclick,onchange,oncanplaythrough,oncanplay,oncancel,onblur,onabort,onwheel,onwebkittransitionend,onwebkitanimationstart,onwebkitanimationiteration,onwebkitanimationend,ontransitionend,onsearch,getSelection,print,stop,open,alert,confirm,prompt,find,scrollBy,scrollTo,scroll,moveBy,moveTo,resizeBy,resizeTo,matchMedia,getComputedStyle,getMatchedCSSRules,requestAnimationFrame,cancelAnimationFrame,webkitRequestAnimationFrame,webkitCancelAnimationFrame,webkitCancelRequestAnimationFrame,captureEvents,releaseEvents,btoa,atob,setTimeout,clearTimeout,setInterval,clearInterval,TEMPORARY,PERSISTENT,webkitRequestFileSystem,webkitResolveLocalFileSystemURL,openDatabase,addEventListener,removeEventListener,dispatchEvent  
    [object HTMLDocument] vlinkColor,linkColor,alinkColor,fgColor,bgColor,compatMode,all,onautocompleteerror,onautocomplete,ontouchstart,ontouchmove,ontouchend,ontouchcancel,rootElement,childElementCount,lastElementChild,firstElementChild,children,onwaiting,onvolumechange,ontoggle,ontimeupdate,onsuspend,onsubmit,onstalled,onshow,onselect,onseeking,onseeked,onscroll,onresize,onreset,onratechange,onprogress,onplaying,onplay,onpause,onmousewheel,onmouseup,onmouseover,onmouseout,onmousemove,onmouseleave,onmouseenter,onmousedown,onloadstart,onloadedmetadata,onloadeddata,onload,onkeyup,onkeypress,onkeydown,oninvalid,oninput,onfocus,onerror,onended,onemptied,ondurationchange,ondrop,ondragstart,ondragover,ondragleave,ondragenter,ondragend,ondrag,ondblclick,oncuechange,oncontextmenu,onclose,onclick,onchange,oncanplaythrough,oncanplay,oncancel,onblur,onabort,onwebkitfullscreenerror,onwebkitfullscreenchange,webkitFullscreenElement,webkitFullscreenEnabled,webkitCurrentFullScreenElement,webkitFullScreenKeyboardInputAllowed,webkitIsFullScreen,fonts,currentScript,webkitHidden,webkitVisibilityState,hidden,visibilityState,onwheel,onselectstart,onselectionchange,onsearch,onreadystatechange,onpointerlockerror,onpointerlockchange,onpaste,oncut,oncopy,onbeforepaste,onbeforecut,onbeforecopy,pointerLockElement,activeElement,selectedStylesheetSet,preferredStylesheetSet,characterSet,readyState,defaultCharset,charset,location,lastModified,anchors,scripts,forms,links,plugins,embeds,applets,images,head,body,cookie,URL,domain,referrer,title,designMode,dir,contentType,styleSheets,defaultView,documentURI,xmlStandalone,xmlVersion,xmlEncoding,inputEncoding,documentElement,implementation,doctype,parentElement,textContent,baseURI,localName,namespaceURI,ownerDocument,nextSibling,previousSibling,lastChild,firstChild,childNodes,parentNode,nodeType,nodeValue,nodeName,open,close,write,writeln,clear,captureEvents,releaseEvents,createDocumentFragment,createTextNode,createComment,createCDATASection,createProcessingInstruction,createAttribute,getElementsByTagName,importNode,createAttributeNS,getElementsByTagNameNS,getElementById,adoptNode,createEvent,createRange,createNodeIterator,createTreeWalker,getOverrideStyle,execCommand,queryCommandEnabled,queryCommandIndeterm,queryCommandState,queryCommandSupported,queryCommandValue,getElementsByName,elementFromPoint,caretRangeFromPoint,getSelection,getCSSCanvasContext,getElementsByClassName,hasFocus,exitPointerLock,registerElement,createElement,createElementNS,webkitCancelFullScreen,webkitExitFullscreen,querySelector,querySelectorAll,createExpression,createNSResolver,evaluate,createTouch,createTouchList,insertBefore,replaceChild,removeChild,appendChild,hasChildNodes,cloneNode,normalize,isSameNode,isEqualNode,lookupPrefix,isDefaultNamespace,lookupNamespaceURI,compareDocumentPosition,contains,ELEMENT_NODE,ATTRIBUTE_NODE,TEXT_NODE,CDATA_SECTION_NODE,ENTITY_REFERENCE_NODE,ENTITY_NODE,PROCESSING_INSTRUCTION_NODE,COMMENT_NODE,DOCUMENT_NODE,DOCUMENT_TYPE_NODE,DOCUMENT_FRAGMENT_NODE,NOTATION_NODE,DOCUMENT_POSITION_DISCONNECTED,DOCUMENT_POSITION_PRECEDING,DOCUMENT_POSITION_FOLLOWING,DOCUMENT_POSITION_CONTAINS,DOCUMENT_POSITION_CONTAINED_BY,DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC,addEventListener,removeEventListener,dispatchEvent
    [object Comment]
    [object DocumentType]
    [object HTMLBRElement]
    [object HTMLBodyElement]
    [object HTMLCanvasElement] height,width,onautocompleteerror,onautocomplete,onwaiting,onvolumechange,ontoggle,ontimeupdate,onsuspend,onsubmit,onstalled,onshow,onselect,onseeking,onseeked,onscroll,onresize,onreset,onratechange,onprogress,onplaying,onplay,onpause,onmousewheel,onmouseup,onmouseover,onmouseout,onmousemove,onmouseleave,onmouseenter,onmousedown,onloadstart,onloadedmetadata,onloadeddata,onload,onkeyup,onkeypress,onkeydown,oninvalid,oninput,onfocus,onerror,onended,onemptied,ondurationchange,ondrop,ondragstart,ondragover,ondragleave,ondragenter,ondragend,ondrag,ondblclick,oncuechange,oncontextmenu,onclose,onclick,onchange,oncanplaythrough,oncanplay,oncancel,onblur,onabort,spellcheck,isContentEditable,contentEditable,outerText,innerText,accessKey,hidden,webkitdropzone,draggable,tabIndex,dir,translate,lang,title,ontouchstart,ontouchmove,ontouchend,ontouchcancel,childElementCount,lastElementChild,firstElementChild,children,onwebkitfullscreenerror,onwebkitfullscreenchange,nextElementSibling,previousElementSibling,onwheel,onselectstart,onsearch,onpaste,oncut,oncopy,onbeforepaste,onbeforecut,onbeforecopy,shadowRoot,dataset,classList,className,outerHTML,innerHTML,scrollHeight,scrollWidth,scrollTop,scrollLeft,clientHeight,clientWidth,clientTop,clientLeft,offsetParent,offsetHeight,offsetWidth,offsetTop,offsetLeft,localName,prefix,namespaceURI,id,style,attributes,tagName,parentElement,textContent,baseURI,ownerDocument,nextSibling,previousSibling,lastChild,firstChild,childNodes,parentNode,nodeType,nodeValue,nodeName,toDataURL,getContext,click,getAttribute,setAttribute,removeAttribute,getAttributeNode,setAttributeNode,removeAttributeNode,getElementsByTagName,hasAttributes,getAttributeNS,setAttributeNS,removeAttributeNS,getElementsByTagNameNS,getAttributeNodeNS,setAttributeNodeNS,hasAttribute,hasAttributeNS,matches,focus,blur,scrollIntoView,scrollIntoViewIfNeeded,getElementsByClassName,insertAdjacentElement,insertAdjacentText,insertAdjacentHTML,webkitMatchesSelector,createShadowRoot,getDestinationInsertionPoints,getClientRects,getBoundingClientRect,requestPointerLock,animate,remove,webkitRequestFullScreen,webkitRequestFullscreen,querySelector,querySelectorAll,ALLOW_KEYBOARD_INPUT,insertBefore,replaceChild,removeChild,appendChild,hasChildNodes,cloneNode,normalize,isSameNode,isEqualNode,lookupPrefix,isDefaultNamespace,lookupNamespaceURI,compareDocumentPosition,contains,ELEMENT_NODE,ATTRIBUTE_NODE,TEXT_NODE,CDATA_SECTION_NODE,ENTITY_REFERENCE_NODE,ENTITY_NODE,PROCESSING_INSTRUCTION_NODE,COMMENT_NODE,DOCUMENT_NODE,DOCUMENT_TYPE_NODE,DOCUMENT_FRAGMENT_NODE,NOTATION_NODE,DOCUMENT_POSITION_DISCONNECTED,DOCUMENT_POSITION_PRECEDING,DOCUMENT_POSITION_FOLLOWING,DOCUMENT_POSITION_CONTAINS,DOCUMENT_POSITION_CONTAINED_BY,DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC,addEventListener,removeEventListener,dispatchEvent OK
    [object HTMLDivElement] align,onautocompleteerror,onautocomplete,onwaiting,onvolumechange,ontoggle,ontimeupdate,onsuspend,onsubmit,onstalled,onshow,onselect,onseeking,onseeked,onscroll,onresize,onreset,onratechange,onprogress,onplaying,onplay,onpause,onmousewheel,onmouseup,onmouseover,onmouseout,onmousemove,onmouseleave,onmouseenter,onmousedown,onloadstart,onloadedmetadata,onloadeddata,onload,onkeyup,onkeypress,onkeydown,oninvalid,oninput,onfocus,onerror,onended,onemptied,ondurationchange,ondrop,ondragstart,ondragover,ondragleave,ondragenter,ondragend,ondrag,ondblclick,oncuechange,oncontextmenu,onclose,onclick,onchange,oncanplaythrough,oncanplay,oncancel,onblur,onabort,spellcheck,isContentEditable,contentEditable,outerText,innerText,accessKey,hidden,webkitdropzone,draggable,tabIndex,dir,translate,lang,title,ontouchstart,ontouchmove,ontouchend,ontouchcancel,childElementCount,lastElementChild,firstElementChild,children,onwebkitfullscreenerror,onwebkitfullscreenchange,nextElementSibling,previousElementSibling,onwheel,onselectstart,onsearch,onpaste,oncut,oncopy,onbeforepaste,onbeforecut,onbeforecopy,shadowRoot,dataset,classList,className,outerHTML,innerHTML,scrollHeight,scrollWidth,scrollTop,scrollLeft,clientHeight,clientWidth,clientTop,clientLeft,offsetParent,offsetHeight,offsetWidth,offsetTop,offsetLeft,localName,prefix,namespaceURI,id,style,attributes,tagName,parentElement,textContent,baseURI,ownerDocument,nextSibling,previousSibling,lastChild,firstChild,childNodes,parentNode,nodeType,nodeValue,nodeName,click,getAttribute,setAttribute,removeAttribute,getAttributeNode,setAttributeNode,removeAttributeNode,getElementsByTagName,hasAttributes,getAttributeNS,setAttributeNS,removeAttributeNS,getElementsByTagNameNS,getAttributeNodeNS,setAttributeNodeNS,hasAttribute,hasAttributeNS,matches,focus,blur,scrollIntoView,scrollIntoViewIfNeeded,getElementsByClassName,insertAdjacentElement,insertAdjacentText,insertAdjacentHTML,webkitMatchesSelector,createShadowRoot,getDestinationInsertionPoints,getClientRects,getBoundingClientRect,requestPointerLock,animate,remove,webkitRequestFullScreen,webkitRequestFullscreen,querySelector,querySelectorAll,ALLOW_KEYBOARD_INPUT,insertBefore,replaceChild,removeChild,appendChild,hasChildNodes,cloneNode,normalize,isSameNode,isEqualNode,lookupPrefix,isDefaultNamespace,lookupNamespaceURI,compareDocumentPosition,contains,ELEMENT_NODE,ATTRIBUTE_NODE,TEXT_NODE,CDATA_SECTION_NODE,ENTITY_REFERENCE_NODE,ENTITY_NODE,PROCESSING_INSTRUCTION_NODE,COMMENT_NODE,DOCUMENT_NODE,DOCUMENT_TYPE_NODE,DOCUMENT_FRAGMENT_NODE,NOTATION_NODE,DOCUMENT_POSITION_DISCONNECTED,DOCUMENT_POSITION_PRECEDING,DOCUMENT_POSITION_FOLLOWING,DOCUMENT_POSITION_CONTAINS,DOCUMENT_POSITION_CONTAINED_BY,DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC,addEventListener,removeEventListener,dispatchEvent
    [object HTMLHeadElement]
    [object HTMLHtmlElement] version,onautocompleteerror,onautocomplete,onwaiting,onvolumechange,ontoggle,ontimeupdate,onsuspend,onsubmit,onstalled,onshow,onselect,onseeking,onseeked,onscroll,onresize,onreset,onratechange,onprogress,onplaying,onplay,onpause,onmousewheel,onmouseup,onmouseover,onmouseout,onmousemove,onmouseleave,onmouseenter,onmousedown,onloadstart,onloadedmetadata,onloadeddata,onload,onkeyup,onkeypress,onkeydown,oninvalid,oninput,onfocus,onerror,onended,onemptied,ondurationchange,ondrop,ondragstart,ondragover,ondragleave,ondragenter,ondragend,ondrag,ondblclick,oncuechange,oncontextmenu,onclose,onclick,onchange,oncanplaythrough,oncanplay,oncancel,onblur,onabort,spellcheck,isContentEditable,contentEditable,outerText,innerText,accessKey,hidden,webkitdropzone,draggable,tabIndex,dir,translate,lang,title,ontouchstart,ontouchmove,ontouchend,ontouchcancel,childElementCount,lastElementChild,firstElementChild,children,onwebkitfullscreenerror,onwebkitfullscreenchange,nextElementSibling,previousElementSibling,onwheel,onselectstart,onsearch,onpaste,oncut,oncopy,onbeforepaste,onbeforecut,onbeforecopy,shadowRoot,dataset,classList,className,outerHTML,innerHTML,scrollHeight,scrollWidth,scrollTop,scrollLeft,clientHeight,clientWidth,clientTop,clientLeft,offsetParent,offsetHeight,offsetWidth,offsetTop,offsetLeft,localName,prefix,namespaceURI,id,style,attributes,tagName,parentElement,textContent,baseURI,ownerDocument,nextSibling,previousSibling,lastChild,firstChild,childNodes,parentNode,nodeType,nodeValue,nodeName,click,getAttribute,setAttribute,removeAttribute,getAttributeNode,setAttributeNode,removeAttributeNode,getElementsByTagName,hasAttributes,getAttributeNS,setAttributeNS,removeAttributeNS,getElementsByTagNameNS,getAttributeNodeNS,setAttributeNodeNS,hasAttribute,hasAttributeNS,matches,focus,blur,scrollIntoView,scrollIntoViewIfNeeded,getElementsByClassName,insertAdjacentElement,insertAdjacentText,insertAdjacentHTML,webkitMatchesSelector,createShadowRoot,getDestinationInsertionPoints,getClientRects,getBoundingClientRect,requestPointerLock,animate,remove,webkitRequestFullScreen,webkitRequestFullscreen,querySelector,querySelectorAll,ALLOW_KEYBOARD_INPUT,insertBefore,replaceChild,removeChild,appendChild,hasChildNodes,cloneNode,normalize,isSameNode,isEqualNode,lookupPrefix,isDefaultNamespace,lookupNamespaceURI,compareDocumentPosition,contains,ELEMENT_NODE,ATTRIBUTE_NODE,TEXT_NODE,CDATA_SECTION_NODE,ENTITY_REFERENCE_NODE,ENTITY_NODE,PROCESSING_INSTRUCTION_NODE,COMMENT_NODE,DOCUMENT_NODE,DOCUMENT_TYPE_NODE,DOCUMENT_FRAGMENT_NODE,NOTATION_NODE,DOCUMENT_POSITION_DISCONNECTED,DOCUMENT_POSITION_PRECEDING,DOCUMENT_POSITION_FOLLOWING,DOCUMENT_POSITION_CONTAINS,DOCUMENT_POSITION_CONTAINED_BY,DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC,addEventListener,removeEventListener,dispatchEvent
    [object HTMLMetaElement]
    [object HTMLParagraphElement] align,onautocompleteerror,onautocomplete,onwaiting,onvolumechange,ontoggle,ontimeupdate,onsuspend,onsubmit,onstalled,onshow,onselect,onseeking,onseeked,onscroll,onresize,onreset,onratechange,onprogress,onplaying,onplay,onpause,onmousewheel,onmouseup,onmouseover,onmouseout,onmousemove,onmouseleave,onmouseenter,onmousedown,onloadstart,onloadedmetadata,onloadeddata,onload,onkeyup,onkeypress,onkeydown,oninvalid,oninput,onfocus,onerror,onended,onemptied,ondurationchange,ondrop,ondragstart,ondragover,ondragleave,ondragenter,ondragend,ondrag,ondblclick,oncuechange,oncontextmenu,onclose,onclick,onchange,oncanplaythrough,oncanplay,oncancel,onblur,onabort,spellcheck,isContentEditable,contentEditable,outerText,innerText,accessKey,hidden,webkitdropzone,draggable,tabIndex,dir,translate,lang,title,ontouchstart,ontouchmove,ontouchend,ontouchcancel,childElementCount,lastElementChild,firstElementChild,children,onwebkitfullscreenerror,onwebkitfullscreenchange,nextElementSibling,previousElementSibling,onwheel,onselectstart,onsearch,onpaste,oncut,oncopy,onbeforepaste,onbeforecut,onbeforecopy,shadowRoot,dataset,classList,className,outerHTML,innerHTML,scrollHeight,scrollWidth,scrollTop,scrollLeft,clientHeight,clientWidth,clientTop,clientLeft,offsetParent,offsetHeight,offsetWidth,offsetTop,offsetLeft,localName,prefix,namespaceURI,id,style,attributes,tagName,parentElement,textContent,baseURI,ownerDocument,nextSibling,previousSibling,lastChild,firstChild,childNodes,parentNode,nodeType,nodeValue,nodeName,click,getAttribute,setAttribute,removeAttribute,getAttributeNode,setAttributeNode,removeAttributeNode,getElementsByTagName,hasAttributes,getAttributeNS,setAttributeNS,removeAttributeNS,getElementsByTagNameNS,getAttributeNodeNS,setAttributeNodeNS,hasAttribute,hasAttributeNS,matches,focus,blur,scrollIntoView,scrollIntoViewIfNeeded,getElementsByClassName,insertAdjacentElement,insertAdjacentText,insertAdjacentHTML,webkitMatchesSelector,createShadowRoot,getDestinationInsertionPoints,getClientRects,getBoundingClientRect,requestPointerLock,animate,remove,webkitRequestFullScreen,webkitRequestFullscreen,querySelector,querySelectorAll,ALLOW_KEYBOARD_INPUT,insertBefore,replaceChild,removeChild,appendChild,hasChildNodes,cloneNode,normalize,isSameNode,isEqualNode,lookupPrefix,isDefaultNamespace,lookupNamespaceURI,compareDocumentPosition,contains,ELEMENT_NODE,ATTRIBUTE_NODE,TEXT_NODE,CDATA_SECTION_NODE,ENTITY_REFERENCE_NODE,ENTITY_NODE,PROCESSING_INSTRUCTION_NODE,COMMENT_NODE,DOCUMENT_NODE,DOCUMENT_TYPE_NODE,DOCUMENT_FRAGMENT_NODE,NOTATION_NODE,DOCUMENT_POSITION_DISCONNECTED,DOCUMENT_POSITION_PRECEDING,DOCUMENT_POSITION_FOLLOWING,DOCUMENT_POSITION_CONTAINS,DOCUMENT_POSITION_CONTAINED_BY,DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC,addEventListener,removeEventListener,dispatchEvent
    [object HTMLQuoteElement]
    [object HTMLScriptElement]
    [object HTMLStyleElement]
    [object HTMLTableElement]
    [object HTMLTextAreaElement] selectionDirection,selectionEnd,selectionStart,labels,validationMessage,validity,willValidate,textLength,value,defaultValue,type,wrap,rows,required,readOnly,placeholder,name,minLength,maxLength,form,disabled,dirName,cols,autofocus,onautocompleteerror,onautocomplete,onwaiting,onvolumechange,ontoggle,ontimeupdate,onsuspend,onsubmit,onstalled,onshow,onselect,onseeking,onseeked,onscroll,onresize,onreset,onratechange,onprogress,onplaying,onplay,onpause,onmousewheel,onmouseup,onmouseover,onmouseout,onmousemove,onmouseleave,onmouseenter,onmousedown,onloadstart,onloadedmetadata,onloadeddata,onload,onkeyup,onkeypress,onkeydown,oninvalid,oninput,onfocus,onerror,onended,onemptied,ondurationchange,ondrop,ondragstart,ondragover,ondragleave,ondragenter,ondragend,ondrag,ondblclick,oncuechange,oncontextmenu,onclose,onclick,onchange,oncanplaythrough,oncanplay,oncancel,onblur,onabort,spellcheck,isContentEditable,contentEditable,outerText,innerText,accessKey,hidden,webkitdropzone,draggable,tabIndex,dir,translate,lang,title,ontouchstart,ontouchmove,ontouchend,ontouchcancel,childElementCount,lastElementChild,firstElementChild,children,onwebkitfullscreenerror,onwebkitfullscreenchange,nextElementSibling,previousElementSibling,onwheel,onselectstart,onsearch,onpaste,oncut,oncopy,onbeforepaste,onbeforecut,onbeforecopy,shadowRoot,dataset,classList,className,outerHTML,innerHTML,scrollHeight,scrollWidth,scrollTop,scrollLeft,clientHeight,clientWidth,clientTop,clientLeft,offsetParent,offsetHeight,offsetWidth,offsetTop,offsetLeft,localName,prefix,namespaceURI,id,style,attributes,tagName,parentElement,textContent,baseURI,ownerDocument,nextSibling,previousSibling,lastChild,firstChild,childNodes,parentNode,nodeType,nodeValue,nodeName,checkValidity,reportValidity,setCustomValidity,select,setRangeText,setSelectionRange,click,getAttribute,setAttribute,removeAttribute,getAttributeNode,setAttributeNode,removeAttributeNode,getElementsByTagName,hasAttributes,getAttributeNS,setAttributeNS,removeAttributeNS,getElementsByTagNameNS,getAttributeNodeNS,setAttributeNodeNS,hasAttribute,hasAttributeNS,matches,focus,blur,scrollIntoView,scrollIntoViewIfNeeded,getElementsByClassName,insertAdjacentElement,insertAdjacentText,insertAdjacentHTML,webkitMatchesSelector,createShadowRoot,getDestinationInsertionPoints,getClientRects,getBoundingClientRect,requestPointerLock,animate,remove,webkitRequestFullScreen,webkitRequestFullscreen,querySelector,querySelectorAll,ALLOW_KEYBOARD_INPUT,insertBefore,replaceChild,removeChild,appendChild,hasChildNodes,cloneNode,normalize,isSameNode,isEqualNode,lookupPrefix,isDefaultNamespace,lookupNamespaceURI,compareDocumentPosition,contains,ELEMENT_NODE,ATTRIBUTE_NODE,TEXT_NODE,CDATA_SECTION_NODE,ENTITY_REFERENCE_NODE,ENTITY_NODE,PROCESSING_INSTRUCTION_NODE,COMMENT_NODE,DOCUMENT_NODE,DOCUMENT_TYPE_NODE,DOCUMENT_FRAGMENT_NODE,NOTATION_NODE,DOCUMENT_POSITION_DISCONNECTED,DOCUMENT_POSITION_PRECEDING,DOCUMENT_POSITION_FOLLOWING,DOCUMENT_POSITION_CONTAINS,DOCUMENT_POSITION_CONTAINED_BY,DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC,addEventListener,removeEventListener,dispatchEvent
    [object HTMLTitleElement]
    [object Text] wholeText,nextElementSibling,previousElementSibling,length,data,parentElement,textContent,baseURI,localName,namespaceURI,ownerDocument,nextSibling,previousSibling,lastChild,firstChild,childNodes,parentNode,nodeType,nodeValue,nodeName,splitText,replaceWholeText,getDestinationInsertionPoints,substringData,appendData,insertData,deleteData,replaceData,remove,insertBefore,replaceChild,removeChild,appendChild,hasChildNodes,cloneNode,normalize,isSameNode,isEqualNode,lookupPrefix,isDefaultNamespace,lookupNamespaceURI,compareDocumentPosition,contains,ELEMENT_NODE,ATTRIBUTE_NODE,TEXT_NODE,CDATA_SECTION_NODE,ENTITY_REFERENCE_NODE,ENTITY_NODE,PROCESSING_INSTRUCTION_NODE,COMMENT_NODE,DOCUMENT_NODE,DOCUMENT_TYPE_NODE,DOCUMENT_FRAGMENT_NODE,NOTATION_NODE,DOCUMENT_POSITION_DISCONNECTED,DOCUMENT_POSITION_PRECEDING,DOCUMENT_POSITION_FOLLOWING,DOCUMENT_POSITION_CONTAINS,DOCUMENT_POSITION_CONTAINED_BY,DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC,addEventListener,removeEventListener,dispatchEvent 
    
</comment>  
    </textarea><!-- element_f box --> 
    <textarea hidden id="platform_f" cols=140 rows=10>

    \ platform.f for jeforth.3htm, jeforth.3hta, and jeforth.3nw
    \ KeyCode test page http://www.asquare.net/javascript/tests/KeyCode.html

    s" platform.f"      source-code-header

    also forth definitions \ 本 word-list 太重要，必須放進 root vocabulary。

    \ 用 storage 取代 localStorage 以便在不 support localStorage 的 3HTA 中模擬之。
    \ 為了讓 localStorage 能放 object 看到 object 就翻成 JSON, 若非 object 則照放。
    \ 所以連功能也擴充了。
    
    \ window.storage application functions are in 3htm/f/platform.f 其中有 
    \ stoarge.set(), ~.get(), ~.del() 等是應用時 common 的。而 storage.all(), 
    \ .save(), .restore() 這三個 low level I/O 是 3nw,3hta 要在各自的 platform.f 中
    \ 提供的以便存取 localstorage.json 檔，其中 storage.all() 是最重要的，用來
    \ 虛擬化 HTML5 的 localStorage。 所以 3hta, 3nw 可以直接讓 localstorage.json 與它
    \ 隨時保持同步。不能 access local computer 檔案的 3htm, 3ce 則有 ls.f export-all, 
    \ import-all 這兩個命令來手動讀出與設定 localStorage。

    js> window.storage==undefined [if] 
        \ For 3htm, 3ce, 3ca 等本身就有 localStorage 的環境 define the pseudo interface
        js: window.storage={};
        js: window.storage.all=function(){return(localStorage)}
    [else]
        \ For 3hta and 3nw, restore localStorage from localstorage.json.
        \ Their platform.f provides storage.all(), .save() and .restore().
        js: storage.restore()
    [then]
        
    <js>
        // 
        window.storage.get = function(key,hash){
                // HTML5 localStorage only allow string, we support object too.
                var ss = typeof(hash)=="object" ? hash[key] : storage.all()[key];
                if(!ss) return (undefined); // the field is not existing
                try {
                    var data = JSON.parse(ss); // The field is an object
                } catch(err) {
                    data = ss; // Not an object
                }
                return(data); // can be anything includes object
            }
        window.storage.set = function(key,data){
                // set() 新 field 會自動產生, 不必先 new(), 故沒有 new()。
                if(typeof data == "object") {
                    storage.all()[key] = JSON.stringify(data);
                } else {
                    storage.all()[key] = data; // Assume it's a string
                }
                if(storage.save) storage.save();
            }
        window.storage.del = function(key){
            delete(storage.all()[key])
            if(storage.save) storage.save();
        }
        </js> 

    \ \ 使 common.css 生效。直接用 link tag 引進 common.css 無法修改, 必續這樣。
    \ \ style 經常有需要修改, 例如為了解決 flot.js 的問題: YNote: "Flot bug of graph disappear reproduced. How to fix it"
    
    s" <style id=commoncss> " 
    <text>
    /* common.css */
    .console3we div , .console3we textarea {
        color:black;
        font-family: courier new;
        /* font-size: 40px; */
        padding:20px; 
        word-wrap:break-word;
        border: 0px solid white;
        background:#F0F0F0;
    }
    
    .console3we textarea {
        width:99%; /* 這個會壓過 textarea 的 cols=n */
        padding:4px; 
        border: 0px solid;
        background:#BBBBBB;
    }
    </text> ( css ) 
    + ( styleTag+css )
    s" </style>" + ( styleTag+css+/styleTag ) </h> drop 

code run-inputbox ( -- ) \ <Enter> key's run time.
                var cmd = inputbox.value; // w/o the '\n' character ($10).
                inputbox.value = ""; // 少了這行，如果壓下 Enter 不放，就會變成重複執行。
                vm.cmdhistory.push(cmd);
                vm.forthConsoleHandler(cmd);
                end-code
                /// 抽出本命令有很多用途，首先是 support Ctrl-Enter 用來執行 inputbox, 這除了
                /// 原來 edit mode 時需要, 且可用於 focus 在別地方時下達執行命令, 因為 focus 本
                /// 身要指著某東西；這個 word 還可以改寫，在 3ce 中用來加強分辨看命令是誰下達的。

                ' {F5} [if] [else] 
                \ 3htm/f/platform.f 大家都共用，若已經定義過了避免重複。
: {F5}          ( -- boolean ) \ Hotkey handler, Confirm the window refresh
                <js> confirm("Really want to restart?") </jsV> 
                if js: window.location.reload(true) false
                else false then ;
                /// Defined in 3htm/f/platform.f
                /// Return a false to stop the hotkey event handler chain.
                /// Must intercept onkeydown event to avoid original function.
                [then]

: {F2}          ( -- false ) \ Hotkey handler, Toggle input box EditMode
                \ 以下都不能用 cr 改用 js: type('\n'); cr 中有 1 nap suspend, event handler 不能 suspend。
                js> event&&event.shiftKey if char {shift-f2} execute ( T/f ) exit then
                js> event&&event.ctrlKey if char {ctrl-f2} execute ( T/f ) exit then
                js> event&&event.altKey if char {alt-f2} execute ( T/f ) exit then
                char toggle-inputbox-edit-mode execute false \ F2 w/o shifted key
                ;
                /// return a 'false' to stop the hotkey event handler chain.
                
: inputbox-edit-mode-on ( -- ) 
                ['] {F2} :: EditMode=true
                <text> .console3we textarea:focus { 
                    border: 0px solid; background:#FFE0E0; /* pink indicating edit mode */
                }</text> js: styleTextareaFocus.innerHTML=pop() ; private

: inputbox-edit-mode-off ( -- ) 
                ['] {F2} :: EditMode=false
                <text> .console3we textarea:focus { 
                    border: 0px solid; background:##E0E0E0;
                }</text> js: styleTextareaFocus.innerHTML=pop() ; private
                last execute \ default mode

: toggle-inputbox-edit-mode ( -- ) \ One of the {F2} events
                ['] {F2} :> EditMode 
                if inputbox-edit-mode-off false
                else inputbox-edit-mode-on true then 
                ." Input box EditMode = " . js: type('\n') \ can't use cr in event handler
                ;

: outputbox-edit-mode-on ( -- ) \ One of the {F2} events
                js> outputbox :> style ( outputbox.style )
                <js> pop().border="thin solid red"</js>
                js: outputbox.contentEditable=true ; private
                
: outputbox-edit-mode-off ( -- ) \ One of the {F2} events
                js> outputbox :> style ( outputbox.style )
                <js> pop().border="thin solid white"</js>
                js: outputbox.contentEditable=false ; private
                
: toggle-outputbox-edit-mode ( -- ) \ Toggle outputbox edit mode.
                js> outputbox.contentEditable!="true" if 
                    outputbox-edit-mode-on
                else 
                    outputbox-edit-mode-off 
                then ; private

: {shift-f2}    ( -- ) \ One of the {F2} events, toggle-outputbox-edit-mode
                toggle-outputbox-edit-mode false ( false terminate bubbling ) ;
                
: {ctrl-f2}     ( -- false )
                <js> alert("You pressed Ctrl-F2 and I am doing nothing.") </js>
                true ( true by pass, false terminate ) ;

: {alt-f2}      ( -- false )
                <js> alert("You pressed alt-F2 and I am doing nothing.") </js>
                true ( true by pass, false terminate ) ;

\ -----------------
code active-textarea ( -- objElement ) \ Get the recent active textarea element or null
                var them = $("textarea"); // An array
                for ( var i=0; i<them.length; i++){
                    if ($(them[i]).is(":focus")){
                        push(them[i]);
                        return;
                    }
                }
                push(null);
                end-code
                /// For {F9}/{F10} to change the active textarea rows size.

code {F9}       ( -- false ) \ Hotkey handler, Smaller the active textarea or the inputbox.
                execute("active-textarea"); var ta = pop() || inputbox;
                var r = ta.rows;
                if(r<=4) r-=1; else if(r>8) r-=4; else r-=2;
                ta.rows = Math.max(r,1);
                if (ta==inputbox) {
                    if (!r) $(ta).hide();
                    vm.scroll2inputbox();inputbox.focus();
                }
                push(false); // Stop event bubbling
                end-code
                \ last alias {F6} // ( -- flase ) Hotkey handler, Smaller the input box
                \ /// Duplicated to recover PowerCam conflict.

code {F10}      ( -- false ) \ Hotkey handler, Bigger the input box
                execute("active-textarea"); var ta = pop() || inputbox;
                var r = 1 * ta.rows;
                if(r<4) r+=1; else if(r>8) r+=4; else r+=2;
                ta.rows = Math.max(r,1);
                if (ta==inputbox) {
                    $(ta).show() // 縮到最後是 $.hide() 起來的。
                    vm.scroll2inputbox();inputbox.focus();
                }
                push(false); // Stop event bubbling
                end-code
                /// Must intercept onkeydown event to avoid original function.
                \ last alias {F7} // ( -- flase ) Hotkey handler, Bigger the input box
                \ /// Duplicated to recover PowerCam conflict.

code {F4}       ( -- false ) \ Hotkey handler, copy marked string into inputbox
                var selection = getSelection();
                var start, end, ss;
                if (!selection.isCollapsed) {
                    if (selection.anchorNode==selection.focusNode) {
                        start = Math.min(selection.anchorOffset,selection.focusOffset);
                        end   = Math.max(selection.anchorOffset,selection.focusOffset);
                        ss = selection.anchorNode.data.slice(start,end);
                    } else {
                        if (selection.anchorNode.data){  // 我根據實例亂湊的，搞不懂對的用法。
                            start = selection.anchorOffset;
                            end   = selection.anchorNode.data.length;
                            ss = selection.anchorNode.data.slice(start,end);
                        } else {
                            // 啟動時 mark "VBScript V5.8 Build:16384" 其中那個 16384 就會出這種情形！
                            ss = selection.focusNode.data.slice(0,selection.anchorOffset);
                        }
                    }
                    document.getElementById("inputbox").value += " " + ss;
                }
                vm.scroll2inputbox();inputbox.focus();
                push(false);
                end-code
                /// return a false to stop the hotkey event handler chain.
                /// The selection must be made from start to end.

code {esc}      ( -- false ) \ Inputbox keydown handler, clean inputbox
                inputbox.value="";
                vm.scroll2inputbox();inputbox.focus();
                push(false); // Stop bubbling
                end-code

: history-selector ( -- ) \ Popup command history for selection
                <o> <br><select style="width:90%;padding-left:2px;font-size:16px;"></select></o> ( select )
                <js> 
                    for (var i=0; i<vm.cmdhistory.array.length; i++){
                        if(vm.cmdhistory.array[i].split('\n').length>1) continue;
                        var option = document.createElement("option");
                        option.text = vm.cmdhistory.array[i];
                        js: tos().add(option);
                    }
                    tos().size = Math.min(16,tos().length);
                    tos().selectedIndex=tos().length-1;
                    vm.scroll2inputbox();tos().focus();
                    var select = tos().onclick = function(){
                        inputbox.value = tos().value;
                        execute("removeElement");
                        inputbox.focus();
                        return (false);
                    }
                    tos().onkeydown = function(e){
                        e = (e) ? e : event; var keycode = (e.keyCode) ? e.keyCode : (e.which) ? e.which : false;
                        switch(keycode) {
                            case 27: /* Esc  */ execute("removeElement"); inputbox.focus(); break;
                            case 38: /* Up   */ tos().selectedIndex = Math.max(0,tos().selectedIndex-1); break;
                            case 40: /* Down */ tos().selectedIndex = Math.min(tos().length-1,tos().selectedIndex+1); break;
                            case 13: /* Enter*/ setTimeout(select,1); break;
                        }
                        return (false);
                    }
                </js> ; private
                
true value up/down-recall-needs-alt-key? private
                // ( -- boolean ) An optional setting. Up/Down key to recall command history needs the Alt-key?

: {up}          ( -- boolean ) \ Inputbox keydown handler, get previous command history.
                js> event.altKey if 
                    history-selector false \ eat the key
                else
                    js> event.ctrlKey if
                        js: inputbox.value=vm.cmdhistory.up() false \ eat the key
                    else 
                        js> inputbox.value==""||inputbox.value=="\n" 
                        up/down-recall-needs-alt-key? not and
                        if
                            history-selector false \ eat the key
                        else
                            true \ don't eat the key, let it pass down
                        then
                    then 
                then ;
                /// Alt-Up pops up history-selector menu.
                /// Ctrl-Up/Ctrl-Down recall command line history.
                /// Use Ctrl-M instead of 'Enter' when you want a 'Carriage Return' in none EditMode.

: {down}        ( -- boolean ) \ Inputbox keydown handler, get next command history.
                js> event.altKey if 
                    history-selector false \ eat the key
                else
                    js> event.ctrlKey if
                        js: inputbox.value=vm.cmdhistory.down() false \ eat the key
                    else 
                        js> inputbox.value==""||inputbox.value=="\n" 
                        up/down-recall-needs-alt-key? not and
                        if
                            history-selector false \ eat the key
                        else
                            true \ don't eat the key, let it pass down
                        then
                    then 
                then ;
                /// Alt-Up pops up history-selector menu.
                /// Ctrl-Up/Ctrl-Down recall command line history.
                /// Use Ctrl-M instead of 'Enter' when you want a 'Carriage Return' in none EditMode.

: {backSpace}   ( -- boolean ) \ Inputbox keydown handler, erase output box when input box is empty
                js> inputbox.value!=""&&inputbox.value!="\n" if 
                    true \ inputbox is not empty, do the norm.
                else \ inputbox is empty, clear outputbox bottom up
                    js> event==null||!event.altKey \ So as to allow calling {backSpace} programmatically    
                    if \ erase bottom up 
                        js> outputbox.lastChild ?dup if
                            js> tos().nodeName char BR = if removeElement else drop then
                        then                
                        js> event==null||!event.shiftKey \ So as to allow calling {backSpace} programmatically
                        if 1 else 30 then for
                            js> event&&event.ctrlKey if
                                js> outputbox.lastChild ?dup if removeElement then
                            else
                                js> outputbox.lastChild ?dup if
                                    js> tos().nodeName  char BR    =
                                    js> tos(1).nodeName char #text =
                                    or if removeElement else drop then
                                then
                            then
                        next
                    else \ erase top down
                        js> event==null||!event.shiftKey \ So as to allow calling {backSpace} programmatically
                        if 1 else 30 then for
                            js> event&&event.ctrlKey if
                                js> outputbox.firstChild ?dup if removeElement then
                            else
                                js> outputbox.firstChild ?dup if
                                    js> tos().nodeName  char BR    =
                                    js> tos(1).nodeName char #text =
                                    or if removeElement else drop then
                                then
                            then
                        next
                    then    
                    false
                then ;
                /// {backSpace} erase only the last <BR> and text node. To erase other node
                /// types, use Ctrl-{backSpace}. To erase faster, use Shift-{backSpace} or
                /// Shift-Ctrl-{backSpace}. To erase top down, use Alt key.

code {Tab}      ( -- ) \ Inputbox auto-complete
                with(this){
                    if(index == 0){ // index 初值來自 document.onkeydown event, 這是剛按下 Tab 的線索。
                        var a=('h '+inputbox.value+' t').split(/\s+/);
                        a.pop(); a.shift();
                        this.hint = a.pop()||""; // the partial word to be autocompleted
                        this.cmdLine = inputbox.value.slice(0,inputbox.value.lastIndexOf(hint))||"";
                        this.candidate = []; 
                        if(hint){
                            for(var key in wordhash) {
                                if(key.toLowerCase().indexOf(hint.toLowerCase())!=-1) candidate.push(key); 
                            }
                            candidate.push(hint);
                        }
                    }
                    if(hint){
                        if(index >= candidate.length) index = 0;
                        inputbox.value = cmdLine + candidate[index++];
                        push(false); // 吃掉這個 Tab key。
                    } else {
                        push(true); // 不吃掉這個 Tab key，給別人處理。
                    }
                }
                end-code
                last :: index=0

: {ctrl-break}  ( -- boolean ) \ Inputbox keydown handler, stop outer loop
                ."  {ctrl-break} " stop false ;

: help(word)    ( word -- ) \ Show help messages of a word in a HTML table
                js> typeof(help_words)=='object' if else
                        <o> <style id=help_words>
                            .help_words table, .help_words td , .help_words th, .help_words caption {
                                padding:8px;
                                border-collapse: collapse;
                                border: 2px solid #F0F0F0;
                            }
                            .help_words tr {background: #E8E8FF}
                            .help_words tr:nth-child(1) {background: #D0D0FF}
                        </style></o> drop
                then
                <text>
                    <table class=help_words style="width:90%">
                    <tr>
                      <td style="width:200px"><b>_name_</b></td><td colspan=4><b>_help_</b>
                      [_type_][_vid_][_immediate_][_compile_][_private_]</td>
                    </tr>
                    _comment_
                    </table>
                </text> ( word html )
                js> pop().replace(/_name_/,vm.plain(tos().name))
                js> pop().replace(/_help_/,vm.plain(tos().help))
                js> pop().replace(/_type_/,vm.plain(tos().type))
                js> pop().replace(/_vid_/,vm.plain(tos().vid))
                ( word html ) <js> 
                    if (tos(1).comment) {
                        push(pop().replace(
                            /_comment_/,
                            "<tr><td colspan=5>"+vm.plain(tos().comment)+"</td></tr>"
                        ))
                    } else push(pop().replace(/_comment_/,""))
                    if (tos(1).immediate)  
                         push(pop().replace(/_immediate_/,"IMMEDIATE")); 
                    else push(pop().replace(/_immediate_/,""));
                    if (tos(1).compileonly) 
                         push(pop().replace(/_compile_/,"COMPILE-ONLY")); 
                    else push(pop().replace(/_compile_/,""));
                    if (tos(1).private) 
                         push(pop().replace(/_private_/,"PRIVATE")); 
                    else push(pop().replace(/_private_/,""));
                </js> 
                </o> 2drop ;

code (help)     ( "['pattern' [-t|-T|-n|-f]]" -- )  \ Print help message of screened words
                var spec = pop().replace(/\s+/g," ").split(" "); // [pattern,option,rests]
                for (var j=0; j<order.length; j++) { // 越後面的 priority 越新
                    push(order[j]); // vocabulary
                    push(spec[0]||""); // pattern
                    push(spec[1]||""); // option
                    execute("word_select"); // [words...]
                    var word_list = pop();
                    var voc = "\n--------- " + order[j] +" ("+ word_list.length + " words) ---------\n";
                    // 印出
                    if (word_list.length) type(voc);
                    for (var i=0; i<word_list.length; i++) {
                        push(word_list[i]); execute('help(word)')
                    }
                } 
                end-code
                /// Modified by platform.f for HTML table.
                /// By default, pattern matches exact name, case sensitive.
                /// Pattern can be qualified by an option of:
                ///   -n matches only name, case insensitive.
                ///   -f matches name, help and comment, case insensitive.
                ///   -t matches type, case insensitive.
                ///   -T matches exact type, case sensitive.
                /// Example: 
                ///   help ! -n  shows words with '!' in their name

: help          ( <["pattern" [-t|-T|-n|-f]]> -- )  \ Print help message of screened words
                CR word js> tos().length if 
                    js> tos()=='*' if drop "" then
                    (help) 
                else
                    drop js> typeof(help3we)=='object' if else
                        <o> <style id=help3we>
                            .help3we table, .help3we td , .help3we th, .help3we caption {
                                padding:8px;
                                font-size:18px;
                                font-family: cursive;
                                border-collapse: collapse;
                                border: 2px solid #F0F0F0;
                            }
                            .help3we tr:nth-child(odd)  {background: #D0D0FF}
                            .help3we tr:nth-child(even) {background: #E0E0FF}
                            .help3we td {min-width: 200px}
                        </style></o> drop
                    then
                    <o>
                        <table class=help3we style="width:80%;">
                        <caption><h3>jeforth.3we for HTM, HTA, and Node-webkit basic usages</h3></caption>
                        <tr>
                          <td><b>Topic</b></td>
                          <td><b>Descriptions</b> (watch video)</td>
                        </tr>
                        <tr>
                          <td>Hotkey F2</td>
                          <td><a href="http://www.camdemy.com/media/19258">Toggle input box EditMode</a></td>
                        </tr>
                        <tr>
                          <td>Hotkey Shift-F2</td>
                          <td>Toggle output box EditMode</td>
                        </tr>
                        <tr>
                          <td>Hotkey Ctrl-F2</td>
                          <td>Click anywhere and press Ctrl-F2 to get the clicked HTML node to 
                          the "current element", so we can manipulate it. Refer to "ce" command.</td>
                        </tr>
                        <tr>
                          <td>Hotkey Alt-F2</td>
                          <td>Click anywhere and press Alt-F2 to edit the clicked HTML node.</td>
                        </tr>
                        <tr>
                          <td>Hotkey F4</td>
                          <td><a href="http://www.camdemy.com/media/19259">Copy marked string to inputbox</a></td>
                        </tr>
                        <tr>
                          <td>Hotkey F5</td>
                          <td><a href="http://www.camdemy.com/media/19260">Restart the jeforth system</a></td>
                        </tr>
                        <tr>
                          <td>Hotkey F9/F10</td>
                          <td><a href="http://www.camdemy.com/media/19261">Bigger/Smaller input box</a></td>
                        </tr>
                        <tr>
                          <td>Hotkey Esc</td>
                          <td><a href="http://www.camdemy.com/media/19262">Clear input box</a></td>
                        </tr>
                        <tr>
                          <td>Hotkey Tab</td>
                          <td><a href="http://www.camdemy.com/media/19263">Forth word auto-complete</a></td>
                        </tr>
                        <tr>
                          <td>Hotkey Ctrl-Enter</td>
                          <td>Execute the command line in the input box even when the input box is not focused.
                          So we can click on a HTML node or element, then press ctrl-enter to execute the command 
                          line that manipulates the HTML object.
                          </td>
                        </tr>
                        <tr>
                          <td>Hotkey Ctrl-Up/Ctrl-Down</td>
                          <td>Recall used command lines</td>
                        </tr>
                        <tr>
                          <td>Hotkey Alt-Up/Alt-Down</td>
                          <td><a href="http://www.camdemy.com/media/19266">List command history</a></td>
                        </tr>
                        <tr>
                          <td>Hotkey Crtl+/Ctrl-</td>
                          <td><a href="http://www.camdemy.com/media/19267">Zoom in/ Zoom out</a></td>
                        </tr>
                        <tr>
                          <td>Hotkey Ctrl-Break</td>
                          <td><a href="http://www.camdemy.com/media/19268">Break the Forth interpreter</a></td>
                        </tr>
                        <tr>
                          <td>Hotkey BackSpace</td>
                          <td><a href="http://www.camdemy.com/media/19269">Erase outputbox text when inputbox is empty</a></td>
                        </tr>
                        <tr>
                          <td>help [*|pattern [-t|-T|-n|-N]]</td>
                          <td>You are reading me. 'help' is also an useful command, 
                          "help *" lists all words' help. "help help" to see options.
                          <a href="http://www.camdemy.com/media/19270">Video: Help is helpful</a>.
                          </td>
                        </tr>
                        <tr>
                          <td>jsc</td>
                          <td><a href="http://www.camdemy.com/media/19271">JavaScript Console</a></td>
                        </tr>
                        <tr>
                          <td>More information</td>
                          <td>
                          1. <a href="http://www.camdemy.com/folder/8691">Video presentation web site</a><br> 
                          
                          2. <a href="https://github.com/hcchengithub/jeforth.3we/wiki">jeforth.3we GitHub Wiki</a><br>
                          3. <a href="https://guides.github.com/activities/hello-world/">GitHub version control and collaboration</a>
                          
                          </td>
                        </tr>
                        </table>
                        
                    </o> drop
                then ;
                last :: comment=tick('(help)').comment
                /// A pattern of '*' means all words.
                /// Example: 
                ///   help *     shows all words

<js>
    vm.cmdhistory = {
        max:   100, // maximum length of the command history
        index: -1,
        array: [],
        push:
            function (cmd){
                cmd = cmd.replace(/(^( |\t)*)|(( |\t)*$)/mg,''); // remove 頭尾 whitespaces. .trim() 舊 JScript v5.6 未 support
                if(cmd.search(/\S/)==-1) return; // skip blank lines
                this.array.push(cmd);
                for(var i=this.array.length-2; i>=0; i--)
                    if(cmd==this.array[i]) this.array.splice(i,1); // remove duplicated
                if (this.array.length > this.max ) this.array.shift(); // overflow
                this.index = this.array.length; // point to last one, new one.
            },
        up:
            function(){
                var cmd="", indexwas = this.index;
                this.index = Math.max(0, this.index-1);
                if (this.array.length > 0 && this.index >= 0 && this.index < this.array.length){
                    cmd = this.array[this.index];
                }
                if (indexwas == this.index) {
                    if (tick('beep')) execute('beep');
                    cmd += "  \\ the end";
                }
                return(cmd);
            },
        down:
            function(){
                var cmd="", indexwas = this.index;
                this.index = Math.min(this.array.length-1, this.index+1);
                if(this.array.length > 0 && this.index >= 0 && this.index < this.array.length){
                    cmd = this.array[this.index];
                }
                if (indexwas == this.index) {
                    if (tick('beep')) execute('beep');
                    cmd += "  \\ the end";
                }
                return(cmd);
            },
    };
    $("#inputbox")[0].onkeydown = function(e){
        e = (e) ? e : event; var keycode = (e.keyCode) ? e.keyCode : (e.which) ? e.which : false;
        if(tick('{Tab}')){if(keycode!=9)tick('{Tab}').index=0} // 按過別的 key 就重來
        switch(keycode) {
            case   8: /* Back space */ if(tick('{backSpace}' )){execute('{backSpace}' );return(pop());} break; // disable the [switch previous page] function
            case   9: /* Tab  */ if(tick('{Tab}' )){execute('{Tab}' );return(pop());} break;
            case  38: /* Up   */ if(tick('{up}'  )){execute('{up}'  );return(pop());} break;
            case  40: /* Down */ if(tick('{down}')){execute('{down}');return(pop());} break;
            case  13:
                if (!event.shiftKey && !tick("{F2}").EditMode) {
                    execute("run-inputbox");
                    return(false); // stop bubbling
                }
                return(true); // could be Ctrl-Enter, let document check
        }
        return (true); // pass down to following handlers
    }
    
    // {s} was named {ios} where 's' pressed when in inputbox or outputbox. Ctrl-s 要 save 存檔。
    // [x] 有了 console3we 之後, 可以把它簡化，不用兩處都各寫一套 handler。
    // [ ] 這樣一來，console3we 還可以有更多 hotkey !!
    $(".console3we")[0].onkeydown = function(e){
        e = (e) ? e : event; 
        var keycode = (e.keyCode) ? e.keyCode : (e.which) ? e.which : false;
        switch(keycode) {
            case  83: /* s */if(tick('{s}')){execute('{s}');return(pop());}break;  // 's' in inputbox or outputbox
        }
        return (true); // pass down to following handlers
    }

    document.onkeydown = function (e) {
        // document.onkeydown() reDef in 3htm/f/platform.f 
        e = (e) ? e : event; var keycode = (e.keyCode) ? e.keyCode : (e.which) ? e.which : false;
        switch(keycode) {
            case  13: /* CR    */ if(event.ctrlKey){execute("run-inputbox");return(false)}return(true);
            case  27: /* Esc   */ if(tick('{esc}')){execute('{esc}');return(pop());} break;
            case 107: /* pad + */ if(tick('{+}'  )){execute('{+}'  );return(pop());} break;
            case 109: /* pad - */ if(tick('{-}'  )){execute('{-}'  );return(pop());} break;
            case 187: /* =     */ if(tick('{+}'  )){execute('{+}'  );return(pop());} break;
            case 189: /* -     */ if(tick('{-}'  )){execute('{-}'  );return(pop());} break;
            case 112: /* F1    */ if(tick('{F1}' )){execute('{F1}' );return(pop());} break;
            case 113: /* F2    */ if(tick('{F2}' )){execute('{F2}' );return(pop());} break;
            case 114: /* F3    */ if(tick('{F3}' )){execute('{F3}' );return(pop());} break;
            case 115: /* F4    */ if(tick('{F4}' )){execute('{F4}' );return(pop());} break;
            case 116: /* F5    */ if(tick('{F5}' )){execute('{F5}' );return(pop());} break;
            case 117: /* F6    */ if(tick('{F6}' )){execute('{F6}' );return(pop());} break;
            case 118: /* F7    */ if(tick('{F7}' )){execute('{F7}' );return(pop());} break;
            case 119: /* F8    */ if(tick('{F8}' )){execute('{F8}' );return(pop());} break;
            case 120: /* F9    */ if(tick('{F9}' )){execute('{F9}' );return(pop());} break;
            case 121: /* F10   */ if(tick('{F10}')){execute('{F10}');return(pop());} break;
            case 122: /* F11   */ if(tick('{F11}')){execute('{F11}');return(pop());} break;
            case 123: /* F12   */ if(tick('{F12}')){execute('{F12}');return(pop());} break;
            case   3: /* ctrl-break */ if(tick('{ctrl-break}')){execute('{ctrl-break}');return(pop());} break;
        }
        return (true); // pass down to following handlers
    }
</js>

previous definitions


<comment>

    \ 既然這種東西都是應用相關的，platform.f 裡面就不再預先設定了，但保留以下範例。
        <js>
        // 設定讓 整個 <body> 的 double-click 都發動 double-click 來處理。
        document.body.ondblclick = function(){
            push(true); // true let the river run, false stop bubbling
            execute("double-click"); // execute() does nothing if undefined yet
            return(pop()); // double-click ( flag -- ... flag' )
        }
        // 設定讓 整個 <body> 的 click 都發動 single-click 來處理。
        document.body.onclick = function(){
            push(true);  // true let the river run, false stop bubbling
            execute("single-click"); // execute() does nothing if undefined yet
            return(pop()); // single-click ( flag -- ... flag' )
        }
        // 設定讓 整個 <body> 的 right click 都發動 right-click 來處理。
        document.body.oncontextmenu = function(){
            push(true); // true let the river run, false stop bubbling
            execute("right-click"); // execute() does nothing if undefined yet
            return(pop()); // right-click ( flag -- ... flag' )
        }
        </js>

    s" thin solid black" value outputbox-high-light-style // ( -- "style" ) CSS style

    : outputbox-high-light-on ( -- ) \ Mark outputbox's children with border
                    js> outputbox :> childNodes.length for
                        r@ 1- js> outputbox :> childNodes[pop()].style if \ no style, #text I guess, do nothing.
                            r@ 1- js> outputbox :> childNodes[pop()].style.border \ get original border
                            r@ 1- js> outputbox :: childNodes[pop()].orig_border=pop() \ save to orig_border
                            outputbox-high-light-style
                            r@ 1- js> outputbox <js> pop().childNodes[pop()].style.border=pop()</js> \ set high lighting border
                        then
                    next ; compile-only 
                    /// Don't use this command directly, avoid disterbing save-restore orig_border.
                    /// So I make it a compile-only. Use ~-toggle instead.

    : outputbox-high-light-off ( -- ) \ Unmark outputbox's children
                    js> outputbox :> childNodes.length for
                        r@ 1- js> outputbox :> childNodes[pop()].orig_border ?dup 
                        if \ restore
                            r@ 1- js> outputbox :: childNodes[pop()].style.border=pop() \ restore orig_border
                            r@ 1- js> outputbox :: childNodes[pop()].orig_border="" \ clear orig_border
                        else \ no restore just clean
                            r@ 1- js> outputbox :> childNodes[pop()].style if
                            r@ 1- js> outputbox :: childNodes[pop()].style.border=""
                            then
                        then
                    next ; 

    : outputbox-high-light-toggle ( -- ) \ Help {backSpace} not to delete useful data.
                    js> outputbox :> highLight if \ check recent state
                        outputbox-high-light-off
                        js> outputbox :: highLight=false \ Yes, we can add properties to an element
                    else
                        outputbox-high-light-on
                        js> outputbox :: highLight=true
                    then ;
</comment>              
    
    </textarea><!-- platform_f box --> 
    <textarea hidden id="misc_f" cols=140 rows=10>

s" misc.f"  source-code-header
        
code tib.       ( result -- ) \ Print the command line and the TOS.
                var lastCRindex = tib.slice(0, ntib).lastIndexOf('\n')+1;
                var cmd = tib.slice(lastCRindex).match(/\s*(.*) tib\.\s*/)[1]; 
                var L1 = cmd.length;
                cmd = cmd.replace(/\s*""\s*$/,""); // remove the ending ""
                var L2 = cmd.length;
                type(cmd+" \\ ==> ");
                if (L1==L2) type(tos() + " (" + mytypeof(pop()) + ")");
                else pop();
                type('\n');
                end-code 
                /// Good for experiments that need to show command line and the result.
                /// "" tib. prints the command line only, w/o the TOS.

code now        ( -- Time ) \ Get the Time object of now.
                push(new Date());
                end-code 

code t.year     ( Time -- year ) \ Get year number
                push(pop().getFullYear());
                end-code
   
: t.month       ( Time -- month ) \ Get month number 
                js> pop().getMonth() 1+ ;

: t.date        ( Time -- date ) \ Get date number 
                js> pop().getDate() ;

: t.day         ( Time -- day ) \ Get day number 
                js> pop().getDay() ;

: t.hour        ( Time -- hour ) \ Get hour number 
                js> pop().getHours() ;

: t.minute      ( Time -- minute ) \ Get minute number 
                js> pop().getMinutes() ;

: t.second      ( Time -- second ) \ Get second number 
                js> pop().getSeconds() ;

: t.mS          ( Time -- mS ) \ Get mS number 
                js> pop().getMilliseconds() ;

: t.dateTime    ( Time -- "yyyy-mm-dd HH:mm:ss" ) \ Get "yyyy-mm-dd HH:mm:ss" string
                >r
                r@ t.year char - +
                r@ t.month  2 (.0r) char - + +
                r@ t.date   2 (.0r) (space) + +
                r@ t.hour   2 (.0r) char : + +
                r@ t.minute 2 (.0r) char : + +
                r> t.second 2 (.0r) + ;

code precise-time(mS)   ( -- mS ) \ JavaScript's precise recent time in mini seconds
                        push((new Date()).getTime()) end-code

code jquery.version ( -- string ) \ Check jQuery version
                push($.fn.jquery) end-code
                /// or push($().jquery) too
                /// http://www.moreonfew.com/how-to-check-jquery-version

                <comment>
                \ This was for test
                code freeze     ( mS -- ) \ Freeze the entire system for mS time. Nobody can do anything.
                                var ms=pop();
                                var startTime = new Date().getTime();
                                while(new Date().getTime() < (startTime + ms));
                                end-code
                                /// 'freeze' is not a good word, it totally blocks the entire system, useless maybe.
                                /// Try 'sleep' instead.
                                
                \ This was for fun
                code .longwords ( length -- ) \ type long words. I designed this word for fun to see what are they.
                                var limit = pop();
                                for (var j=0; j<order.length; j++) { // 越後面的 priority 越新
                                    type("\n-------- " + order[j] +" "+ (words[order[j]].length-1) + " words --------\n" );
                                    for (var i=1; i<words[order[j]].length; i++){  // 從舊到新
                                        if(words[order[j]][i].name.length > limit) type(words[order[j]][i].name+" ");
                                    }
                                }
                                end-code

                \ 已經有更好的方法： mySetTimeout() mySetInterval()
                \ setTimout timers & setInterval timers. Idea was from Sam Suan Chen's jeforth HTML5 clock demo.
                \ [] constant timouts       // ( -- array[] ) setTimeout IDs' storage
                \                       /// Refer to : timeouts.push and timeouts.clear
                \ code timeouts.push        ( id -- ) \ Save the setTimeout ID into timeouts[].
                \                       execute('timeouts'); pop().push(pop()) end-code
                \ code timeouts.clear       ( n -- ) \ Clear older setTimeout IDs leaving the last n ones.
                \                       var n=pop(); execute('timeouts'); var a=pop();
                \                       while(a.length>n) clearTimeout(a.shift());
                \                       end-code
                \ [] constant intervals     // ( -- array[] ) setInterval IDs' storage
                \                       /// Refer to : intervals.push and intervals.clear
                \ code intervals.push       ( id -- ) \ Save the setInterval ID into intervals[].
                \                       execute('intervals'); pop().push(pop()) end-code
                \ code intervals.clear  ( n -- ) \ Clear older setInterval IDs leaving the last n ones.
                \                       var n=pop(); execute('intervals'); var a=pop();
                \                       while(a.length>n) clearInterval(a.shift());
                \                       end-code

                \ 不如放進 calc.f 裡去
                \ : dollar>ntd          ( USD -- NTD ) \ 美金（美元）換算成台幣（元），將來看能不能自動從網路上取得匯率。
                \                       32 * ; 
                \                       /// 1 dollar = 100 cent, 1 quarter = 25 cent
                \                       /// 1 dime = 10 cent, 1 nickel = 5 cent
                \ : cent>ntd                ( cent -- NTD ) \ 美金（美分）換算成台幣（元）
                \                       100 / dollar>ntd ; 
                \ 
                \ : euro>ntd                ( EUR -- NTD ) \ 歐元（元）換算成台幣（元），將來看能不能自動從網路上取得匯率。
                \                       35.402 * ; 
                \                       /// 1 euro = 100 cent, 1 quarter = 25 cent
                \                       /// 1 dime = 10 cent, 1 nickel = 5 cent
                \ : euro.cent>ntd           ( cent -- NTD ) \ 歐元（分）換算成台幣（元）
                \                       100 / euro>ntd ; 
                    https://tw.knowledge.yahoo.com/question/question;_ylt=A3eg.oaZmchUwG0AsfHXrYlQ?qid=1513122703211
                    美金有；1分，5分，1角，2角5分，5角，1元。
                    英鎊有；1便士，2便士，10便士，20便士，50便士，1鎊，2鎊，5鎊，10鎊，20鎊。
                    歐元有；1分，2分，5分，10分，20分，50分，1元，2元。
                    日幣有；1元，5元，10元，50元，100元，500元。
                    港幣有；10分，20分，50分，1元，2元，5元，10元。
                </comment>

: sign      ( n -- sign ) \ sign of n, result is 1 or -1 
            ?dup if dup abs ( n abs(n) ) / int else 1 then ;

: round-off ( float 100(desimal) -- f' ) \ Round at 0.00 in this example, 0.005 --> 0.01, 0.00499 --> 0.0
            over sign ( f 100 sign ) swap ( f sign 100 ) 
            rot ( sign 100 f ) abs ( sign 100 |f| ) over * ( sign 100 |f|*100 ) 
            0.500000000001 +  ( sign 100 |f|*100+0.5 )
            int swap / * ; 
            /// where decimal=0 means integer

: -->   ( result -- ) \ Print the result with the command line.
        js> tib :> substring(0,ntib) ( result tib' )
        dup :> lastIndexOf("\n") ( result tib' idxLastCR )
        swap :> substring(Math.max(0,pop()),ntib) ( result tib" )
        trim . space char \ . space . cr ;
    
    </textarea><!-- misc_f box --> 
    <textarea hidden id="weblink_f" cols=140 rows=10>

s" weblink.f"  source-code-header
    
\ ----------------- Web.link -------------------------------------
\ Textarea ID: weblink_f

\ Utilities

    : manuals ( -- ) \ Show hyperlinks to Web.Link documents 
        <text>
        <h3>Start the local web-server for reading documents with Diigo</h3><t</text> <text> extarea rows=6>
        @rem open an Anaconda prompt (a DOSBox) 
        d:
        cd \ptc
        python -m http.server 8800
        @rem shrink the DOSBox to a smaller outlook for an easily distinguish
        </t</text> <text> extarea>
        <p><a href="http://localhost:8800/Creo%202.0/Common%20Files/M230/weblink/weblinkdoc/manual0/loadToolkitDoc.html"> Creo Parametric Web.Link Document </a></p>
        <p><a href="http://localhost:8800/Creo%202.0/Common%20Files/M230/weblink/weblinkdoc/manual0/pfcwebli.htm"> Creo Parametric Web.Link : User's Guide </a></p>
        <p><a href="http://localhost:8800/Creo%202.0/Common%20Files/M230/weblink/weblinkdoc/manual0/loadApiWizard.html"> Creo Parametric Web.Link - HTML based API Wizard </a></p>
        </text> + + compile </o> ;

    : pfcCreate ( "Mpfc<Modules>" -- obj ) \ Instantiate a PFC root module 
        s" pfc.--moduleName--" :> replace(/--moduleName--/,pop()) ( Module name )
        <js> (new ActiveXObject(pop()))</jsV> ; 

  \ js> weblink_f.value constant wlfs // ( -- txt ) weblink.f source code from the textarea
  \ : open-weblink.f-textarea ( -- ) \ open a textarea of weblink.f source code
  \     s" wlfs <o> <tex" s" tarea cols=140 rows=24></tex" + s" tarea></o> :: value=pop()" +
  \     js: vm.dictate(pop()) ;

    : seq ( seq -- js ) \ Convert a sequence (stringseq, intseq or realseq) into a js array.
        >r [] <js> for (var i=0; i<rtos().count; i++) tos().push(rtos().item(i))</js> r> drop ;

    : .stringseq ( seq -- ) \ 請改用 seq --> 適用於 stringseq, intseq, realseq . . . etc
        [ last literal ] :> help . cr ;
        last alias .intseq
        last alias .realseq
    
    code pfcMatrix3D>js ( pfcMatrix3D -- matrix ) \ Conver pfcMatrix3D to a 4X4 matrix. 
        var matrix = []; 
        for (i=0; i<4; i++) matrix[i] = new Array(4); // Create a 4X4 empty matrix      
        for (i=0; i<4; i++) for (j=0; j<4; j++) matrix[i][j] = tos().item(i,j);
        pop(); push(matrix);
    end-code
    
    : obj-merge ( obj1 obj2 -- obj2 ) \ Merge obj1 into obj2
        >r >r ( R: obj2 obj1 ) <js>
        for (i in rtos()) rtos(1)[i] = rtos()[i];
        </js> r> drop r> ;
        /// > dropall js> ({a:1}) js> ({b:2}) obj-merge (see)
        /// {
        ///   "b": 2,
        ///   "a": 1
        /// } 

    \ Collecting Web.Link objects' keys 
    <text>
        UDFInstanceName PWL_PARAMVALUE_STRING SetCurrentWS CreateReorderBeforeOp Invalidate IsAssociative DefaultButton WorkspaceName References Flags PWL_FEAT_EXTRACT DoubleValue Eval3DData CopyTemplateContents UIDisplayLocalizedMessage PWL_FEAT_SLOT GetBrowserSize GetYAxis PWL_NOT_IMPLEMENTED CreateReorderAfterOp GravityCenter SelPath Number GetConfigOption ComputeNearestCriticalDistance Volume PaperSizeX LayerNames ConstraintType PWL_FEAT_SMT_CONVERSION TangentStyle TextRefNote Derivative2 Mdl Horizontal Unregister PWL_FEAT_ASMCUT_COPY AddSimplifiedRep SectionRef FeatureStatus RemoveQuiltHiddenLines ResetTextAttributes DimensionValue Reset PWL_PATREL_SECOND_DIR DimensionToleranceObject TerminateExternalData CreateFromFileName RetrieveGeometryPartRep Save ListWindows PWL_E_FOUND RemoveObjects PrintCommand FileVersion PWL_CRE_VIEW_BAD_EXPLODE GetUVExtents GetPrintPCFOptions PlaceLabel DrawPolyline UVExtents ConvertToLinear PWL_FEAT_MFG_USEVOL PWL_FEAT_DATUM_QUILT Reference Parameter RetrieveGeomSimpRep GetSimpRep PWL_FEAT_MFG_REFINE MaxDir PWL_FEAT_SMT_SHEAR Show TableName ItemIds GetSkeleton DepModel CopyAndRetrieve OutputFile UIShowMessageDialog PrinterType FlushCurrentWindow PWL_FEAT_AUXILIARY IsSubstitute RollMedia CurrentSelectionBuffer PWL_FEAT_UNBEND KeepCheckedout TextThickness PWL_NOTE FileNames PWL_BAD_CONTEXT EntityId PWL_APP_NEW_VERSION SelectButtonLabel PWL_LAYER_TYPE_NONE VKnots CreateSimpRep UDegree Hardness GetOrientation IsPackaged PWL_MFG Edge2 Revision ShortcutName AddItem ListMaterials PWL_FEAT_RIBBON_CABLE MinorLength SurfaceCount SelectionString AdditionalComponents PWL_INVALID_DIR PWL_FEAT_SPOOL PWL_FEAT_SPLIT ListItems PWL_FEAT_EXTEND PWL_NOT_EXIST ParamStringVal LayerName Buttons GetTopGenericInfo FindContainingContour UndoCheckout PWL_FEAT_USER_FEAT Flip GetActiveExplodedState Selections PWL_FAM_USER_PARAM AllowChildGroupMembers PWL_DRAFT_ENTITY TrimmedSurfaceCount Set Parent IsSkeleton VariableName SelParts PWL_USER_PARAM NumFeatures PWL_FEAT_RIBBON_EXTEND GetSheetInfo Rename GetLocalizedMessageContents MoveThroughUI IsRefDimension PWL_EDGE_END PWL_FEAT_BLD_OPERATION Erase HasRetrievalErrors RetrieveSymbolicPartRep IsExternal ParentGroup Derivative2A CreateInstance U0Profile CreateTolPlusColumn Host DialogLabel ForeignID TransformVector PWL_FEAT_DRL_GRP RowNumber PWL_FEAT_CUT_MOTION TextLines DrawText2D PWL_PRM_MODEL ReorderSheet Refresh ColumnData Extension PanX PWL_FEAT_CABLE_SEGM ScreenTransform NumItems Append ThermExpRefTemp DrawPolygon2D Offset Description GetUnitType IsConstruction PWL_FEAT_ANALYSIS RetrieveSymbolicSimpRep GetCrossSection Profile1 Alias PWL_FEAT_FLAT_PAT LabelHeight MdlNameExt EvalPrincipalCurv PWL_FEAT_CABLE_COSM ListFeatMembers Download ItemObject PWL_FEAT_BEND IsPlaced PanY UIReadStringMessage GetViewDisplaying IsConfigurationSupported PWL_FEAT_WIRE_EDM PWL_FEAT_CSYS IsCurrent PWL_FEAT_FIXSETUP GetAliasedUrl AddSheet PlaceConstraints LayerOnly PWL_GRP_PATTERN_MEMBER CheckoutToWS Minimum CreateAssembly Vertices ItemOwners PWL_FEAT_WELD_SPOT StressLimCompress GetCell TransformPoint ListUnitSystems PromptForReference PermittedFatigueMaterialTypes PWL_PICK_ABOVE CreateDeleteOp SetNewName ListChildren ListSameSurfaces CreateTolPlusMinusColumn StructuralMaterialType Quality SlantAngle Green Option IncludeBlanked CableStyle Mass PWL_FEAT_DEFORM_AREA ComponentID PWL_FEAT_PROG_SUPPRESSED ColumnNumber PWL_LINEAR_DIM ChangeDirectory PLMSInitialize IsToleranceDisplayed ElbowLength EvalOutline InstAttachment PWL_FEAT_SAW NoteName ExportCurrentRasterImage OutputQuality CreatePart RunMacro SetLineStyle PWL_UNATTACHED_FEATS TolPlus GotProEWrite GetSheetFormat SelectSimpRep UKnots ListElements RelationId UseAutoId UseSolidScale TurnOffUDFRedefineMenu DimensionOption Params InsertSeq SetAction PWL_UNKNOWN_STYLE_DIM ParentView ChordHeight Contents Value PWL_INVALID_NAME NearestPoints PWL_FEAT_ACTIVE GetGeomRep UserInitializeReturn AccessExternalData UserDefinedData TextHeight IntValue PWL_FEAT_BEAM_SECTION ErrorString PenVelocityY PWL_FEAT_PIPE_LINE GetURL GetSheetUnits IsModified IsUnderlined CreateImportFeat AutoresolveOption Translate PWL_GENERAL_ERROR PWL_VALUE_STRING CheckIsModifiable PWL_VALUE_NOTEID PWL_BSPL_UNSUITABLE_DEGREE PWL_FEAT_SHAFT CriticalPoint1 IsVisible PWL_ASSEMBLY PWL_FEAT_DRV_TOOL_TWO_CNTR Device CollectWorkspaces Knots TextLineNumber AssemblyReference RemoveColumn UseTtf Import2DViews Import2DModel AssembleSkeletonByCopy MaterialName Attachments PWL_FEAT_SIMP_REP_SUPPRESSED IsGeometryRepSupported GetEnvironmentVariable InstanceNames PWL_FEAT_DRILL PWL_FAM_TYPE_UNUSED IsGroupMember DotsPerInch Invert SpecificHeat PWL_FEAT_FLATTEN AssignMassProperties PWL_ERROR_INVALID_SELSTRING NumLayers SetPropertyValue ApplicationType PWL_FEAT_PATH_SEGM PWL_LAYER_TYPE_DISPLAY GetActiveModel PWL_VALUE_DOUBLE PWL_FEAT_DECLARE AttachOnDefType ListSlots IsVerified PWL_FEAT_MFG_MERGE SmallSurfPercentage PWL_FEAT_PIPE ParentIDs Lightweight GetDefaultExplodedState Assem VisibilityLevel PWL_FEAT_INVALID End2 UIOpenFile FatigueMaterialFinish PWL_FEAT_MANUAL EvalArea PWL_FEAT_ROUND Harness AsWireframe PoissonRatio RemoveSelection NumSimpreps PWL_VALUE_BOOLEAN GetTransform Transform PWL_FEAT_CAV_SCAN_SET LoadProToolkitLegacyDll PWL_FEAT_XSEC PWL_FEAT_PROTRUSION ChildIDs XPos ListUDFDimensions GetFontByName CableName ComputeGlobalInterference DeleteAfter Emissivity Name PWL_FEAT_WALL ExtReferences Operation PWL_FEAT_EAR PWL_NOT_DISPLAYED PWL_MSG_USER_QUIT Repaint ConvertToBaseline PWL_FEAT_MAT_REMOVAL OrientByMethod SetConstraints TolMinus Vertical PWL_GRP_PATTERN_NONE SaveToFile PWL_APP_STARTUP_FAIL NumWindows ParamDoubleVal Constraints SplineSurfaceData PaperSizeY SymbolHeight PWL_FEAT_CORE PWL_FEAT_SPINAL_BEND ReferenceRep Descr1 RetrieveModelWithOpts PWL_FEAT_REMOVE_SURFS PWL_FEAT_FIRST_FEAT DeleteSimplifiedRep PWL_PATTERN_INVALID WindowId Attributes PWL_FAM_TOL_PLUSMINUS GetServerLocation StatusMessage PWL_EXTOBJ Rotate ActivateSimpRep ComputeInterference BooleanVal GetIsScaleUserdefined PrinterOption GetIsReference FitToLeftCorner PostRegenerationRelations CreateColumn NoteOwnerID MaxValue Radius PWL_CONTOUR PWL_PARAMVALUE_NOTEID SplinePointIndex PWL_FEAT_WELD_GROOVE UIGetCommand PWL_GROUP_INVALID IncludedEntities PWL_GROUP_MEMBER InitBendYFactor AskUserAboutReps PWL_ERROR_NOT_IN_SESSION Degree PWL_3DSECTION PWL_DRAFT_DATUM PWL_EMPTY DimConstraintType GetAliasFromAliasedUrl PWL_DIMENSION_STANDARD PWL_DISPLAY_TYPE_HIDDEN PWL_FEAT_MILL Texts Regenerate GetRestriction AdditionalSurfaces PageRangeChoice Items GetImmediateGenericInfo DimStyle ParamIntVal Close List2DViews UTangent MinCurvature UIReadIntMessage PWL_NO_ERROR PWL_FEAT_SUPPRESSED ExecuteFeatureOps IsTextAngleFixed GroupPattern PWL_FEAT_MEASURE PWL_LAYER_TYPE_BLANK PWL_FAM_TOL_MINUS NumParents V1Profile NavigatorPaneBrowserIconSet ExceptionDescription GetDriverType PWL_FEAT_OFFSET AllowContextSelection ListGroupMembers SaveMethod ItemAttachment LayerObjects PWL_DIMTOL_PARAM GetMaterial PWL_FEAT_WELDING_ROD CreateCompModelColumn PWL_DISPLAY_TYPE_DISPLAY PWL_PATTERN_LEADER IgnoreQuilts SetYAxis PWL_REGEN_AGAIN PWL_MSG_FMT_ERROR DimDisplayType Clip DefaultPath PWL_FEAT_RIP AsSolids PWL_FEAT_PLY PWL_SUPP_PARENTS PWL_FEAT_DATUM_SURF EvalUV OffsetValue PWL_FEAT_UDF_ZONE GetName PWL_FAM_SYSTEM_PARAM Mode DrawArc2D UIGetCurrentMouseStatus PWL_FEAT_PIPE_EXT OriginRef OrientationHint ImageDepth PWL_PATTERN_MEMBER ImportToCurrentWS ViewObjects PointA PVExportOptions PWL_ALL_PARAMS Action IsActive StressLimTension GroupLeader Leaders Orientations DimensionConstraints Group CopyFileToWS ChildFeatObjects ExpldstateNames RotatePlot PWL_INVALID_ITEM PWL_AXIS GetMasterRep GetGraphicsRep PWL_TOL_PLUS_MINUS_SYM RemoveRow PWL_UNAV_SEC LoadConfigFile ConvertToOrdinate Thickness RefreshModelTree TolType PWL_FEAT_ZONE PWL_OUT_OF_MEMORY PWL_FEAT_INTERSECT TParam GetModelFromDescr PWL_FEAT_SMT_CLAMP MaxChordHeight PWL_DWGCREATE_ERRORS String GetServerByAlias Weight WindowObjects PWL_EDGE ListFiles Version Surface2 PWL_GTOL_PARAM ErrorCode GetErrorCode NumMdls IsExtLocked PWL_CRE_VIEW_BAD_TYPE PWL_FEAT_HOLE Expression CharHeight VDegree PWL_IPAR_NOTE PWL_FEAT_DOME2 ShowWeldXSection GetFullName Activate SetSliceExportData CsysAxis DeleteRelations FilePath GetZAxis TransformValue PVFormat PWL_BND_TABLE InertiaTensor ExtendsInNegativeDirection CoordSysInertia PWL_TOL_DEFAULT ShowConceptModel AttachmentParam YoungModulus PWL_FEAT_DATUM_POINT Status UploadObjectsWithOptions PWL_FEAT_ATTACH_VOLUME PWL_FEAT_FLANGE Param NumCrossSections Symbol PWL_FEAT_UDF_WRK_REG PWL_FEAT_SLD_PIPE CreatedDrawing BaselineLifecycle BoolValue SelectedButton UpdateInstances ItemID SendToPrinter CreateView StressLimShear IsUnderconstrained PWL_FEAT_SMT_MFG_FORM NoteId Profile PWL_FEAT_DRV_TOOL_PROF RowHeights NormalRef ListColumns Sheets PWL_BAD_DIM_ATTACH Derivative1A Extents AddModel DimIDs PWL_FEAT_PROCESS_STEP PWL_FEAT_DRV_TOOL_SKETCH PWL_VIEW CopyFileFromWS PWL_PRM_ITEM SelectedIncludes IsMirrored CompIds MaxNumSels EvalParameter MessageDialogType Radius2 NoteIDs SelModel ComponentIds NumViews EvalFromLength PWL_FAM_ASMCOMP_MODEL CriticalPoint2 IntVal CreateLocalGroup CurrentMaterial Profile2 ReferenceItem PWL_UDF CoordSys TangentIndex PWL_ANGULAR_DIM CurrentGraphicsColor PWL_BAD_SRF_CRV DeletePostRegenerationRelations CompType GetSheetNumber PWL_DIM_PARAM DimensionDisplayMode GetServerByUrl Id GetSurfaceType LayerItemObjects Highlight LayerOptions RetrieveModel PWL_SNAP_LINE Draw ModelDefByTests FamilyTableColumnObjects EvalMaximum PWL_FEAT_ASSEM_CUT AuthenticateBrowser ThermalMaterialType DimRef PWL_FAMILY_TABLE OriginConstraints GroupPatternStatus PWL_FEAT_LOC_PUSH Plus PWL_DIAGRAM ItemTypes ConnectionId PenSlew CountUnsupportedItems RetrieveAssemSimpRep ColumnWidth GetXAxis ParallelRef DrawCircle PWL_FEAT_PIPE_JOINT PWL_FEAT_INACTIVE DependencyType PartRep TextValues IgnoreSmallSurfaces CheckIsSaveAllowed GetSurfaceDescriptor SimpRepObject PWL_MSG_NOT_FOUND PWL_FEAT_MFG_TRIM GetUnit PWL_FEAT_TURN ComputeVolume NewModel UDFDimensionName PWL_DISPLAY_TYPE_NORMAL GetModelFromFileName OffsetRef Branch SetCell Sheet IsBulkitem OrientationConstraints PWL_COMM_ERROR PWL_CURVE GetMassProperty PWL_FEAT_PIPE_PNT_PNT Red Elements ExportShrinkwrap ModelObject Derivative2B OutputModel IncludeFaceted SetName RetrieveGraphicsPartRep Unload FileName PWL_DRAW_TABLE HasUnsupportedItems PermittedSubTypes DevelopFunctionName CreateDrawingDimension PatternStatus RegenerateRelations PWL_LINE_TOO_LONG Distance AssemblyDatumSide WindowObject PWL_FEAT_PIPE_SET_START MessageType FunctionReturn BendTable GetPrintMdlOptions Method Create AddRow TextIndexNumber CreateUDFGroup DBParent IntegerValue Materials PWL_PARAMVALUE_DOUBLE PWL_FEAT_CURVE NumberOfColumns PWL_CANT_OPEN IncludeSecondaryContent CreateFeature PreselectedItem BaselineName SelItem GetXYZExtents PWL_EXEC_NOT_FOUND GraphicsAreaHeight OnSurfaceType FramesFile TurnOffFixModelUI PWL_FEAT_WELD_FILLET PlotterName DefAttachment PWL_FEAT_CONT_MAP SetPenPosition Sel2 SetURL CreateNote SetGroups AllowMultipleSelections GetMessageContents PWL_MARKUP PWL_FEAT_MFG_GATHER CurrentWindow GeomOutline IgnoreSkeleton PWL_FEAT_DRV_TOOL_CURVE PWL_SYMBOL_INSTANCE ResumeExcludedComponents Quantity Force GetType EraseWithDependencies PWL_E_NOT_FOUND HasElbow PWL_PART PWL_WELD_PARAMS SetWSExportOptions PWL_E_BUSY IsEmbedded GetSheetBackgroundView PWL_DIAGRAM_OBJECT PWL_FEAT_BEND_BACK Point ReferenceSolid DimConstraints SurfParam2 TopGenericName Derivative1 ModelOption PWL_DIAGRAM_WIRE IncludeInstances CreateTolMinusColumn GetSliceExportData PWL_FEAT_GEOM_COPY PWL_FEAT_RIB PWL_ABORT FontName Orientation NumParams CreateReplaceOp WasModelSaved EraseFromModel2D ListModelsByType PWL_FEAT_DATUM PWL_LAYOUT PWL_FEAT_PATCH DimensionObjects PWL_MSG_NO_TRANS NumberOfWarnings Readonly GetView RegisterServer ParamBooleanVal SelTableSegment GetPrintPlacementOptions Width PWL_SURFACE AssembleSkeleton WhichScale PWL_FEAT_ISEGM PWL_FAM_IPAR_NOTE DeleteSkeleton URL NumSelections SetTransform PWL_FEAT_THREAD EvalMinimum PWL_TOL_LIMITS Pattern NavigatorPaneBrowserAdd IncludeDatums RemoveProperty PWL_FAM_FEATURE PWL_FAM_TOL_PLUS Angle PWL_FEAT_CMM_CONSTR GetActiveSimpRep PenVelocityX CommonName ListFeaturesByType PWL_CSYS CleanupDependencies DrawLine PWL_FEAT_OPER_COMP PermittedFatigueMaterialFinishes GetByRelationId PWL_INVALID_TYPE Descr CurrentModel PWL_FEAT_OPERATION CheckinObjects PWL_NO_COORD_SYSTEM PWL_GRP_PATTERN_INVALID UserScale MembIdTab DimensionObject PWL_FEAT_CAV_FIT TextSlantAngle Vector2 Leader NoteText PWL_PARAMVALUE_INTEGER Surf ExportSheetOption GetImportSourceType GetColumn ItemType NumChildren AngleControl Format GetViewByName ConflictMessage FatigueMaterialType PermittedMaterialModels CreateSuppressOp PWL_FEAT_EXP_RATIO GetAttachmentPoints GetNURBSRepresentation IsInterfering Contexts Depth GetFeatureByName GetCurrentDirectory SetViewDisplaying PWL_FEAT_UNREGENERATED TangentType PWL_FEAT_IMPORT CurrentGraphicsMode GetDirection PWL_APP_COMM_FAILURE PWL_BSPL_NON_STD_END_KNOTS PWL_FEAT_PIPE_TRIM GetInstructions FeatureIds PWL_LAYER_TYPE_NORMAL UIPickMouseBox Descr2 MajorLength PWL_FEAT_UDF_THREAD SetCurrentSolid ReferenceSystem V0Profile VersionStamp ConversionFactor Matrix HardnessType Resolution UseExistingTools PWL_FEAT_SPRING_BACK PWL_FEAT_PIPE_JOIN Remove ShiftAllCorner ListDependencies TableColumn NumDims LoadProToolkitDll ParamType DeleteSheet ThroughRef Copy PWL_INVALID_PTR DimID PWL_GTOL CreateFeatureColumn ImportNewModel PWL_FAM_DIMENSION RetrieveGraphicsSimpRep GenericName ParentFeatObjects PWL_APP_XS_CALLBACKS GetProToolkitDll DynamicPositioning GetTolerance ReleaseLevel DatumReferences PermittedFatigueTypes ListMembers PWL_PARAMVALUE_BOOLEAN GetRasterType PWL_FEAT_ATTACH Zoom CenterProfile Select IsTemporary ToolkitFunctionName PWL_FEAT_DRV_TOOL_SURF PWL_BAD_INPUTS PWL_FEAT_DRV_TOOL_EDGE Slew ProfilePath OpenFile StringValue CreateMergePartColumn PWL_FEAT_ETCH PWL_CANT_MODIFY UDFName Import PWL_E_AMBIGUOUS Explode SegCharHeight PWL_FEAT_NECK CurrentTransform PWL_CANT_ACCESS WithParents PWL_FEAT_THICKEN PWL_BSPL_MULTI_INNER_KNOTS Maximum ImmediateGenericName GetPrincipalUnits NewSimpName Exploded PWL_FEAT_SMT_MFG_CUT SurfaceArea FamilyTableRowObjects GetIsVisible PWL_FEAT_MOLD PWL_FEAT_UDF_RMDT AddSelection PWL_FEAT_SHRINKAGE IsObjectModified PWL_FEAT_CHAMFER Class UserInitializeMessage OutputArguments ModelName FeatSubType ComponentFeatObjects CurrentFont PWL_SKETCH_ENTITY ListShownDimensions FeaturePatternObject ASCIIStringValue IgnoreParamUnits MaxLength MinDir GetOwner ListContours discr AttachedGeometry ItemPath PWL_DRAWING ImageWidth MakeSolid UIClearMessage AttachmentPoint FeatName PWL_GROUP Folder PWL_PATREL_FIRST_DIR ParamValueObject Insert U1Profile CsysName Radius1 PWL_FAM_ASMCOMP CenterOfGravity Normal FatigueType ModelObjects PWL_VALUE_INTEGER IsDesignated Edge1 BottomOffset PWL_INVALID_FILE PWL_DIMENSION PrincipalMoments AssembleComponent ComputeClearance FeatureObjects Inertia GetFileName PWL_PATTERN_PARAM AllowFixUI CrossHatchFile PWL_USER_ABORT Bezier DisplayType RegenerateSheet Locked SetZAxis PWL_FEAT_POSITION_FOLD ExplodeStatus IsStandard ObjectName PWL_FEAT_FAMTAB_SUPPRESSED GotProERead DirectoryPath SetScaledValue Points ThermExpCoef PatternLeader CreateCustomUnit Lines Display PWL_DIM_TOL_SYM_SUPERSCRIPT ShowModifyNCSeqMenu InstanceName ListParents UISelectDirectory GetRGBFromStdColor PWL_FEAT_EXPLODE_LINE PWL_FEATURE PWL_EDGE_START Options DimName EvalLength NumComponents PWL_FEAT_AREA_NIBBLE PWL_GRP_PATTERN_LEADER GetCurveDescriptor PWL_FEAT_LOCATION UISaveFile WindowIDs PWL_FEAT_BULK_OBJECT SectionIndex ClipPlot Location IsUDFGroup SubType MaxCurvature Delete EraseUndisplayedModels ExportFromCurrentWS ComponentReference GetCellIsDefault ListFailedFeatures StructDampCoef CenterGravityInertiaTensor StartJLinkApplication Alpha SurfParam1 PWL_APP_VERSION_MISMATCH PWL_MSG_TOO_LONG MaterialObjects CreateSlot PWL_NO_ACCESS PWL_FEAT_SHRINK_DIM PWL_FEAT_RIBBON_PATH AssembleByCopy DimValue ComponentPath TextWidthFactor Geometry PWL_EXPLD_STATE Sel1 UploadObjects NoteURL SizeType NumTextLines PWL_REFDIM_PARAM MassDensity NumFiles StringVal Segmented UnExplode ShortcutPath PWL_FEAT_WATER_LINE UnHighlight SelTableCell RotationAngle GetSheetData Modify Intersections Color SetPropertyUnits PWL_APP_INIT_FAIL ListDeclaredModels ExportDirectVRML PWL_FEAT_REPLACE_SURF Position GetModelNameFromAliasedUrl ThermConductivity RefItem PWL_NO_LICENSE PWL_FEAT_SETUP PWL_INVALID_SELSTRING EvaluateExpression OptionKeywords SubstituteData DefaultFolder SubstPath PWL_FEAT_FREE_FORM ValueType ExportType ComponentIDs PWL_FEAT_DATUM_AXIS FullName Style PWL_NOT_IN_SESSION Origin PWL_COMP_CRV PermittedFailureCriteria PWL_FEAT_GROOVE UpperLimit AfterFeat TangentRef ExistSimpName GetBaselineDimension ModelSpaceSheet PWL_FEAT_SOLIDIFY CreateMaterial GroupName GetModelWindow Tangent GetLineEnvelope EvalLengthBetween JoinSurfs FamItemTypes FeatType ShearModulus Rotation PWL_DWGFORM AutoHoleFilling X2ClipPosition Y1ClipPosition Clear View EvalParameters ValueObject PWL_NOT_VALID EvalClosestPoint InternalTraversal GetId SymbolDef PWL_PARAMETER PointType CreateUnitSystem SetSheetScale Derivative1B ItemName ModelDescr GetSheetScale UVDerivatives PWL_FEAT_DRAFT CreateModelWindow DeleteModel ScaledHeight FeatTypeName DoubleVal AddColumn SetXAxis PWL_FEAT_PIPE_BRANCH PWL_FEAT_SET PatternParam GetFeatureById PWL_FEAT_FORM CreateLayer IsLocked LowerLimit GetSheetTransform FeatureID IsAutoRoundMember UIGetNextMousePick DimType GotDiskWrite Scale PWL_FEAT_UDF_CLAMP EndAngle DrawFormat SegmentedOutput TextLocation RelativeAccuracy UnitName CreateParamColumn PWL_FEAT_LINE_STOCK Density ExecuteFunction UpdateAssemblyOnly ActiveWorkspace FullPath ConstraintRef Count CogInertiaTensor Root IsFrozen OpFeature GetScaledValue PWL_FEAT_SILH_TRIM PermittedValues PWL_FAM_UDF End1 GetExtension PWL_CRV_END UVDerivative PWL_FEAT_GRAPH PWL_FEAT_UDF_PUNCH SheetSize ListCrossSections Leaf InputFile PWL_DIAMETRICAL_DIM SideOffset YPos LabelPlot PrincipalAxes GetText GetLayerDisplayStatus Export MdlType PenTable IsDisplayed IsRelationDriven VariantValues PWL_OBSOLETE_FUNC NumInstances RibbonDefinitionfileLoad AsSurfaces IsBackground ScaleToFit Surface1 Minus ListSubdirectories Height PWL_FEAT_SMT_MFG_PUNCH PWL_FEAT_SMT_PUNCH_PNT PWL_SIMP_REP PWL_FEAT_RIBBON_SEGM SetSheetFormat Relations SwitchView PWL_FEAT_TWIST IsFirst ListSubItems ConfigDir PWL_FEAT_INT_UDF GetFontById PaperSize BaselineLocation FirstPage GotDiskRead PWL_QUILT ReplaceModel RetrievePartSimpRep XYZExtents ListServers PWL_E_DEADLOCK ParentDefinition ViewModel PWL_MODEL PWL_FEAT_DOME KeepEmbeddedDatums GroupPatternObject ShouldFlip PWL_ENT_TEXT StartAngle Succeeded PWL_FEAT_VDA AllowGroupMembers Prompt GraphicsAreaWidth PWL_FEAT_UDF_NOTCH ArgumentName Item PWL_DIMENSION_REFERENCE StepSize Text ScaleType TolTableType PWL_CRV_START PWL_TOL_PLUS_MINUS OptionType SetLayerDisplayStatus AllowDuplicateModelItems SheetNumber GetPropertyValue GetDimensionSenses GetWindow GetOrigin ListGroups PWL_INVALID_MATRIX ListSimplifiedReps ReferenceUnit OId Condition ImageHeight ForceRegen FeatureName PWL_DISPLAY_TYPE_BLANK PWL_LAYER_TYPE_HIDDEN OrientMoveValue CreateGroupColumn GetConfigOptionValues CornerPoints RemoveItem RedefineThroughUI Backup Justification AsQuilts PWL_2DSECTION UIReadRealMessage IsExploded DefaultAction FeatureType Errors RefParam OrientMoveConstraintType AngleOptions Configuration UIDisplayFeatureParams ExportRasterImage CreateResumeOp PWL_FEAT_SRF_MDL SetStdColorFromRGB PointB DefaultFont CreateWorkspace PWL_FEAT_SMT_POPULATE PWL_REPORT FromFeat CheckoutMultipleObjects CoordSysInertiaTensor FailureCriterion PWL_LAYER DeleteWorkspace DimOffset NumExpldstates ExecuteModelCheck CurveCount SelectionObject PWL_FEAT_SPLIT_SURF PWL_FEAT_CAV_DEVIATION IsValid GetCurrentWS PWL_FEAT_TORUS GetSubstType PWL_FEAT_SHELL PWL_GROUP_NONE Shortcuts GetRow ListContexts PWL_CRE_VIEW_BAD_MODEL NavigatorPaneBrowserURLSet Simprep PWL_DISPLAY_TYPE_NONE Center SetPrincipalUnits ViewNames NumNotes AngleValue UIDisplayMessage SelectionValue PWL_CHECKOUT_CONFLICT PWL_FEAT_CORN_CHAMF GetPoints Tolerance PWL_FEAT_CUT ListModels Units WindowID ResetFromBackup ParameterObjects GetOrientationHint Message GetCurrentSolid WorkspaceContext Blue FilterString ConflictDescription CharWidth PWL_RADIAL_DIM PWL_FEAT_CMM_VERIFY GetUrlFromAliasedUrl ComponentDatumSide UnitNormal SimpRepObjects ViewName PWL_CANT_WRITE PWL_FEAT_CHANNEL IsReadOnly PWL_E_IN_USE PWL_CRE_VIEW_BAD_SHEET Vector1 PWL_PATTERN_NONE ShowInBrowser ParamNames Ignore TriangulationOptions Boundaries GroupStatus LayerSetupFile PWL_APP_UNLOCK PWL_FEAT_CUT_SMT RegeneratePostRegenerationRelations SetOrigin X1ClipPosition PWL_FEAT_MERGE KeepPanzoom FeatureGroupObject IsReadonly VerifyUV PlacementOption GroupPatternLeader PWL_FEAT_DRAFT_LINE PWL_DATUM_PLANE MaterialModel Senses PWL_FEAT_EDGE_BEND EvalDiameter NumberOfErrors SelectionObjects CheckoutObjects PWL_REF_DIMENSION PWL_FEAT_SMT_OPTIMIZE PWL_FEAT_WORKCELL AngleRef Path PWL_FEAT_SMT_ZONE ExternalReferenceModel NumSubdirs TaskId FacetControlOptions PWL_FEAT_CABLE Type Reorder TopModel TextString GetActiveServer NumberOfSheets Simpreps PWL_FEAT_CMM_MEASSTEP Y2ClipPosition RetrieveMaterial ExtendSRF FeatId AsmRep TextAngle PWL_NO_CHANGE IsNormalToScreen PWL_TYPE_UNUSED AbsoluteAccuracy PWL_FEAT_FLAT_RIBBON_SEGM PWL_FAM_GTOL SeparatePlotFiles GetConstraints Outline LastPage SetConfigOption Dependency NonDefaultFolderAssignments Model CreateDimensionColumn GetModel IsTableDriven PWL_CONTINUE ListRows EvalClosestPointOnSurface NumberOfRows GetModelReference PWL_FEAT_BLD_PATH OwnerQuilt PWL_FEAT_PIPE_FOLL PWL_FEAT_COSMETIC CurrentSheetNumber WidthFactor PWL_FEAT_SUBHARNESS IsObjectCheckedOut Quadrants ShowUDFEditMenu SetTolerance PWL_DATUM_TEXT PWL_DRAFT_GROUP BaselineNumber PWL_FEAT_COMPONENT UseDrawingSize SelView2D PWL_POINT CreateDrawingFromTemplate PWL_FEAT_WELD_PLUG_SLOT Context ListUnits OptionValue SetTextColor GetPrintPrinterOptions MaterialObject CrossSectionNames GetSheetFormatDescr SwHandshake TangentProfile PWL_FAM_EXTERNAL_REFERENCE CreateComponentColumn OffsetType UnitMajorAxis PWL_SURFFIN_PARAM VTangent NumMaterials SubdirNames PWL_SUB_ASSEMBLY DeleteSimpRep PWL_FEAT_RIBBON_SOLID SetBrowserSize OutputDir PWL_RELSET PWL_CRE_VIEW_BAD_PARENT PWL_FEAT_FEAT_UDF Exists PWL_FEAT_LIP Label IsViewdisplayLayerDependent IsCommonNameModifiable BeforeFeat MethodName 
    </text> 
    :> replace(/\/\/.*\n/g,"") ( 去除註釋 ) trim :> split(/\s+/) ( 精純 keys array )
    constant wlkeys // ( -- array ) All keys of Web.Link objects

    : >js ( objWL -- objJS ) \ Convert web.link object into javascript object 
        <js>
        o = {};
        vm.v("wlkeys").forEach(function(key){
            try { 
                o[key] = tos()[key]; 
            } catch(e){} // 不懂，但是這空 block of catch(e){} 不能省
        }) 
        pop(); push(o);
        </js> ; 


\ Root objects 

    \ 讀 web.link global root object
    char MpfcCOMGlobal pfcCreate constant wlg // ( -- obj ) web.link global root 

    \ Get session object
    wlg :> GetProESession() constant pfc  // ( -- obj ) A Creo Parametric session. The PFC root.
    last alias session

    \ Get script object
    wlg :> GetScript() constant pwl // ( -- obj ) Old-style PWL script root. Now use PFC session instead.

    \ Web.link constant 
    pwl :> GetPWLConstants() constant wlc // ( -- obj ) Web.link constants 
        /// e.g. wlc :> PWL_LINEAR_DIM
        /// constants list file:///D:/PTC/Creo%202.0/Common%20Files/M230/weblink/weblinkdoc/manual0/loadApiWizard.html

    \ Web.link feature constant 
    pwl :> GetPWLFeatureConstants() constant wlf // ( -- obj ) Web.link feature constants
        /// e.g. wlf :> PWL_FEAT_WATER_LINE
        /// constants list file:///D:/PTC/Creo%202.0/Common%20Files/M230/weblink/weblinkdoc/manual0/loadApiWizard.html

        <selftest>
        cls
        *** wlg root, pfc session, pwl script, wlc constants, wlf feature constants 
            ( Object Chain demo ) s' (new ActiveXObject("pfc.MpfcCOMGlobal"))' </jsV> :> GetScript() :> GetPWLConstants() :> PWL_LINEAR_DIM ( 9 )
            ( Creo Parametric build code ) wlg :> GetProEBuildCode() -->
            ( Creo Parametric version ) wlg :> GetProEVersion() --> 
            ( Command line arguments ) wlg :> GetProEArguments() seq -->
            char MpfcArgument pfcCreate js> typeof(pop()) char object = dup --> ( true ) 
            char MpfcAssembly pfcCreate js> typeof(pop()) char object = dup --> ( true ) 
            char MpfcExternal pfcCreate js> typeof(pop()) char object = dup --> ( true ) 
            char MpfcModelItem pfcCreate js> typeof(pop()) char object = dup --> ( true ) 
            char MpfcSelect pfcCreate js> typeof(pop()) char object = dup --> ( true ) 
            char MpfcInterference pfcCreate js> typeof(pop()) char object = dup --> ( true ) 
            pfc :> ConnectionId -->
            pfc :> CurrentModel -->
            pfc :> CurrentWindow -->
            pfc :> DimensionDisplayMode -->         
            wlc :> PWL_LINEAR_DIM ( 9 )
            wlf :> PWL_FEAT_WATER_LINE ( 1086 )
            pfc :> GetEnvironmentVariable('PRO_COMM_MSG_EXE') :> indexOf('pro_comm_msg')!=-1
            [d 9, true, true, true, true, true, true, 9, 1086, true d] [p "pfcCreate", "wlg","wlc","wlf","pfc","pwl" p]

        *** session.GetChild(window) and window are same thing
            \ different objects actually same thing 
            pfc :> CurrentWindow :> OId dup ( woid woid )
            pfc :> GetChild(pop()) :> OId ( woid coid )
            >js js> JSON.stringify(pop()) ( pfc child oid json )
            swap >js js> JSON.stringify(pop()) ( window oid json )
            ( the two are same ) = ( true )
            [d true d]
             
        *** window.DBParent and pfc session are same thing
            \ different objects actually same thing 
            pfc :> CurrentWindow :> DBParent :> OId ( oid of pfc from child )
            pfc :> OId ( oid of pfc from itself )
            >js js> JSON.stringify(pop()) ( json from itself )
            swap 
            >js js> JSON.stringify(pop()) ( json from child )
            ( the two are same ) = ( true )
            [d true d]
        </selftest>

    \ Enumerations
    
    : (enum) ( "enum" "key" -- value ) \ Get enumeration value 
        swap pfcCreate :> [pop()] ;
        /// char pfcArgValueType char ARG_V_STRING (enum) --> \ 4
        
    : enum ( <enum> <key> -- value ) \ Get enumeration value 
        BL word BL word ( enum key ) swap pfcCreate :> [pop()] ;
        /// enum pfcArgValueType ARG_V_STRING --> \ 4
        
        <selftest>
            *** Enumerations
            char pfcStdColor pfcCreate :> COLOR_LETTER dup --> ( 0 )
            char pfcArgValueType pfcCreate :> ARG_V_STRING dup --> ( 4 )
            char pfcAssemblyConfiguration pfcCreate :> EXPORT_ASM_ASSEMBLY_PARTS dup --> ( 3 )
            [d 0,4,3 d] [p p]
        </selftest>


\ Read environment variables

    : (env) ( "envName" -- pfcEnvVariableGetReturn ) \ Get environment variable 
            pwl :> pwlEnvVariableGet(pop()) ; 
            /// 由 pfc.GetEnvironmentVariable() 也可以讀 env. 
            /// 盡量用 session, see pfcBaseSession
            /// 參：https://community.ptc.com/t5/Customization/CREOSON-What-s-the-hidden-purpose-that-I-don-t-understand/m-p/654491
    : env   ( <env> -- ) \ Print environment variable value
            BL word (env) :> value . cr ;
            ' (env) :> comment last :: comment=pop()

        <selftest>
            *** (env) env
            \ print all pfc related environment variables
            <text> MAN_CHM_INDEX MAN_HTM_PATHS MAN_TXT_INDEX NUTCROOT Path 
            PRO_COMM_MSG_EXE PRO_LANG PTCNMSPORT ROOTDIR TERMCAP TERMINFO</text> 
            :> split(/\s+/) count [for] dup :> pop() dup . ." :" cr (env) 
            :> value . cr cr [next] drop    
            char PRO_COMM_MSG_EXE (env) :> value.indexOf('pro_comm_msg')!=-1
            [d true d] [p "(env)","env" p]
        </selftest>

\ Access disk directory 

    : .dir  ( subdir? pfcDirectoryFilesGetReturn -- ) \ Print pfcDirectoryFilesGet results 
            >r if else <js> for (var i=0; i<rtos().numsubdirs; i++) type('[' + rtos().subdirnames.item(i) + ']\n');</js> then
            <js> for (var i=0; i<rtos().numfiles; i++) type(rtos().filenames.item(i) + '\n');</js> r> drop ;
    : (dir) ( "path" wildcard -- pfcDirectoryFilesGetReturn ) \ Do pfcDirectoryFilesGet
            pwl :> pwlDirectoryFilesGet(pop(1),pop()) ;
    : dir   ( <wildcard> <path> -- ) \ List directory
            BL word ( wildcard ) BL word over ( wildcard path wildcard ) (dir) .dir ;
    : (cd)  ( path -- currentDirectory ) \ Get "current directory" or "change directory" if w/path 
            ?dup if 
                pwl :: pwlDirectoryCurrentSet(pop())
            else 
                pwl :> pwlDirectoryCurrentGet().DirectoryPath 
            then ;
    : cd    ( <path> -- ) \ Print "current directory" or "change directory" if w/path 
            CR word ( path ) ?dup if (cd) else null (cd) . cr then ; 

\ Model Management
\ 本區裡的 words 是開始學習 Web.Link 時的習作，寫好就留下來了。
\ 後來有了 >js 就直接在 OneNote Work2020 上寫筆記，不再都做成 words.   

    : MdlCurrentGet ( -- pfcMdlCurrentGetReturn ) \ pwlMdlCurrentGet Retrieves the current model in session
        pwl :> pwlMdlCurrentGet() ;  
        /// 如果明明有 model, 卻傳回 null 就是沒有 activate.

        <selftest>
            *** MdlCurrentGet get current model 
            MdlCurrentGet :> ErrorCode js> typeof(pop()) ( number )
            MdlCurrentGet :> Status js> typeof(pop()) ( boolean )
            [d "number","boolean" d] [p "MdlCurrentGet" p]
        </selftest>

    : SessionMdlsGet ( MdlType -- pfcSessionMdlsGetReturn ) \ Lists the models of the specified type in the current Creo Parametric session.
        pwl :> pwlSessionMdlsGet(pop()) ; 
        /// Possible model types: wlc :> PWL_ASSEMBLY,PWL_PART,PWL_DRAWING,PWL_2DSECTION,PWL_LAYOUT,PWL_DWGFORM,PWL_MFG,PWL_REPORT,PWL_MARKUP,PWL_DIAGRAM
        /// wlc :> PWL_PART SessionMdlsGet >js (see)
        /// wlc :> PWL_PART SessionMdlsGet >js :> MdlNameExt seq -->
        
        <selftest>
            *** pwlSessionMdlsGet get model 
            MdlCurrentGet :> ErrorCode js> typeof(pop()) ( number )
            MdlCurrentGet :> Status js> typeof(pop()) ( boolean )
            [d "number","boolean" d] [p "MdlCurrentGet" p]
        </selftest>

    : MdlDependenciesGet ( "prt0005.prt" -- pfcMdlDependenciesGetReturn ) \ Retrieves all the top-level dependent models in the specified model
        pwl :> pwlMdlDependenciesGet(pop()) ; 

        <selftest>
            *** MdlDependenciesGet
            char dummy.prt MdlDependenciesGet :> NumMdls js> typeof(pop()) ( number )
            char dummy.prt MdlDependenciesGet :> MdlNameExt js> typeof(pop()) ( object )
            [d "number","object" d] [p "MdlDependenciesGet" p]
        </selftest>

        
    : MdlInfoGet ( "prt0005.prt" -- pfcMdlInfoGetReturn ) \ Retrieves information about the specified model
        pwl :> pwlMdlInfoGet(pop()) ; 
        
        <selftest>
            *** MdlInfoGet
            char dummy.prt MdlInfoGet :> TopGenericName js> typeof(pop()) ( string )
            char dummy.prt MdlInfoGet :> MdlType js> typeof(pop()) ( number )
            [d "string","number" d] [p "MdlInfoGet" p]
        </selftest>

    : MdlRegenerate ( "prt0005.prt" -- pfcStandardReturn ) \ Do a regenerate to an opened model (.prt .drw .asm .frm .. etc)
                    pwl :> pwlMdlRegenerate(pop()) ;

\ File Management Operations

    : MdlOpen ( "prt0005.prt" "c:/Users/Bill/Documents/Creo2" DisplayInWindow? -- pfcMdlOpenReturn ) \ open a model (.prt .drw .asm .frm .. etc)
        pwl :> pwlMdlOpen(pop(2),pop(1),pop()) ;    
        /// pwlMdlOpen

\ 常用命令

    : list-mdls ( -- ) \ List opened models in memory
        wlc :> PWL_PART SessionMdlsGet :> MdlNameExt seq . cr ;
        /// Click [close] 把它關掉，結果還是會出現。要 erase 才會消失。
        /// SessionMdlsGet

    : list-windows ( -- ) \ List opened windows
        pwl :> pwlSessionWindowsGet() :> WindowIDs seq . cr ;
        /// pwlSessionWindowsGet

    : erase-mdl ( "par0001.prt" -- ) \ Remove the opened model from memory
        pwl :> pwlMdlErase(pop()) >js (see) ;
        /// pwlMdlErase
        
    : see-current-mdl ( -- ) \ See the current model 
        pfc :> CurrentWindow :> Model ?dup if \ 繞過 current window 取得 current model 
            ." Model Properties:" cr 
            dup ( model ) >js (see)
            ." Model Info:" cr 
            :> FileName pwl :> pwlMdlInfoGet(pop()) >js (see) 
        then ;
        /// MdlCurrentGet :> ModelObject >js (see) 雖然也可以，但是要先 Activate 該 window 否則為 null.
        /// pfc :> CurrentWindow :> Model
        
    : see-current-window ( -- ) \ See the current window
        pfc :> CurrentWindow >js (see) ;

    : activate-current-window ( -- ) \ Activate current window
        pfc :> CurrentWindow.OId.Id pwl :> pwlWindowActivate(pop()) >js (see) ;
        /// Creo 同時可開好幾個 window 看哪個要 activated.
        /// pwlWindowActivate

    : open-barrel ( -- mdl-object ) \ open the example
        s" barrel.asm" 
        s" c:\Users\8304018\Documents\Creo2\training Gary Wei\toolkit_training\model" 
        true MdlOpen ; 


    </textarea>
    </div><hr><!-- outputbox --> 
    <textarea id="inputbox" cols=100 rows=4></textarea><a id=jump2endofinputbox href="#endofinputbox"></a><div id=endofinputbox></div>
    </div><!--console3we-->
</body>
</html>

<!--
[X] 2020/03/24 14:53:54 剛發現亂敲不會報錯: sdfsdf ==> Error! sdfsdf unknown.    
    ==> 少 copy 一行，補上就好了。這行有點 tricky 放心照抄就對了。
        var panic = vm.panic = function(state){vm.type(state.msg);if(state.serious)debugger;}

-->


